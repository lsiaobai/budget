<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告預算核對雙簽表格 (Google 登入 & 權限控管)</title>
    <!-- 載入 Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體以模擬現代、專業的設計感 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* 輕微的背景色 */
        }
        /* 定義表格的特定樣式 */
        .checklist-table th, .checklist-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist-table th {
            background-color: #eef2ff; /* 淺藍色背景，模擬 Canva 的配色 */
            color: #312e81; /* 深藍色文字 */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .checklist-table tr:hover {
            background-color: #f7fafc;
        }
        /* 針對日期欄位設置固定寬度以保持整齊 */
        .date-col {
            width: 150px; 
        }
        /* 確保按鈕有足夠的觸控面積 */
        .action-button {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: transform 0.1s ease-in-out, background-color 0.1s;
        }
        .action-button:hover {
            transform: translateY(-1px);
        }
        .action-button:active {
            transform: translateY(0);
        }
        /* 彈出視窗樣式 */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
            padding-top: 50px;
        }
        .modal-content {
            background-color: #fff;
            margin: 5% auto; 
            padding: 20px;
            border-radius: 12px;
            width: 90%; 
            max-width: 800px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* 響應式佈局 */
        @media (min-width: 640px) {
            .checklist-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy, where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // 應用程式初始化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // -------------------------------------------------------------
        // 全域狀態管理 (Global State Management)
        // -------------------------------------------------------------
        let currentUser = null; // 當前登入用戶的 Firebase User 對象
        let userRole = 'guest'; // 用戶角色: guest, user, admin
        let isAuthReady = false; // 驗證狀態是否準備就緒
        let checklistData = []; // 歷史紀錄資料
        const defaultAdminEmail = 'lsiaobai@gmail.com'; // 預設管理員 Email

        // 簡化路徑 (Simplified Paths to match the new Firestore Rules)
        // 移除 'artifacts', appId 部分，使用 Project-Level 的共用路徑
        const BUDGET_CHECKLIST_COLLECTION = 'public/data/budget_checklists';
        const USER_ROLES_COLLECTION = 'public/data/user_roles';

        // -------------------------------------------------------------
        // 驗證與用戶狀態 (Authentication & User Status)
        // -------------------------------------------------------------

        /**
         * 檢查用戶角色並更新全域狀態
         * @param {string} uid 用戶 UID
         * @param {string} email 用戶 Email
         */
        async function checkUserRole(uid, email) {
            if (!uid) {
                userRole = 'guest';
                return;
            }

            try {
                // 1. 檢查是否為硬編碼的預設管理員
                if (email && email.toLowerCase() === defaultAdminEmail.toLowerCase()) {
                    userRole = 'admin';
                }

                // 2. 檢查 Firestore 中的 user_roles 記錄
                const roleDocRef = doc(db, USER_ROLES_COLLECTION, uid);
                const roleSnapshot = await new Promise((resolve) => onSnapshot(roleDocRef, resolve));

                if (roleSnapshot.exists()) {
                    const roleData = roleSnapshot.data();
                    if (roleData.role === 'admin') {
                        userRole = 'admin';
                    } else if (roleData.role === 'user') {
                        userRole = 'user';
                    }
                } else {
                    // 如果用戶角色文檔不存在，則新增一個預設為 'user' 的文檔
                    // 但如果是預設管理員，則新增 'admin' 文檔
                    const newRole = (userRole === 'admin') ? 'admin' : 'user';
                    await setDoc(roleDocRef, { 
                        role: newRole, 
                        email: email || 'N/A', 
                        uid: uid,
                        createdAt: new Date()
                    }, { merge: true });
                    userRole = newRole;
                }

                // 3. 更新最後登入時間 (Last Login)
                await setDoc(roleDocRef, { lastLogin: new Date() }, { merge: true });

            } catch (error) {
                console.error("檢查/設定用戶角色失敗:", error);
                document.getElementById('admin-error').textContent = `載入用戶列表失敗: ${error.message}`;
                userRole = 'user'; // 預設為一般用戶以確保基本功能可用
            }
        }

        /**
         * 處理 Firebase 驗證狀態變更
         */
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                const userEmail = user.email || 'N/A';
                document.getElementById('auth-status').innerHTML = `<span class="font-bold">${userEmail}</span> (${userRole === 'admin' ? '管理員' : '一般用戶'})`;
                document.getElementById('login-button').classList.add('hidden');
                document.getElementById('logout-button').classList.remove('hidden');
                document.getElementById('admin-button').classList.add('hidden'); // 先隱藏

                await checkUserRole(user.uid, userEmail);

                // 重新渲染UI以應用新的角色
                renderUI(); 
                
                // 載入歷史紀錄 (確保在角色檢查之後執行)
                if (isAuthReady) {
                    loadChecklists(); 
                }

            } else {
                currentUser = null;
                userRole = 'guest';
                document.getElementById('auth-status').textContent = '請登入';
                document.getElementById('login-button').classList.remove('hidden');
                document.getElementById('logout-button').classList.add('hidden');
                document.getElementById('admin-button').classList.add('hidden');
                document.getElementById('checklist-history').innerHTML = `<p class="text-center text-gray-500 py-10">請先登入以查看共享歷史記錄。</p>`;
            }
            isAuthReady = true;
        });

        /**
         * 觸發 Google 登入
         */
        window.signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google 登入失敗:", error);
                document.getElementById('auth-error').textContent = `Google 登入失敗: Firebase: Error (${error.code || error.message}). 請確認 Firebase Authorized domains 設定是否正確。`;
                document.getElementById('auth-error').classList.remove('hidden');
            }
        };

        /**
         * 登出
         */
        window.signOutUser = () => {
            signOut(auth);
            document.getElementById('auth-error').classList.add('hidden');
            userRole = 'guest';
            renderUI();
        };

        // -------------------------------------------------------------
        // 資料庫操作 (Database Operations)
        // -------------------------------------------------------------

        /**
         * 監聽並載入歷史紀錄
         */
        function loadChecklists() {
            if (!currentUser) return;

            const checklistRef = collection(db, BUDGET_CHECKLIST_COLLECTION);
            const q = query(checklistRef, orderBy("date", "desc"));

            onSnapshot(q, (snapshot) => {
                checklistData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // 將 Firestore Timestamp 轉換為可讀的日期格式
                    const executionTimestampDisplay = data.executionTimestamp ? new Date(data.executionTimestamp.toDate()).toLocaleString() : 'N/A';
                    const reviewTimestampDisplay = data.reviewTimestamp ? new Date(data.reviewTimestamp.toDate()).toLocaleString() : 'N/A';
                    
                    return {
                        id: doc.id,
                        ...data,
                        executionTimestampDisplay,
                        reviewTimestampDisplay
                    };
                });
                renderChecklistHistory(checklistData);
                document.getElementById('history-error').classList.add('hidden');
            }, (error) => {
                console.error("載入歷史記錄失敗:", error);
                document.getElementById('history-error').textContent = `❌ 載入歷史記錄失敗: ${error.message}。請檢查 Firestore 規則是否允許讀取。`;
                document.getElementById('history-error').classList.remove('hidden');
            });
        }

        /**
         * 儲存或更新核對記錄
         * @param {Object} formData 表單資料
         * @param {string|null} docId 文件ID，如果為null則新增
         */
        async function saveChecklist(formData, docId = null) {
            if (!currentUser) {
                alert('請先登入以執行操作。');
                return;
            }

            try {
                // 移除空的檢核時間戳記，避免儲存為 null
                if (!formData.reviewTimestamp) delete formData.reviewTimestamp;
                if (!formData.executionTimestamp) delete formData.executionTimestamp;
                
                if (docId) {
                    // 更新現有文件
                    const docRef = doc(db, BUDGET_CHECKLIST_COLLECTION, docId);
                    await updateDoc(docRef, formData);
                    console.log('文件更新成功:', docId);
                } else {
                    // 新增文件
                    const newDocRef = collection(db, BUDGET_CHECKLIST_COLLECTION);
                    const docToSave = {
                        ...formData,
                        createdByUserId: currentUser.uid,
                        creatorEmail: currentUser.email,
                        reviewTimestamp: null // 新增時檢核時間為空
                    };
                    await addDoc(newDocRef, docToSave);
                    console.log('文件新增成功');
                }
                
                document.getElementById('save-success').classList.remove('hidden');
                document.getElementById('save-error').classList.add('hidden');
                setTimeout(() => document.getElementById('save-success').classList.add('hidden'), 3000);

            } catch (error) {
                console.error("儲存失敗:", error);
                document.getElementById('save-error').textContent = `❌ 儲存失敗: ${error.message}`;
                document.getElementById('save-error').classList.remove('hidden');
                setTimeout(() => document.getElementById('save-error').classList.add('hidden'), 5000);
            }
        }

        /**
         * 刪除核對記錄 (僅限管理員)
         * @param {string} docId 文件ID
         */
        window.deleteChecklist = async (docId) => {
            if (userRole !== 'admin') {
                alert('只有管理員可以刪除記錄。');
                return;
            }
            
            // 使用自定義的確認視窗 (避免使用 window.confirm)
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            document.getElementById('confirmDeleteText').textContent = '確定要永久刪除此筆記錄嗎？';
            confirmDeleteModal.style.display = 'block';

            document.getElementById('confirmDeleteBtn').onclick = async () => {
                confirmDeleteModal.style.display = 'none';
                try {
                    const docRef = doc(db, BUDGET_CHECKLIST_COLLECTION, docId);
                    await deleteDoc(docRef);
                    // onSnapshot 會自動更新 UI
                    console.log('文件刪除成功:', docId);
                } catch (error) {
                    console.error("刪除失敗:", error);
                    alert(`刪除失敗: ${error.message}`);
                }
            };

            document.getElementById('cancelDeleteBtn').onclick = () => {
                confirmDeleteModal.style.display = 'none';
            };
        };

        // -------------------------------------------------------------
        // UI 渲染與互動 (UI Rendering & Interaction)
        // -------------------------------------------------------------
        
        /**
         * 渲染UI元素，例如管理員按鈕
         */
        function renderUI() {
            // 更新用戶狀態顯示
            const userEmail = currentUser ? currentUser.email || 'N/A' : 'N/A';
            const statusText = currentUser ? `<span class="font-bold">${userEmail}</span> (${userRole === 'admin' ? '管理員' : '一般用戶'})` : '請登入';
            document.getElementById('auth-status').innerHTML = statusText;

            // 顯示/隱藏管理員按鈕
            const adminButton = document.getElementById('admin-button');
            if (userRole === 'admin') {
                adminButton.classList.remove('hidden');
            } else {
                adminButton.classList.add('hidden');
            }
        }
        
        /**
         * 將歷史紀錄渲染到表格中
         * @param {Array<Object>} data 歷史紀錄陣列
         */
        function renderChecklistHistory(data) {
            const historyTableBody = document.getElementById('history-table-body');
            historyTableBody.innerHTML = '';
            
            if (data.length === 0) {
                document.getElementById('checklist-history').innerHTML = `<p class="text-center text-gray-500 py-10">尚無歷史記錄。</p>`;
                return;
            }

            data.forEach(item => {
                const isCreator = currentUser && item.createdByUserId === currentUser.uid;
                
                // 決定操作按鈕
                let actionButton;
                if (isCreator) {
                    // 建立者：只有「修改」權限 (只能修改左側)
                    actionButton = `
                        <button onclick="window.openEditModal('${item.id}', 'executor')" 
                                class="action-button bg-blue-500 hover:bg-blue-600 text-white shadow-md">
                            修改 (執行設定)
                        </button>
                    `;
                } else if (currentUser && item.createdByUserId !== currentUser.uid) {
                    // 其他使用者：只有「檢核」權限 (只能修改右側)
                    actionButton = `
                        <button onclick="window.openEditModal('${item.id}', 'reviewer')" 
                                class="action-button bg-green-500 hover:bg-green-600 text-white shadow-md">
                            檢核 (檢核設定)
                        </button>
                    `;
                } else {
                    // 未登入：只有「查看」
                    actionButton = `
                        <button onclick="window.openEditModal('${item.id}', 'view')" 
                                class="action-button bg-gray-500 hover:bg-gray-600 text-white shadow-md">
                            查看
                        </button>
                    `;
                }
                
                // 決定刪除按鈕
                const deleteButton = (userRole === 'admin') ? `
                    <button onclick="window.deleteChecklist('${item.id}')" 
                            class="action-button bg-red-500 hover:bg-red-600 text-white ml-2 shadow-md">
                        刪除
                    </button>
                ` : '';

                // 判斷檢核結果的顏色
                const resultColor = item.result === '通過' ? 'bg-green-100 text-green-800' : 
                                    item.result === '不通過' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="font-medium">${item.accountNameId || 'N/A'}</td>
                        <td class="date-col">${item.date || 'N/A'}</td>
                        <td>${item.platform || 'N/A'}</td>
                        <td>${item.verificationType || 'N/A'}</td>
                        <td class="font-semibold">NT$ ${item.targetAmount ? item.targetAmount.toLocaleString() : 'N/A'}</td>
                        <td>
                            <span class="px-3 py-1 text-sm font-semibold rounded-full ${resultColor}">${item.result || '待檢核'}</span>
                        </td>
                        <td>${item.creatorEmail || 'N/A'}</td>
                        <td>${item.executionTimestampDisplay}</td>
                        <td>${item.reviewTimestampDisplay}</td>
                        <td class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            ${actionButton}
                            ${deleteButton}
                        </td>
                    </tr>
                `;
                historyTableBody.innerHTML += row;
            });
        }
        
        /**
         * 打開編輯/檢核/查看 modal
         * @param {string|null} docId 編輯的文件ID，null表示新增
         * @param {string} mode 'new', 'executor', 'reviewer', 'view'
         */
        window.openEditModal = (docId = null, mode = 'new') => {
            const modal = document.getElementById('checklistModal');
            const form = document.getElementById('checklistForm');
            const leftInputs = form.querySelectorAll('[data-group="executor"]');
            const rightInputs = form.querySelectorAll('[data-group="reviewer"]');
            const saveButton = document.getElementById('modalSaveBtn');

            // 1. 重置表單和錯誤訊息
            form.reset();
            document.getElementById('modalTitle').textContent = docId ? (mode === 'executor' ? '修改 (執行設定)' : mode === 'reviewer' ? '檢核 (檢核設定)' : '查看紀錄') : '新增核對資料 (執行設定)';
            document.getElementById('docIdField').value = docId || '';
            document.getElementById('modal-error').classList.add('hidden');
            
            // 2. 根據模式設定欄位狀態
            let isEditable = true;
            let currentTimestampField = 'executionTimestamp';
            
            if (mode === 'new') {
                // 新增：只能填左側
                leftInputs.forEach(input => input.disabled = false);
                rightInputs.forEach(input => input.disabled = true);
                saveButton.textContent = '儲存核對結果';
                saveButton.classList.remove('hidden');
            } else if (mode === 'executor') {
                // 執行人修改：只能修改左側
                leftInputs.forEach(input => input.disabled = false);
                rightInputs.forEach(input => input.disabled = true);
                saveButton.textContent = '更新執行設定';
                currentTimestampField = 'executionTimestamp';
                saveButton.classList.remove('hidden');
            } else if (mode === 'reviewer') {
                // 檢核人修改：只能修改右側
                leftInputs.forEach(input => input.disabled = true);
                rightInputs.forEach(input => input.disabled = false);
                saveButton.textContent = '更新檢核設定';
                currentTimestampField = 'reviewTimestamp';
                saveButton.classList.remove('hidden');
            } else if (mode === 'view') {
                // 查看：全部禁用
                leftInputs.forEach(input => input.disabled = true);
                rightInputs.forEach(input => input.disabled = true);
                saveButton.classList.add('hidden');
                isEditable = false;
            }
            
            // 3. 載入資料 (如果 docId 存在)
            if (docId) {
                const item = checklistData.find(d => d.id === docId);
                if (item) {
                    Object.keys(item).forEach(key => {
                        const input = form.elements[key];
                        if (input) {
                            if (input.type === 'date' && typeof item[key] === 'object' && item[key].toDate) {
                                // 處理 Firestore Timestamp 轉 Date
                                input.value = item[key].toDate().toISOString().split('T')[0];
                            } else {
                                input.value = item[key] || '';
                            }
                        }
                    });
                }
            }

            // 4. 設定儲存按鈕的點擊事件
            saveButton.onclick = async (e) => {
                e.preventDefault();
                
                const data = new FormData(form);
                const formData = {};
                for (const [key, value] of data.entries()) {
                    // 處理空字串轉為 null 或數字轉換
                    if (value === '') {
                        formData[key] = null;
                    } else if (key.includes('Budget') || key === 'targetAmount') {
                        // 嘗試將預算相關欄位轉換為數字
                        formData[key] = parseFloat(value) || 0;
                    } else {
                        formData[key] = value;
                    }
                }
                
                // 只有在可編輯模式下才更新時間戳記
                if (isEditable) {
                    formData[currentTimestampField] = new Date();
                }

                try {
                    // 根據模式只傳送允許更新的欄位
                    let updates = {};
                    const allKeys = Object.keys(formData);
                    
                    if (mode === 'executor') {
                        const executorKeys = ['clientName', 'date', 'platform', 'verificationType', 'accountNameId', 
                                              'targetOriginalAccountBudget', 'targetAccountBudgetAfterTopUp', 
                                              'adBudgetType', 'targetAmount', 'targetStartDate', 'targetEndDate',
                                              'executor', 'notes', 'executionTimestamp'];
                        executorKeys.forEach(key => {
                            if (allKeys.includes(key)) updates[key] = formData[key];
                        });
                    } else if (mode === 'reviewer') {
                        const reviewerKeys = ['actualOriginalAccountBudget', 'actualAccountBudgetAfterTopUp', 
                                              'actualSet', 'actualStartDate', 'actualEndDate',
                                              'reviewer', 'result', 'notes', 'reviewTimestamp'];
                        reviewerKeys.forEach(key => {
                            if (allKeys.includes(key)) updates[key] = formData[key];
                        });
                    } else {
                        // 新增模式
                        updates = formData;
                    }
                    
                    await saveChecklist(updates, docId);
                    modal.style.display = 'none'; // 儲存成功後關閉視窗

                } catch (error) {
                    console.error("儲存表單資料失敗:", error);
                    document.getElementById('modal-error').textContent = `❌ 儲存失敗: ${error.message}`;
                    document.getElementById('modal-error').classList.remove('hidden');
                }
            };

            modal.style.display = 'block';
        };

        /**
         * 關閉任一 modal
         * @param {string} modalId 視窗 ID
         */
        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        // -------------------------------------------------------------
        // 管理員後台 (Admin Panel)
        // -------------------------------------------------------------

        /**
         * 打開管理員面板
         */
        window.openAdminPanel = async () => {
            if (userRole !== 'admin') return;

            const adminModal = document.getElementById('adminModal');
            const userListBody = document.getElementById('userListBody');
            userListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">載入中...</td></tr>';
            
            try {
                // 載入 user_roles 集合中的所有用戶
                const userRef = collection(db, USER_ROLES_COLLECTION);
                const q = query(userRef, orderBy("email", "asc"));

                const snapshot = await new Promise((resolve) => onSnapshot(q, resolve));

                userListBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const isDefaultAdmin = userData.email && userData.email.toLowerCase() === defaultAdminEmail.toLowerCase();
                    
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2">${userData.email || 'N/A'}</td>
                            <td class="px-4 py-2">${userData.uid}</td>
                            <td class="px-4 py-2">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full ${userData.role === 'admin' ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-800'}">
                                    ${userData.role === 'admin' ? '管理員' : '一般用戶'}
                                </span>
                            </td>
                            <td class="px-4 py-2">
                                ${isDefaultAdmin ? '預設管理員 (無法移除)' : 
                                    (userData.role === 'admin' ? 
                                        `<button onclick="window.removeAdminRole('${userData.uid}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 text-sm rounded-lg shadow-md">
                                            移除管理員
                                        </button>` 
                                    : 
                                        `<button onclick="window.grantAdminRole('${userData.uid}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 text-sm rounded-lg shadow-md">
                                            提升為管理員
                                        </button>`)
                                }
                            </td>
                        </tr>
                    `;
                    userListBody.innerHTML += row;
                });
                
                document.getElementById('admin-error').classList.add('hidden');
            } catch (error) {
                console.error("載入管理員後台資料失敗:", error);
                document.getElementById('admin-error').textContent = `❌ 載入用戶列表失敗: ${error.message}`;
                document.getElementById('admin-error').classList.remove('hidden');
            }

            adminModal.style.display = 'block';
        };

        /**
         * 提升用戶為管理員
         * @param {string} uid 用戶 UID
         */
        window.grantAdminRole = async (uid) => {
            if (userRole !== 'admin') return;
            try {
                const docRef = doc(db, USER_ROLES_COLLECTION, uid);
                await updateDoc(docRef, { role: 'admin' });
                window.openAdminPanel(); // 重新載入面板
            } catch (error) {
                alert(`提升權限失敗: ${error.message}`);
                console.error("提升權限失敗:", error);
            }
        };

        /**
         * 移除用戶的管理員角色 (降級為一般用戶)
         * @param {string} uid 用戶 UID
         */
        window.removeAdminRole = async (uid) => {
            if (userRole !== 'admin') return;
            try {
                const docRef = doc(db, USER_ROLES_COLLECTION, uid);
                await updateDoc(docRef, { role: 'user' });
                window.openAdminPanel(); // 重新載入面板
            } catch (error) {
                alert(`降級權限失敗: ${error.message}`);
                console.error("降級權限失敗:", error);
            }
        };

        // -------------------------------------------------------------
        // 資料匯出 (Data Export)
        // -------------------------------------------------------------

        /**
         * 將歷史紀錄匯出為 CSV 檔案
         */
        window.exportToCSV = () => {
            if (checklistData.length === 0) {
                alert('沒有數據可以匯出。');
                return;
            }

            // 1. 定義 CSV 標頭
            const headers = [
                '客戶名稱', '日期', '平台', '檢核項目', '帳號名稱/帳號ID', 
                '目標 - 原始帳戶預算', '目標 - 儲值後帳戶預算', '廣告預算類型', '目標 - 儲值金額', 
                '目標 - 預計起始日', '目標 - 預計結束日', '執行人', 
                '實際 - 原始帳戶預算', '實際 - 儲值後帳戶預算', '實際 - 儲值是否成功', 
                '實際 - 起始日', '實際 - 結束日', '檢核人', '檢核結果', '備註/修正說明', 
                '執行時間', '檢核時間', '建立者UID', '建立者Email'
            ];
            const csvRows = [headers.join(',')];

            // 2. 處理數據行
            checklistData.forEach(item => {
                const row = [
                    item.clientName,
                    item.date,
                    item.platform,
                    item.verificationType,
                    item.accountNameId,
                    item.targetOriginalAccountBudget || 0,
                    item.targetAccountBudgetAfterTopUp || 0,
                    item.adBudgetType,
                    item.targetAmount || 0,
                    item.targetStartDate,
                    item.targetEndDate,
                    item.executor,
                    item.actualOriginalAccountBudget || 0,
                    item.actualAccountBudgetAfterTopUp || 0,
                    item.actualSet,
                    item.actualStartDate,
                    item.actualEndDate,
                    item.reviewer,
                    item.result,
                    // 處理備註中的換行符和逗號
                    `"${item.notes ? item.notes.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                    item.executionTimestampDisplay, // 執行時間
                    item.reviewTimestampDisplay, // 檢核時間
                    item.createdByUserId || 'N/A', 
                    item.creatorEmail || 'N/A'
                ];
                csvRows.push(row.map(cell => {
                    // 確保逗號被處理
                    let cellString = String(cell);
                    // 檢查是否包含逗號或已經是備註欄位 (備註已經處理過，所以這裡主要處理其他欄位)
                    if (cellString.includes(',') && !cellString.startsWith('"')) {
                        cellString = `"${cellString.replace(/"/g, '""')}"`;
                    }
                    return cellString;
                }).join(','));
            });

            const csvString = csvRows.join('\n');
            
            // 3. 建立 Blob 並下載 (加入 BOM 解決中文亂碼問題)
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'Budget_Checklist_Export_' + new Date().toISOString().slice(0, 10) + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

    </script>

    <!-- 頂部標題和驗證狀態 -->
    <header class="bg-indigo-600 text-white p-6 rounded-t-xl shadow-lg mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <h1 class="text-3xl font-bold mb-2 sm:mb-0">廣告預算核對雙簽表</h1>
            <div class="flex items-center space-x-3">
                <span id="auth-status" class="text-sm italic">請登入</span>
                <button id="login-button" onclick="signInWithGoogle()" 
                        class="bg-white text-indigo-600 px-4 py-2 rounded-full font-semibold shadow-md hover:bg-gray-100 transition duration-150 hidden">
                    登入 Google
                </button>
                <button id="logout-button" onclick="signOutUser()" 
                        class="bg-white text-red-600 px-4 py-2 rounded-full font-semibold shadow-md hover:bg-red-100 transition duration-150 hidden">
                    登出
                </button>
            </div>
        </div>
        <p class="text-indigo-200 mt-1">Campaign Budget Verification Checklist (C-BVC) - 權限管控版</p>
        <p class="text-indigo-300 mt-2 text-sm">此表單用於確保所有預算設定經過兩層次核對，防止超支錯誤。</p>
        <p id="auth-error" class="text-yellow-300 bg-red-800 p-2 rounded-lg mt-3 hidden text-sm font-medium"></p>
    </header>

    <!-- 主表單容器 -->
    <main class="bg-white p-6 rounded-b-xl shadow-lg mb-6">
        
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-gray-800">核對資料填寫區</h2>
            <button id="admin-button" onclick="openAdminPanel()" 
                    class="action-button bg-yellow-500 hover:bg-yellow-600 text-white shadow-md hidden">
                管理員後台
            </button>
        </div>

        <form id="checklistForm" class="space-y-6">
            <!-- 隱藏欄位用於儲存文件ID -->
            <input type="hidden" id="docIdField" name="id">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 checklist-grid">
                
                <!-- 左側：執行設定 (Executor Settings) -->
                <div class="p-4 border border-indigo-200 rounded-lg bg-indigo-50">
                    <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">執行設定 (Execution Settings)</h3>
                    
                    <div class="space-y-3">
                        <label class="block">客戶名稱: <input type="text" name="clientName" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                        <label class="block">日期: <input type="date" name="date" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                        <label class="block">平台: <select name="platform" data-group="executor" required class="w-full p-2 border rounded-md">
                            <option value="">選擇平台</option>
                            <option value="Google Ads">Google Ads</option>
                            <option value="Meta Ads">Meta Ads</option>
                            <option value="Line Ads">Line Ads</option>
                            <option option="Other">其他</option>
                        </select></label>
                        <label class="block">檢核項目: <select name="verificationType" data-group="executor" required class="w-full p-2 border rounded-md">
                            <option value="">選擇項目</option>
                            <option value="新增/調整預算">新增/調整預算</option>
                            <option value="活動上線">活動上線</option>
                            <option value="其他設定">其他設定</option>
                        </select></label>
                        <label class="block font-bold">帳號名稱/帳號ID: <input type="text" name="accountNameId" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                        
                        <hr class="my-4 border-indigo-100">
                        
                        <label class="block">目標 - 原始帳戶預算 (NT$): <input type="number" name="targetOriginalAccountBudget" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                        <label class="block">目標 - 儲值後帳戶預算 (NT$): <input type="number" name="targetAccountBudgetAfterTopUp" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                        
                        <label class="block">廣告預算類型: <select name="adBudgetType" data-group="executor" required class="w-full p-2 border rounded-md">
                            <option value="">選擇類型</option>
                            <option value="儲值金額">儲值金額</option>
                            <option value="日預算">日預算</option>
                            <option value="活動預算">活動預算</option>
                        </select></label>
                        <label class="block font-bold">目標 - 儲值/設定金額 (NT$): <input type="number" name="targetAmount" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                        
                        <label class="block">目標 - 預計起始日: <input type="date" name="targetStartDate" data-group="executor" class="w-full p-2 border rounded-md"></label>
                        <label class="block">目標 - 預計結束日: <input type="date" name="targetEndDate" data-group="executor" class="w-full p-2 border rounded-md"></label>
                        
                        <label class="block">執行人 (姓名/Email): <input type="text" name="executor" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                    </div>
                </div>

                <!-- 右側：檢核設定 (Reviewer Settings) -->
                <div class="p-4 border border-green-200 rounded-lg bg-green-50">
                    <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2">檢核設定 (Review Settings)</h3>

                    <div class="space-y-3">
                        <label class="block">實際 - 原始帳戶預算 (NT$): <input type="number" name="actualOriginalAccountBudget" data-group="reviewer" class="w-full p-2 border rounded-md"></label>
                        <label class="block">實際 - 儲值後帳戶預算 (NT$): <input type="number" name="actualAccountBudgetAfterTopUp" data-group="reviewer" class="w-full p-2 border rounded-md"></label>

                        <label class="block">實際 - 儲值/設定是否成功: <select name="actualSet" data-group="reviewer" class="w-full p-2 border rounded-md">
                            <option value="">選擇結果</option>
                            <option value="成功">成功</option>
                            <option value="失敗">失敗</option>
                            <option value="不適用">不適用</option>
                        </select></label>
                        
                        <label class="block">實際 - 起始日: <input type="date" name="actualStartDate" data-group="reviewer" class="w-full p-2 border rounded-md"></label>
                        <label class="block">實際 - 結束日: <input type="date" name="actualEndDate" data-group="reviewer" class="w-full p-2 border rounded-md"></label>
                        
                        <label class="block">檢核人 (姓名/Email): <input type="text" name="reviewer" data-group="reviewer" class="w-full p-2 border rounded-md"></label>
                        
                        <label class="block font-bold">檢核結果: <select name="result" data-group="reviewer" class="w-full p-2 border rounded-md">
                            <option value="">選擇檢核結果</option>
                            <option value="通過">通過</option>
                            <option value="不通過">不通過</option>
                            <option value="待處理">待處理</option>
                        </select></label>
                    </div>
                </div>
            </div>

            <!-- 備註/修正說明 (通用欄位) -->
            <div class="mt-6 p-4 border rounded-lg">
                <label class="block text-lg font-semibold mb-2">備註/修正說明 (兩方皆可填寫):</label>
                <textarea name="notes" rows="3" class="w-full p-2 border rounded-md" placeholder="請填寫任何特殊情況或修正過程。"></textarea>
            </div>
        </form>
        
        <!-- 操作按鈕和狀態訊息 -->
        <div class="mt-8 flex justify-center space-x-4">
            <button onclick="window.openEditModal()" 
                    class="action-button bg-gray-600 hover:bg-gray-700 text-white shadow-xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                新增一筆新資料
            </button>
            <button onclick="window.exportToCSV()" 
                    class="action-button bg-green-500 hover:bg-green-600 text-white shadow-xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                匯出 Excel/CSV 表單
            </button>
        </div>

        <!-- 儲存狀態訊息 -->
        <div id="save-success" class="mt-6 p-3 bg-green-100 text-green-700 border-l-4 border-green-500 rounded-lg hidden" role="alert">
            ✓ 儲存成功！
        </div>
        <div id="save-error" class="mt-6 p-3 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg hidden" role="alert">
            ❌ 儲存失敗: Missing or insufficient permissions.
        </div>
    </main>

    <!-- 歷史紀錄區 -->
    <section id="checklist-history" class="mt-8 p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">歷史核對記錄 (所有用戶共享)</h2>
        <p id="history-error" class="p-3 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg hidden mb-4" role="alert"></p>

        <div class="overflow-x-auto">
            <table class="min-w-full checklist-table">
                <thead>
                    <tr>
                        <th>帳號名稱/帳號ID</th>
                        <th class="date-col">日期</th>
                        <th>平台</th>
                        <th>檢核項目</th>
                        <th>目標金額</th>
                        <th>檢核結果</th>
                        <th>執行人 Email</th>
                        <th>執行時間</th>
                        <th>檢核時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    <!-- 紀錄將由 JavaScript 渲染到此 -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Modal for 新增/編輯/檢核 -->
    <div id="checklistModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 id="modalTitle" class="text-2xl font-bold text-indigo-700">新增核對資料 (執行設定)</h2>
                <span onclick="closeModal('checklistModal')" class="text-gray-500 hover:text-gray-700 text-3xl cursor-pointer">&times;</span>
            </div>
            
            <form id="modalChecklistForm" class="space-y-6">
                <!-- 欄位與主表單共用，但在這裡重新載入以確保獨立性 -->
                <!-- 這裡使用主表單的結構，JS會在 openEditModal 時填充或重置 -->
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 checklist-grid">
                
                    <!-- 左側：執行設定 -->
                    <div class="p-4 border border-indigo-200 rounded-lg bg-indigo-50">
                        <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">執行設定</h3>
                        <div class="space-y-3">
                            <label class="block">客戶名稱: <input type="text" name="clientName" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                            <label class="block">日期: <input type="date" name="date" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                            <label class="block">平台: <select name="platform" data-group="executor" required class="w-full p-2 border rounded-md">
                                <option value="">選擇平台</option><option value="Google Ads">Google Ads</option><option value="Meta Ads">Meta Ads</option><option value="Line Ads">Line Ads</option><option option="Other">其他</option>
                            </select></label>
                            <label class="block">檢核項目: <select name="verificationType" data-group="executor" required class="w-full p-2 border rounded-md">
                                <option value="">選擇項目</option><option value="新增/調整預算">新增/調整預算</option><option value="活動上線">活動上線</option><option value="其他設定">其他設定</option>
                            </select></label>
                            <label class="block font-bold">帳號名稱/帳號ID: <input type="text" name="accountNameId" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                            
                            <hr class="my-4 border-indigo-100">
                            
                            <label class="block">目標 - 原始帳戶預算 (NT$): <input type="number" name="targetOriginalAccountBudget" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                            <label class="block">目標 - 儲值後帳戶預算 (NT$): <input type="number" name="targetAccountBudgetAfterTopUp" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                            
                            <label class="block">廣告預算類型: <select name="adBudgetType" data-group="executor" required class="w-full p-2 border rounded-md">
                                <option value="">選擇類型</option><option value="儲值金額">儲值金額</option><option value="日預算">日預算</option><option value="活動預算">活動預算</option>
                            </select></label>
                            <label class="block font-bold">目標 - 儲值/設定金額 (NT$): <input type="number" name="targetAmount" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                            
                            <label class="block">目標 - 預計起始日: <input type="date" name="targetStartDate" data-group="executor" class="w-full p-2 border rounded-md"></label>
                            <label class="block">目標 - 預計結束日: <input type="date" name="targetEndDate" data-group="executor" class="w-full p-2 border rounded-md"></label>
                            
                            <label class="block">執行人 (姓名/Email): <input type="text" name="executor" data-group="executor" required class="w-full p-2 border rounded-md"></label>
                        </div>
                    </div>

                    <!-- 右側：檢核設定 -->
                    <div class="p-4 border border-green-200 rounded-lg bg-green-50">
                        <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2">檢核設定</h3>

                        <div class="space-y-3">
                            <label class="block">實際 - 原始帳戶預算 (NT$): <input type="number" name="actualOriginalAccountBudget" data-group="reviewer" class="w-full p-2 border rounded-md"></label>
                            <label class="block">實際 - 儲值後帳戶預算 (NT$): <input type="number" name="actualAccountBudgetAfterTopUp" data-group="reviewer" class="w-full p-2 border rounded-md"></label>

                            <label class="block">實際 - 儲值/設定是否成功: <select name="actualSet" data-group="reviewer" class="w-full p-2 border rounded-md">
                                <option value="">選擇結果</option><option value="成功">成功</option><option value="失敗">失敗</option><option value="不適用">不適用</option>
                            </select></label>
                            
                            <label class="block">實際 - 起始日: <input type="date" name="actualStartDate" data-group="reviewer" class="w-full p-2 border rounded-md"></label>
                            <label class="block">實際 - 結束日: <input type="date" name="actualEndDate" data-group="reviewer" class="w-full p-2 border rounded-md"></label>
                            
                            <label class="block">檢核人 (姓名/Email): <input type="text" name="reviewer" data-group="reviewer" class="w-full p-2 border rounded-md"></label>
                            
                            <label class="block font-bold">檢核結果: <select name="result" data-group="reviewer" class="w-full p-2 border rounded-md">
                                <option value="">選擇檢核結果</option><option value="通過">通過</option><option value="不通過">不通過</option><option value="待處理">待處理</option>
                            </select></label>
                        </div>
                    </div>
                </div>

                <!-- 備註/修正說明 (通用欄位) -->
                <div class="mt-6 p-4 border rounded-lg">
                    <label class="block text-lg font-semibold mb-2">備註/修正說明:</label>
                    <textarea name="notes" rows="3" class="w-full p-2 border rounded-md" placeholder="請填寫任何特殊情況或修正過程。"></textarea>
                </div>

                <!-- 隱藏欄位用於傳遞ID -->
                <input type="hidden" name="id" id="docIdField">
                
                <p id="modal-error" class="p-2 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg hidden text-sm" role="alert">錯誤訊息</p>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" onclick="closeModal('checklistModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold">
                        取消/關閉
                    </button>
                    <button type="button" id="modalSaveBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold">
                        儲存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for 管理員後台 -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold text-indigo-700">管理員後台 - 用戶權限管理</h2>
                <span onclick="closeModal('adminModal')" class="text-gray-500 hover:text-gray-700 text-3xl cursor-pointer">&times;</span>
            </div>

            <p id="admin-error" class="p-2 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg hidden text-sm mb-4" role="alert">錯誤訊息</p>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="userListBody" class="bg-white divide-y divide-gray-200">
                        <!-- 用戶列表將由 JavaScript 渲染到此 -->
                    </tbody>
                </table>
            </div>
            
            <div class="flex justify-end mt-4">
                <button type="button" onclick="closeModal('adminModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for 刪除確認 -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content max-w-sm">
            <h2 class="text-xl font-bold text-red-600 mb-4">確認刪除</h2>
            <p id="confirmDeleteText" class="mb-6">確定要永久刪除此筆記錄嗎？</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold">
                    取消
                </button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                    確定刪除
                </button>
            </div>
        </div>
    </div>

</body>
</html>
