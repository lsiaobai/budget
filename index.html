<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告預算核對雙簽表格 (Google 登入 & 權限控管)</title>
    <!-- 載入 Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體以模擬現代、專業的設計感 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* 輕微的背景色 */
        }
        /* 定義表格的特定樣式 */
        .checklist-table th, .checklist-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist-table th {
            background-color: #eef2ff; /* 淺藍色背景，模擬 Canva 的配色 */
            color: #312e81; /* 深藍色文字 */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .checklist-table tr:hover {
            background-color: #f7fafc;
        }
        /* 針對日期輸入框做樣式調整 */
        input[type="date"] {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* Highlight required fields with a special class */
        .is-required label::after, .is-required span.text-gray-700::after, 
        .form-group-required label::after {
            content: " *";
            color: #ef4444; /* red-500 */
        }
        /* Disabled input style */
        input:disabled, select:disabled, textarea:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
            opacity: 0.8;
        }
        /* Admin Panel Modal */
        #adminPanel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .admin-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        
        <!-- 標題區塊 -->
        <header class="p-6 sm:p-8 bg-indigo-600 text-white">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-1">廣告預算核對雙簽表</h1>
            <p class="text-indigo-200 text-lg">Campaign Budget Verification Checklist (C-BVC) - 權限控管版</p>
            <p class="mt-3 text-sm italic">此表單用於確保所有預算設定經過兩層次核對，防止超支錯誤。</p>

            <div class="mt-4 flex items-center justify-between">
                <div id="authStatus" class="text-xs font-mono break-all">
                    <span id="userEmailDisplay">請登入</span>
                </div>
                <div class="flex space-x-2">
                    <button id="adminPanelButton" class="hidden bg-yellow-500 hover:bg-yellow-600 text-gray-900 text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md">
                        👤 管理員後台
                    </button>
                    <button id="authButton" class="bg-indigo-700 hover:bg-indigo-800 text-white text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md">
                        登入 Google
                    </button>
                </div>
            </div>
            
            <!-- 載入提示 -->
            <div id="loadingIndicator" class="mt-3 text-sm font-semibold text-yellow-300 hidden">
                正在載入中...
            </div>
        </header>

        <!-- 表單內容：使用 form 標籤以便於重設 -->
        <form id="checklistForm" class="hidden">
            <!-- 基本資訊區塊 -->
            <div class="p-6 sm:p-8 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">基本資料</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-600">
                    <div class="flex flex-col form-group-required">
                        <label class="font-medium text-sm mb-1">客戶名稱 (Client Name)</label>
                        <input type="text" name="clientName" placeholder="輸入客戶全名" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="flex flex-col form-group-required">
                        <label class="font-medium text-sm mb-1">建立/修改日期 (Date)</label>
                        <input type="date" name="date" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
            </div>

            <!-- 預算核對表格 -->
            <div class="p-6 sm:p-8 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4" id="formTitle">廣告活動與預算細節</h2>
                
                <table class="checklist-table w-full border-collapse rounded-xl overflow-hidden">
                    <thead>
                        <tr>
                            <th class="w-1/4">欄位類別 (Category)</th>
                            <th class="w-1/4">設定內容 (Configuration)</th>
                            <th class="w-1/4">執行設定 (Executor Setting)</th> <!-- Executor only fill -->
                            <th class="w-1/4">檢核設定 (Reviewer Setting)</th> <!-- Reviewer only fill -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 廣告平台 -->
                        <tr>
                            <td class="font-medium text-gray-700">廣告平台</td>
                            <td>
                                <select name="platform" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option>Meta Ads (Facebook/IG)</option>
                                    <option>Google Ads</option>
                                    <option>Line Ads</option>
                                    <option>TikTok Ads</option>
                                    <option>其他</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- 帳號名稱/帳號ID (New Field Name) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">帳號名稱/帳號ID</td>
                            <td>
                                <input type="text" name="accountNameId" placeholder="輸入帳號名稱/ID" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- 檢核類型 (Control Field) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">檢核類型</td>
                            <td>
                                <select name="verificationType" id="verificationType" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                                    <option value="account_budget">帳戶預算 (Account Budget)</option>
                                    <option value="ad_budget">廣告預算 (Ad Budget)</option>
                                    <option value="all">全部 (All)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        
                        <!-- 預算相關欄位 (Account Budget) -->
                        <tr id="row-targetOriginalAccountBudget">
                            <td class="font-medium text-gray-700">原帳戶預算</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">預算變動前的值</label>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetOriginalAccountBudget" placeholder="執行金額" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualOriginalAccountBudget" placeholder="檢核實際值" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        <tr id="row-targetAccountBudgetAfterTopUp">
                            <td class="font-medium text-gray-700">加值後帳戶預算</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">預算變動後的值</label>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetAccountBudgetAfterTopUp" placeholder="執行金額" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualAccountBudgetAfterTopUp" placeholder="檢核實際值" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        
                        <!-- 廣告活動預算類型 (Ad Budget) -->
                        <tr id="row-adBudgetType">
                            <td class="font-medium text-gray-700">廣告預算類型</td>
                            <td class="input-group executor-field">
                                <select name="adBudgetType" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option value="">-- 請選擇 --</option>
                                    <option>日預算 (Daily Budget)</option>
                                    <option>總預算 (Lifetime Budget)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">（選擇類型後請填寫）</td>
                        </tr>
                        
                        <!-- 預算金額核對 (Ad Budget) -->
                        <tr id="row-targetAmount" class="bg-yellow-50/50">
                            <td class="font-bold text-indigo-700">廣告活動預算金額 (Budget)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">最終設定的金額</label>
                                <span class="text-gray-400 text-xs">（以當地貨幣計價）</span>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetAmount" placeholder="執行數值" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-red-600 font-semibold">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualSet" placeholder="檢核設定值" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-green-600 font-semibold">
                            </td>
                        </tr>
                        
                        <!-- 投放期間 - 開始日期 (Ad Budget) -->
                        <tr id="row-targetStartDate1">
                            <td class="font-medium text-gray-700" rowspan="2">投放期間 (Duration)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">開始日期 (Start Date)</label>
                            </td>
                            <td class="input-group executor-field">
                                <label class="block text-xs text-gray-500 mb-1">執行設定 (Target)</label>
                                <input type="date" name="targetStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group reviewer-field">
                                <label class="block text-xs text-gray-500 mb-1">檢核設定 (Actual)</label>
                                <input type="date" name="actualStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                        <!-- 投放期間 - 結束日期 (Ad Budget) -->
                        <tr id="row-targetEndDate2">
                            <td>
                                <label class="block text-xs font-semibold mb-1">結束日期 (End Date)</label>
                            </td>
                            <td class="input-group executor-field">
                                <label class="block text-xs text-gray-500 mb-1">執行設定 (Target)</label>
                                <input type="date" name="targetEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group reviewer-field">
                                <label class="block text-xs text-gray-500 mb-1">檢核設定 (Actual)</label>
                                <input type="date" name="actualEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Budget Calculation Section -->
                <div class="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <button type="button" id="calculateBudgetButton" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            🧮 計算預估預算花費
                        </button>
                        <div id="calculatedResult" class="text-lg font-semibold text-purple-800 w-full text-center sm:text-left">
                            （點擊按鈕進行計算）
                        </div>
                    </div>
                    <p class="text-xs text-purple-500 mt-2">僅適用於「日預算」類型，將計算 [廣告活動執行設定預算金額 * 執行設定投放期間天數] 的總預估花費。</p>
                </div>
            </div>

            <!-- 簽核區塊 -->
            <div class="p-6 sm:p-8 bg-gray-50 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">雙簽與結果</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- 執行人簽名 -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-indigo-300">
                        <label class="font-bold text-indigo-600 mb-2">執行人 (Executor) 簽核 <span class="text-red-500">*</span></label>
                        <p class="text-sm text-gray-500 mb-2">設定預算的第一責任人。</p>
                        <input type="text" name="executor" id="executorInput" placeholder="請輸入姓名/工號確認" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-indigo-500" required>
                        <div class="mt-3 text-xs text-gray-400">
                            執行人最後更新: <span id="executorTimeDisplay" class="font-medium text-gray-700">N/A</span>
                        </div>
                    </div>
                    
                    <!-- 核對人簽名 -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-green-500">
                        <label class="font-bold text-green-600 mb-2">核對人 (Reviewer) 獨立確認</label>
                        <p class="text-sm text-gray-500 mb-2">獨立核對並確認設定值與要求數值相符。</p>
                        <input type="text" name="reviewer" id="reviewerInput" placeholder="選填：請輸入姓名/工號確認" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-green-500">
                        <div class="mt-3 text-xs text-gray-400">
                            核對人最後更新: <span id="reviewerTimeDisplay" class="font-medium text-gray-700">N/A</span>
                        </div>
                    </div>
                </div>
                
                <!-- 結果欄位 -->
                <div class="mt-6 p-4 bg-white rounded-lg shadow-md reviewer-field">
                    <label class="font-bold text-gray-800 mb-2 block">最終核對結果</label>
                    <select name="result" id="resultSelect" class="p-3 border border-gray-300 rounded-lg w-full text-lg font-semibold text-center focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- 請選擇 --</option>
                        <option value="pass">✅ 核對通過 (可開始投放)</option>
                        <option value="fail">❌ 核對不通過 (已暫停/需修正)</option>
                    </select>
                </div>
                
                <!-- 備註 -->
                <div class="mt-6">
                    <label for="notes" class="font-bold text-gray-800 mb-2 block">備註/修正說明</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="請填寫任何特殊情況或修正過程。" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- 動作按鈕 -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button type="submit" id="saveButton" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:bg-gray-400" disabled>
                        💾 儲存 (請先登入)
                    </button>
                    <button type="button" id="newRecordButton" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg" disabled>
                        ➕ 新增一筆新資料
                    </button>
                    <button type="button" id="exportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg" disabled>
                        ⬇️ 匯出 Excel/CSV 表單
                    </button>
                </div>

                <!-- 狀態訊息 -->
                <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center text-sm font-medium hidden"></div>

            </div>
        </form>
        
        <!-- 歷史記錄區塊 -->
        <div id="historySection" class="p-6 sm:p-8 bg-gray-100 border-t border-gray-300 mt-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">歷史核對記錄</h2>
            <div id="historyTableContainer" class="overflow-x-auto">
                <p class="text-gray-500 p-4 text-center">請先登入以查看共享歷史記錄...</p>
            </div>
            <div id="historyStatus" class="mt-4 text-sm font-medium text-center text-gray-600"></div>
        </div>
        <!-- 底部提示 -->
        <footer class="p-6 sm:p-8 bg-gray-800 text-white text-center text-sm">
            <p>💡 提示：在每次設定或調整預算後，都必須執行此雙簽流程。</p>
        </footer>

    </div>

    <!-- 管理員後台 Modal -->
    <div id="adminPanel" class="hidden">
        <div class="admin-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">管理員後台 - 提升權限</h3>
            <p class="text-sm text-gray-600 mb-4">只有管理員 (${lsiaobai@gmail.com}) 可以看到此面板並設置其他用戶為管理者。</p>
            
            <div id="userListContainer" class="max-h-80 overflow-y-auto border p-3 rounded-lg bg-gray-50">
                <p class="text-center text-gray-500">載入用戶中...</p>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="closeAdminPanel()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    關閉
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- 非模組腳本區塊 (純粹的 UI 輔助功能) ---
        
        // Function to calculate the number of days between two dates (inclusive)
        function calculateDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) return 0;

            const diffTime = Math.abs(end.getTime() - start.getTime());
            
            // Convert to days (add 1 for inclusive count)
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return diffDays;
        }

        // Function to handle the budget calculation
        function calculateEstimatedBudget() {
            const form = document.getElementById('checklistForm');
            const budgetType = form.elements['adBudgetType'].value;
            // 使用執行設定的金額 (targetAmount)
            const dailyBudget = parseFloat(form.elements['targetAmount'].value); 
            // 使用執行設定的日期 (targetStartDate/targetEndDate)
            const startDate = form.elements['targetStartDate'].value;
            const endDate = form.elements['targetEndDate'].value;
            const resultEl = document.getElementById('calculatedResult');

            resultEl.className = 'text-lg font-semibold w-full text-center sm:text-left'; // Reset classes
            resultEl.classList.remove('text-red-600', 'text-green-700');

            if (budgetType !== '日預算 (Daily Budget)') {
                resultEl.textContent = '計算失敗：請選擇「日預算」類型進行計算。';
                resultEl.classList.add('text-red-600');
                return;
            }

            if (isNaN(dailyBudget) || dailyBudget <= 0) {
                resultEl.textContent = '計算失敗：請輸入有效的「廣告活動預算金額 (執行設定)」。';
                resultEl.classList.add('text-red-600');
                return;
            }

            const days = calculateDays(startDate, endDate);

            if (days <= 0) {
                resultEl.textContent = '計算失敗：請選擇有效的「投放期間」執行設定日期範圍 (開始日需早於或等於結束日)。';
                resultEl.classList.add('text-red-600');
                return;
            }

            const estimatedTotal = dailyBudget * days;
            
            const formattedTotal = estimatedTotal.toLocaleString('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });

            resultEl.textContent = `預估總花費（共 ${days} 天）：${formattedTotal}`;
            resultEl.classList.add('text-green-700');
        }

        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('calculateBudgetButton').addEventListener('click', calculateEstimatedBudget);
        });

        // 為了讓 Modal 可以從 HTML 內聯調用
        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

    </script>
    
    <!-- FIREBASE 核心功能 (驗證, 儲存, 權限控管) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        serverTimestamp,
        doc,
        setDoc,
        deleteDoc,
        getDocs,
        setLogLevel,
        query,
        orderBy,
        getDoc, 
        updateDoc, 
        Timestamp,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // 設定 Firebase Debug Log
    setLogLevel('Debug');

    // --------------------------------------------------
    // 1. 請在這裡填寫您的 Firebase 設定物件 (重要!)
    // --------------------------------------------------
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    }; 
    // --------------------------------------------------
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserId = null;
    let currentUserEmail = null;
    let isAdminUser = false;
    let allChecklistData = []; 

    // 輔助函數：格式化時間戳
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        const date = timestamp instanceof Timestamp 
                    ? timestamp.toDate() 
                    : new Date(timestamp);
        
        if (isNaN(date)) return 'N/A';
        
        return date.toLocaleDateString('zh-TW', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        }).replace(/\//g, '-');
    }

    // =================================================================
    // 2. 資料載入函數 (時序修復)
    // =================================================================

    function loadHistoryChecklists() {
        const collectionRef = collection(doc(db, "public", "data"), "budget_checklists");
        
        document.getElementById("historyMessage").innerText = "正在載入歷史記錄..."; 

        const q = query(collectionRef, orderBy("executionTimestamp", "desc"));
        getDocs(q)
            .then(querySnapshot => {
                document.getElementById("historyMessage").innerText = ""; 
                displayHistoryChecklists(querySnapshot);
            })
            .catch(error => {
                document.getElementById("historyMessage").innerText = `❌ 載入歷史記錄失敗: ${error.message}。請檢查 Firestore 規則是否允許讀取。`;
                console.error("載入歷史記錄失敗:", error);
            });
    }

    function loadUserRoles() {
        const collectionRef = collection(doc(db, "public", "data"), "user_roles");
        
        document.getElementById("userListMessage").innerText = "正在載入用戶列表..."; 
        
        getDocs(collectionRef)
            .then(querySnapshot => {
                document.getElementById("userListMessage").innerText = ""; 
                displayUserList(querySnapshot);
            })
            .catch(error => {
                document.getElementById("userListMessage").innerText = `❌ 載入用戶列表失敗: ${error.message}`;
                console.error("載入用戶列表失敗:", error);
            });
    }


    // =================================================================
    // 3. 歷史記錄相關函數 (V9 修復 + 公開)
    // =================================================================

    function displayHistoryChecklists(querySnapshot) {
        const historyListBody = document.getElementById('historyListBody');
        historyListBody.innerHTML = '';
        allChecklistData = []; 

        querySnapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id;
            data.executionTimestampDisplay = formatTimestamp(data.executionTimestamp);
            data.reviewTimestampDisplay = formatTimestamp(data.reviewTimestamp);

            allChecklistData.push(data);
            displayRow(historyListBody, data);
        });

        document.getElementById('downloadCsvButton').style.display = allChecklistData.length > 0 ? 'inline-block' : 'none';
    }

    function displayRow(container, item) {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        
        let resultText = '';
        let resultClass = '';

        if (item.result === 'Pass') {
            resultText = '通過 (Pass)';
            resultClass = 'bg-green-100 text-green-800';
        } else if (item.result === 'Fail') {
            resultText = '不通過 (Fail)';
            resultClass = 'bg-red-100 text-red-800';
        } else if (item.reviewer && !item.result) {
            resultText = '檢核中';
            resultClass = 'bg-yellow-100 text-yellow-800';
        } else {
            resultText = '待檢核';
            resultClass = 'bg-gray-100 text-gray-800';
        }

        tr.innerHTML = `
            <td class="whitespace-nowrap">${item.project || 'N/A'}</td>
            <td class="whitespace-nowrap">${item.account || 'N/A'}</td>
            <td class="whitespace-nowrap">${item.date || 'N/A'}</td>
            <td class="whitespace-nowrap">${item.creatorEmail || 'N/A'}</td>
            <td class="whitespace-nowrap">${item.reviewerEmail || 'N/A'}</td>
            <td class="whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${resultClass}">${resultText}</span></td>
            <td class="whitespace-nowrap">${item.reviewTimestampDisplay}</td>
            <td class="text-right">
                ${createActionButton(item)}
            </td>
        `;
        container.appendChild(tr);
    }

    function createActionButton(item) {
        if (isAdminUser) {
            // 注意：這裡呼叫的 deleteChecklist 會指向 window.deleteChecklist
            return `<button onclick="deleteChecklist('${item.id}')" class="text-red-600 hover:text-red-900 ml-2">刪除</button>`;
        } else if (!item.reviewerEmail && currentUserId === item.createdByUserId) {
            return `<button onclick="editChecklist('${item.id}')" class="text-indigo-600 hover:text-indigo-900">編輯/重新送出</button>`;
        } else if (!item.result && currentUserEmail === item.reviewerEmail) {
            return `<button onclick="reviewChecklist('${item.id}')" class="text-green-600 hover:text-green-900">進行檢核</button>`;
        } else if (item.result) {
            return `<button onclick="viewChecklist('${item.id}')" class="text-gray-600 hover:text-gray-900">查看</button>`;
        }
        return '';
    }

    // 將函數掛載到 window，供 HTML 內聯事件調用
    window.reviewChecklist = (id) => {
        const item = allChecklistData.find(d => d.id === id);
        if (!item) return;

        const notes = prompt("請輸入檢核備註 (選填):");
        if (notes === null) return; 

        const result = confirm("請確認檢核結果：點擊『確定』表示通過 (Pass)，『取消』表示不通過 (Fail)") ? 'Pass' : 'Fail';

        const docRef = doc(db, "public", "data", "budget_checklists", id);
        updateDoc(docRef, {
            result: result,
            notes: notes,
            reviewTimestamp: serverTimestamp(), 
            reviewer: currentUserEmail
        })
        .then(() => {
            alert("檢核結果已成功送出！");
            loadHistoryChecklists(); 
        })
        .catch(error => {
            alert("檢核送出失敗：" + error.message);
            console.error("檢核送出失敗:", error);
        });
    }
    
    // 將函數掛載到 window，供 HTML 內聯事件調用
    window.deleteChecklist = (id) => {
        if (!isAdminUser) {
            alert("您沒有權限執行刪除操作。");
            return;
        }
        if (confirm("警告：您確定要永久刪除此筆記錄嗎？")) {
            deleteDoc(doc(db, "public", "data", "budget_checklists", id))
                .then(() => {
                    alert("記錄已刪除。");
                    loadHistoryChecklists(); 
                })
                .catch(error => {
                    alert("刪除失敗：" + error.message);
                    console.error("刪除失敗:", error);
                });
        }
    }

    // 將函數掛載到 window，供 HTML 內聯事件調用
    window.downloadCSV = () => {
        const header = [
            'ID', '專案名稱', '廣告帳戶', '日期', '預算檢查', '執行人', '檢核人', 
            '檢核結果', '備註', '執行時間', '檢核時間', '建立者UID', '建立者Email'
        ];
        let csvRows = [];
        csvRows.push(header.join(','));

        allChecklistData.forEach(item => {
            const row = [
                item.id, `\"${item.project || ''}\"`, `\"${item.account || ''}\"`,
                item.date || '', item.isBudgetChecked ? '是' : '否',
                item.creatorEmail || '', item.reviewerEmail || '',
                item.result || '', 
                `\"${item.notes ? item.notes.replace(/\"/g, '\"\"').replace(/\\n/g, ' ') : ''}\"`,
                item.executionTimestampDisplay || '', item.reviewTimestampDisplay || '', 
                item.createdByUserId || '', item.creatorEmail || ''
            ];
            csvRows.push(row.map(cell => {
                let cellString = String(cell);
                if (cellString.includes(',') || cellString.includes('"') || cellString.includes('\n')) {
                    cellString = `"${cellString.replace(/"/g, '""')}"`;
                }
                return cellString;
            }).join(','));
        });

        const csvString = csvRows.join('\n');
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', 'Budget_Checklist_Export_' + new Date().toISOString().slice(0, 10) + '.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // (您的 editChecklist 和 viewChecklist 函數也應該被公開，這裡假設它們是空的或您稍後會添加)
    window.editChecklist = (id) => { alert(`編輯功能 ${id} (尚未實作)`); }
    window.viewChecklist = (id) => { alert(`查看功能 ${id} (尚未實作)`); }


    // =================================================================
    // 4. 管理者後台相關函數 (V9 修復 + 公開)
    // =================================================================

    function displayUserList(querySnapshot) {
        const userListBody = document.getElementById('userListBody');
        userListBody.innerHTML = '';

        querySnapshot.forEach(doc => {
            const user = doc.data();
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            // 注意：這裡呼叫的 updateUserRole 會指向 window.updateUserRole
            tr.innerHTML = `
                <td class="whitespace-nowrap">${doc.id}</td>
                <td class="whitespace-nowrap">${user.role || 'user'}</td>
                <td class="text-right">
                    <select onchange="updateUserRole('${doc.id}', this.value)" class="p-1 border rounded">
                        <option value="user" ${user.role !== 'admin' ? 'selected' : ''}>User</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </td>
            `;
            userListBody.appendChild(tr);
        });
    }

    // 將函數掛載到 window，供 HTML 內聯事件調用
    window.updateUserRole = (userId, newRole) => {
        if (!isAdminUser) {
            alert("您沒有權限修改用戶角色。");
            return;
        }
        
        setDoc(doc(db, "public", "data", "user_roles", userId), {
            role: newRole
        }, { merge: true })
        .then(() => {
            alert(`用戶 ${userId} 的角色已更新為 ${newRole}`);
            loadUserRoles(); 
        })
        .catch(error => {
            alert("更新角色失敗：" + error.message);
            console.error("更新角色失敗:", error);
        });
    }


    // =================================================================
    // 5. 檢查管理員狀態的輔助函數 (V9 修復時序)
    // =================================================================

    function checkUserAdminStatus(uid) {
        getDoc(doc(db, "public", "data", "user_roles", uid))
            .then(docSnap => {
                if (docSnap.exists() && docSnap.data().role === 'admin') {
                    isAdminUser = true;
                    document.getElementById("adminPanel").style.display = "block";
                    loadUserRoles(); 
                } else {
                    isAdminUser = false;
                    document.getElementById("adminPanel").style.display = "none";
                }
            })
            .catch(error => {
                console.error("檢查管理員狀態失敗:", error);
                isAdminUser = false;
                document.getElementById("adminPanel").style.display = "none";
            });
    }

    // =================================================================
    // 6. 核心登入/登出邏輯 (V9 修復時序)
    // =================================================================

    // 登入按鈕點擊處理 (使用 addEventListener)
    document.getElementById('signInButton').addEventListener('click', () => {
        const provider = new GoogleAuthProvider(); 
        signInWithPopup(auth, provider) 
            .catch(error => {
                // 登入彈窗被關閉或權限被拒絕也會在這裡
                console.error("Google 登入失敗:", error);
                alert(`登入失敗: ${error.message}`);
            });
    });

    // 登出按鈕點擊處理
    document.getElementById('signOutButton').addEventListener('click', () => {
        signOut(auth); 
    });

    // *** 核心修復：監聽登入狀態，並在登入後才讀取資料 ***
    onAuthStateChanged(auth, user => { 
        if (user) {
            // --- 使用者已登入 ---
            currentUserId = user.uid;
            currentUserEmail = user.email;
            document.getElementById("userStatus").innerText = `已登入: ${currentUserEmail}`;
            document.getElementById("authPanel").style.display = "none";
            document.getElementById("content").style.display = "block";
            
            loadHistoryChecklists(); 
            checkUserAdminStatus(user.uid);

        } else {
            // --- 使用者已登出 ---
            currentUserId = null;
            currentUserEmail = null;
            isAdminUser = false;
            document.getElementById("userStatus").innerText = "未登入";
            document.getElementById("authPanel").style.display = "block";
            document.getElementById("content").style.display = "none";
            document.getElementById("adminPanel").style.display = "none";

            // 清空並顯示未登入訊息
            document.getElementById("historyListBody").innerHTML = '';
            document.getElementById("userListBody").innerHTML = '';
            document.getElementById("historyMessage").innerText = "❌ 未登入，無法載入歷史記錄。請登入。";
            document.getElementById("userListMessage").innerText = "❌ 未登入，無法載入用戶列表。請登入。";
        }
    });


    // =================================================================
    // 7. 送出核對表單 (V9 修復)
    // =================================================================

    document.getElementById('checklistForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!currentUserId) {
            alert("請先登入才能送出表格！");
            return;
        }

        const form = e.target;
        const project = form.project.value;
        const account = form.account.value;
        const date = form.date.value;
        const isBudgetChecked = form.isBudgetChecked.checked;
        const reviewerEmail = form.reviewerEmail.value;

        if (!reviewerEmail.includes('@')) {
             alert("請輸入有效的檢核人 Email 地址。");
             return;
        }

        addDoc(collection(doc(db, "public", "data"), "budget_checklists"), {
            project: project,
            account: account,
            date: date,
            isBudgetChecked: isBudgetChecked,
            reviewerEmail: reviewerEmail,
            result: null, 
            notes: null,
            executionTimestamp: serverTimestamp(), 
            createdByUserId: currentUserId,
            creatorEmail: currentUserEmail,
        })
        .then(() => {
            alert("核對表已成功送出！");
            form.reset(); 
            loadHistoryChecklists(); 
        })
        .catch(error => {
            alert("送出失敗：" + error.message);
            console.error("送出失敗:", error);
        });
    });

</script>
</body>

</html>

