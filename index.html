<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告預算核對雙簽表格 (Google 登入 & 權限控管)</title>
    <!-- 載入 Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體以模擬現代、專業的設計感 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* 輕微的背景色 */
        }
        /* 定義表格的特定樣式 */
        .checklist-table th, .checklist-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist-table th {
            background-color: #eef2ff; /* 淺藍色背景，模擬 Canva 的配色 */
            color: #312e81; /* 深藍色文字 */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .checklist-table tr:hover {
            background-color: #f7fafc;
        }
        /* 針對日期輸入框做樣式調整 */
        input[type="date"] {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* Highlight required fields with a special class */
        .is-required label::after, .is-required span.text-gray-700::after, 
        .form-group-required label::after {
            content: " *";
            color: #ef4444; /* red-500 */
        }
        /* Disabled input style */
        input:disabled, select:disabled, textarea:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
            opacity: 0.8;
        }
        /* Admin Panel Modal */
        #adminPanel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .admin-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        
        <!-- 標題區塊 -->
        <header class="p-6 sm:p-8 bg-indigo-600 text-white">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-1">廣告預算核對雙簽表</h1>
            <p class="text-indigo-200 text-lg">Campaign Budget Verification Checklist (C-BVC) - 權限控管版</p>
            <p class="mt-3 text-sm italic">此表單用於確保所有預算設定經過兩層次核對，防止超支錯誤。</p>

            <div class="mt-4 flex items-center justify-between">
                <div id="authStatus" class="text-xs font-mono break-all">
                    <span id="userEmailDisplay">請登入</span>
                </div>
                <div class="flex space-x-2">
                    <button id="adminPanelButton" class="hidden bg-yellow-500 hover:bg-yellow-600 text-gray-900 text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md">
                        👤 管理員後台
                    </button>
                    <button id="authButton" class="bg-indigo-700 hover:bg-indigo-800 text-white text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md">
                        登入 Google
                    </button>
                </div>
            </div>
            
            <!-- 載入提示 -->
            <div id="loadingIndicator" class="mt-3 text-sm font-semibold text-yellow-300 hidden">
                正在載入中...
            </div>
        </header>

        <!-- 表單內容：使用 form 標籤以便於重設 -->
        <form id="checklistForm" class="hidden">
            <!-- 基本資訊區塊 -->
            <div class="p-6 sm:p-8 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">基本資料</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-600">
                    <div class="flex flex-col form-group-required">
                        <label class="font-medium text-sm mb-1">客戶名稱 (Client Name)</label>
                        <input type="text" name="clientName" placeholder="輸入客戶全名" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="flex flex-col form-group-required">
                        <label class="font-medium text-sm mb-1">建立/修改日期 (Date)</label>
                        <input type="date" name="date" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
            </div>

            <!-- 預算核對表格 -->
            <div class="p-6 sm:p-8 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4" id="formTitle">廣告活動與預算細節</h2>
                
                <table class="checklist-table w-full border-collapse rounded-xl overflow-hidden">
                    <thead>
                        <tr>
                            <th class="w-1/4">欄位類別 (Category)</th>
                            <th class="w-1/4">設定內容 (Configuration)</th>
                            <th class="w-1/4">執行設定 (Executor Setting)</th> <!-- Executor only fill -->
                            <th class="w-1/4">檢核設定 (Reviewer Setting)</th> <!-- Reviewer only fill -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 廣告平台 -->
                        <tr>
                            <td class="font-medium text-gray-700">廣告平台</td>
                            <td>
                                <select name="platform" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option>Meta Ads (Facebook/IG)</option>
                                    <option>Google Ads</option>
                                    <option>Line Ads</option>
                                    <option>TikTok Ads</option>
                                    <option>其他</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- 帳號名稱/帳號ID (New Field Name) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">帳號名稱/帳號ID</td>
                            <td>
                                <input type="text" name="accountNameId" placeholder="輸入帳號名稱/ID" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- 檢核類型 (Control Field) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">檢核類型</td>
                            <td>
                                <select name="verificationType" id="verificationType" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                                    <option value="account_budget">帳戶預算 (Account Budget)</option>
                                    <option value="ad_budget">廣告預算 (Ad Budget)</option>
                                    <option value="all">全部 (All)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        
                        <!-- 預算相關欄位 (Account Budget) -->
                        <tr id="row-targetOriginalAccountBudget">
                            <td class="font-medium text-gray-700">原帳戶預算</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">預算變動前的值</label>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetOriginalAccountBudget" placeholder="執行金額" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualOriginalAccountBudget" placeholder="檢核實際值" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        <tr id="row-targetAccountBudgetAfterTopUp">
                            <td class="font-medium text-gray-700">加值後帳戶預算</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">預算變動後的值</label>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetAccountBudgetAfterTopUp" placeholder="執行金額" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualAccountBudgetAfterTopUp" placeholder="檢核實際值" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        
                        <!-- 廣告活動預算類型 (Ad Budget) -->
                        <tr id="row-adBudgetType">
                            <td class="font-medium text-gray-700">廣告預算類型</td>
                            <td class="input-group executor-field">
                                <select name="adBudgetType" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option value="">-- 請選擇 --</option>
                                    <option>日預算 (Daily Budget)</option>
                                    <option>總預算 (Lifetime Budget)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">（選擇類型後請填寫）</td>
                        </tr>
                        
                        <!-- 預算金額核對 (Ad Budget) -->
                        <tr id="row-targetAmount" class="bg-yellow-50/50">
                            <td class="font-bold text-indigo-700">廣告活動預算金額 (Budget)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">最終設定的金額</label>
                                <span class="text-gray-400 text-xs">（以當地貨幣計價）</span>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetAmount" placeholder="執行數值" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-red-600 font-semibold">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualSet" placeholder="檢核設定值" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-green-600 font-semibold">
                            </td>
                        </tr>
                        
                        <!-- 投放期間 - 開始日期 (Ad Budget) -->
                        <tr id="row-targetStartDate1">
                            <td class="font-medium text-gray-700" rowspan="2">投放期間 (Duration)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">開始日期 (Start Date)</label>
                            </td>
                            <td class="input-group executor-field">
                                <label class="block text-xs text-gray-500 mb-1">執行設定 (Target)</label>
                                <input type="date" name="targetStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group reviewer-field">
                                <label class="block text-xs text-gray-500 mb-1">檢核設定 (Actual)</label>
                                <input type="date" name="actualStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                        <!-- 投放期間 - 結束日期 (Ad Budget) -->
                        <tr id="row-targetEndDate2">
                            <td>
                                <label class="block text-xs font-semibold mb-1">結束日期 (End Date)</label>
                            </td>
                            <td class="input-group executor-field">
                                <label class="block text-xs text-gray-500 mb-1">執行設定 (Target)</label>
                                <input type="date" name="targetEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group reviewer-field">
                                <label class="block text-xs text-gray-500 mb-1">檢核設定 (Actual)</label>
                                <input type="date" name="actualEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Budget Calculation Section -->
                <div class="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <button type="button" id="calculateBudgetButton" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            🧮 計算預估預算花費
                        </button>
                        <div id="calculatedResult" class="text-lg font-semibold text-purple-800 w-full text-center sm:text-left">
                            （點擊按鈕進行計算）
                        </div>
                    </div>
                    <p class="text-xs text-purple-500 mt-2">僅適用於「日預算」類型，將計算 [廣告活動執行設定預算金額 * 執行設定投放期間天數] 的總預估花費。</p>
                </div>
            </div>

            <!-- 簽核區塊 -->
            <div class="p-6 sm:p-8 bg-gray-50 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">雙簽與結果</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- 執行人簽名 -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-indigo-300">
                        <label class="font-bold text-indigo-600 mb-2">執行人 (Executor) 簽核 <span class="text-red-500">*</span></label>
                        <p class="text-sm text-gray-500 mb-2">設定預算的第一責任人。</p>
                        <input type="text" name="executor" id="executorInput" placeholder="請輸入姓名/工號確認" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-indigo-500" required>
                        <div class="mt-3 text-xs text-gray-400">
                            執行人最後更新: <span id="executorTimeDisplay" class="font-medium text-gray-700">N/A</span>
                        </div>
                    </div>
                    
                    <!-- 核對人簽名 -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-green-500">
                        <label class="font-bold text-green-600 mb-2">核對人 (Reviewer) 獨立確認</label>
                        <p class="text-sm text-gray-500 mb-2">獨立核對並確認設定值與要求數值相符。</p>
                        <input type="text" name="reviewer" id="reviewerInput" placeholder="選填：請輸入姓名/工號確認" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-green-500">
                        <div class="mt-3 text-xs text-gray-400">
                            核對人最後更新: <span id="reviewerTimeDisplay" class="font-medium text-gray-700">N/A</span>
                        </div>
                    </div>
                </div>
                
                <!-- 結果欄位 -->
                <div class="mt-6 p-4 bg-white rounded-lg shadow-md reviewer-field">
                    <label class="font-bold text-gray-800 mb-2 block">最終核對結果</label>
                    <select name="result" id="resultSelect" class="p-3 border border-gray-300 rounded-lg w-full text-lg font-semibold text-center focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- 請選擇 --</option>
                        <option value="pass">✅ 核對通過 (可開始投放)</option>
                        <option value="fail">❌ 核對不通過 (已暫停/需修正)</option>
                    </select>
                </div>
                
                <!-- 備註 -->
                <div class="mt-6">
                    <label for="notes" class="font-bold text-gray-800 mb-2 block">備註/修正說明</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="請填寫任何特殊情況或修正過程。" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- 動作按鈕 -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button type="submit" id="saveButton" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:bg-gray-400" disabled>
                        💾 儲存 (請先登入)
                    </button>
                    <button type="button" id="newRecordButton" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg" disabled>
                        ➕ 新增一筆新資料
                    </button>
                    <button type="button" id="exportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg" disabled>
                        ⬇️ 匯出 Excel/CSV 表單
                    </button>
                </div>

                <!-- 狀態訊息 -->
                <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center text-sm font-medium hidden"></div>

            </div>
        </form>
        
        <!-- 歷史記錄區塊 -->
        <div id="historySection" class="p-6 sm:p-8 bg-gray-100 border-t border-gray-300 mt-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">歷史核對記錄</h2>
			<div id="filter-container" class="mb-6 flex flex-wrap gap-4 items-end p-4 border border-gray-200 rounded-xl bg-gray-50">
        <div class="flex flex-col w-full sm:w-auto">
            <label for="filter-executor" class="text-sm font-medium text-gray-700 mb-1">執行者篩選</label>
            <select id="filter-executor" onchange="handleFilterChange(event)" data-filter-key="executor" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-white min-w-[150px]">
                <option value="all">所有執行者</option>
            </select>
        </div>
        
        <div class="flex flex-col w-full sm:w-auto">
            <label for="filter-reviewer" class="text-sm font-medium text-gray-700 mb-1">檢核者篩選</label>
            <select id="filter-reviewer" onchange="handleFilterChange(event)" data-filter-key="reviewer" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-white min-w-[150px]">
                <option value="all">所有檢核者</option>
            </select>
        </div>
        
        <div class="flex flex-col w-full sm:w-auto">
            <label for="filter-result" class="text-sm font-medium text-gray-700 mb-1">簽核結果篩選</label>
            <select id="filter-result" onchange="handleFilterChange(event)" data-filter-key="result" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-white min-w-[150px]">
                <option value="all">所有結果</option>
                <option value="待執行">待執行</option>
                <option value="pass">通過</option>
                <option value="fail">不通過</option>
            </select>
        </div>

        <button onclick="clearFilters()" class="w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">
            清除篩選
        </button>
    </div>
            <div id="historyTableContainer" class="overflow-x-auto">
                <p class="text-gray-500 p-4 text-center">請先登入以查看共享歷史記錄...</p>
            </div>
            <div id="historyStatus" class="mt-4 text-sm font-medium text-center text-gray-600"></div>
        </div>
        <!-- 底部提示 -->
        <footer class="p-6 sm:p-8 bg-gray-800 text-white text-center text-sm">
            <p>💡 提示：在每次設定或調整預算後，都必須執行此雙簽流程。</p>
        </footer>

    </div>

    <!-- 管理員後台 Modal -->
    <div id="adminPanel" class="hidden">
        <div class="admin-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">管理員後台 - 提升權限</h3>
            <p class="text-sm text-gray-600 mb-4">只有管理員 (${lsiaobai@gmail.com}) 可以看到此面板並設置其他用戶為管理者。</p>
            
            <div id="userListContainer" class="max-h-80 overflow-y-auto border p-3 rounded-lg bg-gray-50">
                <p class="text-center text-gray-500">載入用戶中...</p>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="closeAdminPanel()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    關閉
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- 非模組腳本區塊 (純粹的 UI 輔助功能) ---
        
        // Function to calculate the number of days between two dates (inclusive)
        function calculateDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) return 0;

            const diffTime = Math.abs(end.getTime() - start.getTime());
            
            // Convert to days (add 1 for inclusive count)
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return diffDays;
        }

        // Function to handle the budget calculation
        function calculateEstimatedBudget() {
            const form = document.getElementById('checklistForm');
            const budgetType = form.elements['adBudgetType'].value;
            // 使用執行設定的金額 (targetAmount)
            const dailyBudget = parseFloat(form.elements['targetAmount'].value); 
            // 使用執行設定的日期 (targetStartDate/targetEndDate)
            const startDate = form.elements['targetStartDate'].value;
            const endDate = form.elements['targetEndDate'].value;
            const resultEl = document.getElementById('calculatedResult');

            resultEl.className = 'text-lg font-semibold w-full text-center sm:text-left'; // Reset classes
            resultEl.classList.remove('text-red-600', 'text-green-700');

            if (budgetType !== '日預算 (Daily Budget)') {
                resultEl.textContent = '計算失敗：請選擇「日預算」類型進行計算。';
                resultEl.classList.add('text-red-600');
                return;
            }

            if (isNaN(dailyBudget) || dailyBudget <= 0) {
                resultEl.textContent = '計算失敗：請輸入有效的「廣告活動預算金額 (執行設定)」。';
                resultEl.classList.add('text-red-600');
                return;
            }

            const days = calculateDays(startDate, endDate);

            if (days <= 0) {
                resultEl.textContent = '計算失敗：請選擇有效的「投放期間」執行設定日期範圍 (開始日需早於或等於結束日)。';
                resultEl.classList.add('text-red-600');
                return;
            }

            const estimatedTotal = dailyBudget * days;
            
            const formattedTotal = estimatedTotal.toLocaleString('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });

            resultEl.textContent = `預估總花費（共 ${days} 天）：${formattedTotal}`;
            resultEl.classList.add('text-green-700');
        }

        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('calculateBudgetButton').addEventListener('click', calculateEstimatedBudget);
        });

        // 為了讓 Modal 可以從 HTML 內聯調用
        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

    </script>
    
    <!-- FIREBASE 核心功能 (驗證, 儲存, 權限控管) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            serverTimestamp,
            doc,
            setDoc,
            deleteDoc,
            getDocs,
            setLogLevel,
            query,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 設定 Firebase Debug Log
        setLogLevel('Debug');

        // --- FIREBASE CONFIGURATION ---
        // 請注意：這裡的配置應來自您的 Firebase 專案設定
        const userFirebaseConfig = {
            apiKey: "AIzaSyB7GaY2z3mKeD3bd9r_KVcd_VYMzz42c7c", 
            authDomain: "budgetcheck-7a2e9.firebaseapp.com",
            projectId: "budgetcheck-7a2e9",
            storageBucket: "budgetcheck-7a2e9.firebasestorage.app", 
            messagingSenderId: "1084663157523", 
            appId: "1:1084663157523:web:4e8160c5c3da30f92380e6", 
            measurementId: "G-81VM0XN7VC" 
        };
        // --- END CONFIGURATION ---

        // Global Firebase variables: 優先使用 Canvas 提供的設定，如果沒有則使用自定義設定
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        
        const configToUse = canvasFirebaseConfig || userFirebaseConfig;
        const finalAppId = canvasAppId || userFirebaseConfig.projectId || 'default-external-app-id';
        
        // --- 應用程式狀態 ---
        let app, db, auth;
        let currentUser = null; // Firebase User Object
        let userId = null;
        let userEmail = null;
        let isAdmin = false;
        let checklistData = []; 
        let editingId = null; 
        let editMode = 'new'; // 'new', 'edit_executor', 'edit_reviewer'
		let currentFilters = {
    executor: 'all',
    reviewer: 'all',
    result: 'all'
};
        // --- Firestore 路徑 ---
        const CHECKLIST_COLLECTION_PATH = `/artifacts/${finalAppId}/public/data/budget_checklists`;
        const USER_ROLES_COLLECTION_PATH = `/artifacts/${finalAppId}/public/data/user_roles`;
        
        // --- 管理者硬編碼郵箱 (預設管理者) ---
        // 確保使用小寫進行穩定的比較
        const DEFAULT_ADMIN_EMAIL = "lsiaobai@gmail.com".toLowerCase(); 

        // --- 欄位分類 ---
        const executorFields = [
            'clientName', 'date', 'platform', 'verificationType', 'accountNameId',
            'targetOriginalAccountBudget', 'targetAccountBudgetAfterTopUp', 
            'adBudgetType', 'targetAmount', 'targetStartDate', 'targetEndDate',
            'executor', 'notes'
        ];
        const reviewerFields = [
            'actualOriginalAccountBudget', 'actualAccountBudgetAfterTopUp', 
            'actualSet', 'actualStartDate', 'actualEndDate',
            'reviewer', 'result'
        ];

        // Utility function to show status messages
        function showStatus(message, type = 'info', targetId = 'statusMessage') {
            const status = document.getElementById(targetId);
            status.textContent = message;
            status.className = 'mt-4 p-3 rounded-lg text-center text-sm font-medium';
            status.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'text-gray-600');

            if (type === 'error') {
                status.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                status.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'info') {
                 status.classList.add('bg-blue-100', 'text-blue-700');
            } else {
                status.classList.add('text-gray-600');
            }
        }
        
        // --- 驗證與權限核心邏輯 ---
// 【新增：處理篩選器變更的函數】
function handleFilterChange(event) {
    const key = event.target.getAttribute('data-filter-key');
    const value = event.target.value;
    
    currentFilters[key] = value;
    
    // 重新渲染表格，應用新的篩選條件
    displayChecklistHistory(); 
}

// 【新增：清除所有篩選器的函數】
function clearFilters() {
    currentFilters = {
        executor: 'all',
        reviewer: 'all',
        result: 'all'
    };
    
    // 重設 HTML 選擇器的值
    // 請確保您的 HTML 元素 ID 與這裡一致
    document.getElementById('filter-executor').value = 'all';
    document.getElementById('filter-reviewer').value = 'all';
    document.getElementById('filter-result').value = 'all';
    
    // 重新渲染表格 (它會應用 currentFilters)
    displayChecklistHistory(); 
}

// 【新增：填充篩選器選項的函數】
function populateFilterOptions() {
    // 檢查元素是否存在
    const executorSelect = document.getElementById('filter-executor');
    const reviewerSelect = document.getElementById('filter-reviewer');
    if (!executorSelect || !reviewerSelect) return; 

    // 收集所有唯一的執行者 Email 和檢核者 Name
    // 必須使用 Set 確保唯一性
    const uniqueExecutors = new Set(checklistData.map(item => item.creatorEmail).filter(e => e));
    const uniqueReviewers = new Set(checklistData.map(item => item.reviewer).filter(r => r));

    // 清空舊選項 (保留 '所有...' 選項)
    executorSelect.innerHTML = '<option value="all">所有執行者</option>';
    reviewerSelect.innerHTML = '<option value="all">所有檢核者</option>';

    // 填充執行者選項
    uniqueExecutors.forEach(email => {
        // 使用 email 作為 value 和顯示文本
        executorSelect.innerHTML += `<option value="${email}">${email}</option>`;
    });

    // 填充檢核者選項
    uniqueReviewers.forEach(name => {
        // 使用 reviewer name 作為 value 和顯示文本
        reviewerSelect.innerHTML += `<option value="${name}">${name}</option>`;
    });
    
    // 重設篩選器為當前值
    executorSelect.value = currentFilters.executor;
    reviewerSelect.value = currentFilters.reviewer;
    document.getElementById('filter-result').value = currentFilters.result;
}
        async function googleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged 會處理後續的 UI 更新和資料載入
            } catch (error) {
                console.error("Google Sign-In Failed:", error);
                let errorMessage = `❌ Google 登入失敗: ${error.message}`;
                if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = `❌ Google 登入失敗: Firebase: Error (${error.code})。請至您的 Firebase Console -> Authentication -> Settings -> Authorized domains，將此應用程式的運行網域加入白名單。`;
                }
                showStatus(errorMessage, 'error', 'authStatus');
            }
        }

        async function googleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out Failed:", error);
            }
        }

        /**
         * 檢查用戶角色並儲存/更新到 Firestore
         */
        async function checkUserRole(user) {
            if (!db || !user) {
                isAdmin = false;
                return;
            }
            
            const roleDocRef = doc(db, USER_ROLES_COLLECTION_PATH, user.uid);
            
            // 確保 email 存在並轉換為小寫，以進行穩定的比較
            const lowerCaseEmail = user.email ? user.email.toLowerCase() : '';
            
            try {
                // 嘗試從 Firestore 獲取角色資訊
                const roleSnapshot = await getDocs(query(collection(db, USER_ROLES_COLLECTION_PATH))); 
                let foundRole = roleSnapshot.docs.find(d => d.id === user.uid)?.data();
                
                // 1. 檢查是否為預設管理者 (硬編碼)
                if (lowerCaseEmail === DEFAULT_ADMIN_EMAIL) {
                    isAdmin = true;
                    // 確保預設管理者在 user_roles 中有記錄且角色正確
                    if (!foundRole || foundRole.role !== 'admin' || foundRole.email.toLowerCase() !== lowerCaseEmail) {
                        await setDoc(roleDocRef, { 
                            email: user.email, 
                            role: 'admin',
                            lastLogin: serverTimestamp() 
                        }, { merge: true });
                    }
                } else if (foundRole) {
                    // 2. 檢查是否有已設定的角色
                    isAdmin = foundRole.role === 'admin';
                    // 更新登入時間
                     await setDoc(roleDocRef, { 
                        lastLogin: serverTimestamp() 
                    }, { merge: true });
                } else {
                    // 3. 預設為一般使用者 (並記錄)
                    isAdmin = false;
                    await setDoc(roleDocRef, { 
                        email: user.email, 
                        role: 'user',
                        lastLogin: serverTimestamp() 
                    }, { merge: true });
                }

                console.log(`User ${user.email} role: ${isAdmin ? 'Admin' : 'User'}`);
            } catch (e) {
                console.error("Error checking user role:", e);
                // 發生錯誤時，至少檢查是否為硬編碼管理者
                isAdmin = (lowerCaseEmail === DEFAULT_ADMIN_EMAIL); 
            }
        }

        /**
         * 處理身份驗證狀態改變
         */
        function handleAuthStateChange(user) {
            const authButton = document.getElementById('authButton');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const adminPanelButton = document.getElementById('adminPanelButton');
            
            currentUser = user;
            
            if (user) {
                userId = user.uid;
                // 修正 user.email 可能為 null 的問題，並確保用於顯示
                userEmail = user.email || '未提供 Email'; 
                
                // 清除登入錯誤提示
                showStatus('', 'info', 'authStatus');

                document.getElementById('loadingIndicator').classList.remove('hidden');

                // 檢查角色
                checkUserRole(user).then(() => {
                    // 更新 UI 狀態
                    authButton.textContent = '登出';
                    authButton.onclick = googleSignOut;
                    
                    // 修正 userEmail 顯示 null 的問題
                    userEmailDisplay.innerHTML = `**${userEmail}** (${isAdmin ? '管理者' : '一般用戶'})`;
                    document.getElementById('checklistForm').classList.remove('hidden');
                    
                    
                    document.querySelectorAll('#saveButton, #newRecordButton, #exportButton').forEach(btn => btn.disabled = false);

                    if (isAdmin) {
                        adminPanelButton.classList.remove('hidden');
                        adminPanelButton.onclick = openAdminPanel;
                    } else {
                         adminPanelButton.classList.add('hidden');
                    }
                    
                    loadChecklists(); // 登入後載入資料
                    document.getElementById('loadingIndicator').classList.add('hidden');

                }).catch(e => {
                    console.error("Role check failed:", e);
                    showStatus(`角色檢查失敗: ${e.message}。請檢查 Firestore 規則。`, 'error');
                    document.getElementById('loadingIndicator').classList.add('hidden');
                });

            } else {
                // 未登入狀態
                userId = null;
                userEmail = null;
                isAdmin = false;
                authButton.textContent = '登入 Google';
                authButton.onclick = googleSignIn;
                userEmailDisplay.innerHTML = '請登入 Google';
                document.getElementById('checklistForm').classList.add('hidden');
                document.getElementById('historyTableContainer').innerHTML = '<p class="text-gray-500 p-4 text-center">請先登入以查看共享歷史記錄...</p>';
                document.querySelectorAll('#saveButton, #newRecordButton, #exportButton').forEach(btn => btn.disabled = true);
                adminPanelButton.classList.add('hidden');
                document.getElementById('loadingIndicator').classList.add('hidden');
                showStatus("您已登出。", 'info');
            }
        }
        
        // --- 表單流程控制 ---

        /**
         * 根據當前模式 (新增/修改執行/檢核) 鎖定或解鎖欄位
         */
        function setFormMode(mode, currentCreatorId = null) {
            editMode = mode;
            const form = document.getElementById('checklistForm');
            const saveButton = document.getElementById('saveButton');
            const isCreator = currentCreatorId === userId;
            
            // 1. 執行人 (executor) 欄位控制
            form.querySelectorAll('.executor-field input, .executor-field select').forEach(el => {
                const isExecutorModifiable = (mode === 'new' || (mode === 'edit_executor' && isCreator));
                el.disabled = !isExecutorModifiable;
                // 新增資料或修改執行資料時，必填欄位才需要 required 屬性
                if (executorFields.includes(el.name) && ['clientName', 'date', 'accountNameId', 'executor'].includes(el.name)) {
                    el.required = (mode === 'new' || mode === 'edit_executor');
                }
            });

            // 2. 檢核人 (reviewer) 欄位控制
            form.querySelectorAll('.reviewer-field input, .reviewer-field select').forEach(el => {
                const isReviewerModifiable = (mode === 'edit_reviewer' && !isCreator);
                el.disabled = !isReviewerModifiable;
                // 檢核資料時，檢核人姓名和結果是必填
                if (el.name === 'reviewer' || el.name === 'result') {
                    el.required = mode === 'edit_reviewer';
                }
            });
            
            // 3. 基本資料欄位 (Creator only)
            // 這些欄位必須放在 executorFields 內進行統一控制
            form.elements['clientName'].disabled = (mode !== 'new' && !isCreator);
            form.elements['date'].disabled = (mode !== 'new' && !isCreator);
            form.elements['platform'].disabled = (mode !== 'new' && !isCreator);
            form.elements['verificationType'].disabled = (mode !== 'new' && !isCreator);
            form.elements['accountNameId'].disabled = (mode !== 'new' && !isCreator);

            // 4. 備註欄位 (Notes) - 兩邊都可以寫，所以統一解鎖
            form.elements['notes'].disabled = false;
            
            // 5. 更新按鈕文字
            if (mode === 'new') {
                document.getElementById('formTitle').textContent = "廣告活動與預算細節 (新增執行設定)";
                saveButton.textContent = "💾 儲存執行設定 (建立新紀錄)";
                saveButton.disabled = false;
            } else if (mode === 'edit_executor') {
                document.getElementById('formTitle').textContent = `廣告活動與預算細節 (修改執行設定)`;
                saveButton.textContent = "🔄 更新執行設定";
                saveButton.disabled = false;
            } else if (mode === 'edit_reviewer') {
                document.getElementById('formTitle').textContent = `廣告活動與預算細節 (進行檢核)`;
                saveButton.textContent = "✅ 儲存檢核結果";
                saveButton.disabled = false;
            }
        }

        // Reset the form and editing state
        function resetForm() {
            document.getElementById('checklistForm').reset();
            editingId = null;
            
            // 清空時間戳記顯示
            document.getElementById('executorTimeDisplay').textContent = 'N/A';
            document.getElementById('reviewerTimeDisplay').textContent = 'N/A';
            
            setFormMode('new'); // 切換回新增模式
            
            // Clear calculation result
            document.getElementById('calculatedResult').textContent = '（點擊按鈕進行計算）'; 
            document.getElementById('calculatedResult').classList.remove('text-red-600', 'text-green-700');
            showStatus("已清空表單，您可以新增一筆新資料。", 'info');
        }

        // Function to collect form data
        function collectFormData() {
            const form = document.getElementById('checklistForm');
            
            if (!form.checkValidity()) {
                showStatus("錯誤：請檢查並填寫所有標註星號的必填欄位。", 'error');
                return null;
            }
            
            let dataToSave = {};

            if (editMode === 'new') {
                // 新增模式：只收集 Executor 欄位 + 創建資訊
                dataToSave = {
                    ...executorFields.reduce((obj, key) => ({ ...obj, [key]: form.elements[key].value || '' }), {}),
                    createdByUserId: userId,
                    creatorEmail: userEmail,
                    executionTimestamp: serverTimestamp(), // 建立時即為執行時間
                    reviewTimestamp: null, // 檢核時間為空
                };
            } else if (editMode === 'edit_executor') {
                // 修改執行模式：只允許修改 Executor 欄位 + 更新時間
                dataToSave = {
                    ...executorFields.reduce((obj, key) => ({ ...obj, [key]: form.elements[key].value || '' }), {}),
                    // notes 已包含在 executorFields 內
                    executionTimestamp: serverTimestamp(), // 更新執行時間
                };
            } else if (editMode === 'edit_reviewer') {
                 // 修改檢核模式：只允許修改 Reviewer 欄位 + 更新時間
                dataToSave = {
                    // 必須包含所有 Reviewer 欄位
                    ...reviewerFields.reduce((obj, key) => ({ ...obj, [key]: form.elements[key].value || '' }), {}),
                    notes: form.elements['notes'].value, // 備註可修改
                    reviewer: form.elements['reviewer'].value, // 檢核人必填
                    result: form.elements['result'].value, // 結果必填
                    reviewTimestamp: serverTimestamp(), // 更新檢核時間
                };


	    	// 修正後的程式碼：已移除對「不通過」的儲存限制
		        /*
                // 檢核結果為「不通過」時阻止儲存 (前端提示)
                if (dataToSave.result === 'fail') {
                    showStatus("錯誤：核對結果為「不通過」，請先修正並將結果改為「通過」或在備註說明後再儲存。", 'error');
                    return null;
                }
		*/
            }
            
            return dataToSave;
        }

        // Save (Add or Update) to Firestore
        async function saveChecklist(event) {
            event.preventDefault(); 
            if (!db || !userId) {
                 showStatus("❌ 儲存失敗: 請先登入。", 'error');
                 return;
            }
            
            const data = collectFormData();
            if (!data) return;
            
            // 新增資料時，使用 addDoc (Firestore 自動產生 ID)
            const path = CHECKLIST_COLLECTION_PATH;
            const docRef = editingId ? doc(db, path, editingId) : collection(db, path);

            try {
                if (editingId) {
                    // Update existing document using setDoc (Firestore Rules will check permissions)
                    await setDoc(doc(db, path, editingId), data, { merge: true });
                    showStatus(`✅ 核對結果已成功更新 (${editMode})。`, 'success');
                } else {
                    // Add new document
                    await addDoc(docRef, data);
                    showStatus("✅ 執行設定已成功儲存並建立新紀錄。", 'success');
                }
                resetForm(); // Reset form after successful save/update
                
            } catch (e) {
                console.error("Error saving document: ", e);
                // 這裡會捕獲 'Missing or insufficient permissions.' 錯誤
                showStatus(`❌ 儲存失敗: ${e.message}。請檢查您的 Firestore 安全規則！`, 'error');
            }
        }

        // Load data using onSnapshot (and re-render the history table)
        function loadChecklists() {
            if (!db || !userId) return;
            const path = CHECKLIST_COLLECTION_PATH;
            const q = collection(db, path); 

            onSnapshot(q, (snapshot) => {
                checklistData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const formatTimestamp = (ts) => ts?.toDate()?.toLocaleString('zh-TW') || 'N/A';
                    return {
                        id: doc.id,
                        ...data,
                        executionTimestampDisplay: formatTimestamp(data.executionTimestamp),
                        reviewTimestampDisplay: formatTimestamp(data.reviewTimestamp),
                    };
                }).sort((a, b) => {
                    // 優先按執行時間倒序排列
                    const tsA = b.executionTimestampDisplay !== 'N/A' ? new Date(b.executionTimestampDisplay) : new Date(0);
                    const tsB = a.executionTimestampDisplay !== 'N/A' ? new Date(a.executionTimestampDisplay) : new Date(0);
                    return tsA - tsB;
                }); 

                showStatus(`💾 已載入 ${checklistData.length} 筆歷史核對記錄。`, 'info', 'historyStatus');
            	populateFilterOptions(); // <--- 新增此行
                displayChecklistHistory(); // <--- 請將您的 renderHistoryTable() 替換為 displayChecklistHistory()
            }, (error) => {
                console.error("Error listening to collection: ", error);
                showStatus(`❌ 載入歷史記錄失敗: ${error.message}。請檢查 Firestore 規則是否允許讀取。`, 'error', 'historyStatus');
            });
        }

        // Delete a record
        async function deleteChecklist(id) {
            if (!db || !isAdmin) {
                showStatus("❌ 刪除失敗: 只有管理者可以刪除資料。", 'error', 'historyStatus');
                return;
            }
            
            if (!confirm("確定要刪除這筆記錄嗎？此操作無法復原。")) return;
            
            const path = CHECKLIST_COLLECTION_PATH;
            const docRef = doc(db, path, id);
            
            try {
                // 執行刪除操作
                await deleteDoc(docRef);
                showStatus("🗑️ 記錄已成功刪除。", 'success', 'historyStatus');
                // onSnapshot 會自動更新列表，無需手動修改 checklistData
                if (editingId === id) {
                    resetForm();
                }
            } catch (e) {
                console.error("Error deleting document: ", e);
                // 捕獲刪除失敗的錯誤，可能是權限不足 (Missing or insufficient permissions)
                showStatus(`❌ 刪除失敗: ${e.message}。請檢查您的 Firestore 規則，確保管理者有 delete 權限。`, 'error', 'historyStatus');
            }
        }

        // Start editing/reviewing a record
        function startEditOrReview(id, mode) {
            const item = checklistData.find(d => d.id === id);
            if (!item) {
                showStatus(`找不到 ID 為 ${id} 的記錄。`, 'error');
                return;
            }
            
            const form = document.getElementById('checklistForm');
            // 1. 填充表單
            for (const key in item) {
                if (form.elements[key]) {
                    form.elements[key].value = item[key] || '';
                }
            }
            
            // 填充簽核時間
            document.getElementById('executorTimeDisplay').textContent = item.executionTimestampDisplay;
            document.getElementById('reviewerTimeDisplay').textContent = item.reviewTimestampDisplay;

            // 2. 更新編輯狀態
            editingId = id;
            setFormMode(mode, item.createdByUserId);

            // 3. 滾動到表單頂部
            document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });

            // 4. 重設計算結果
            document.getElementById('calculatedResult').textContent = '（點擊按鈕進行重新計算）'; 
            document.getElementById('calculatedResult').classList.remove('text-red-600', 'text-green-700');
        }

        // 【完整替換：包含篩選邏輯和表格渲染】
function displayChecklistHistory() {
    const tableContainer = document.getElementById('historyTableContainer');
    // 如果表格容器不存在，則結束
    if (!tableContainer) return;
    
    // 1. 執行篩選
    let filteredData = checklistData.filter(item => {
        // 執行者篩選 (使用 creatorEmail)
        const executorMatch = currentFilters.executor === 'all' || 
                              item.creatorEmail === currentFilters.executor;

        // 檢核者篩選 (使用 reviewer 姓名)
        const reviewerMatch = currentFilters.reviewer === 'all' || 
                              item.reviewer === currentFilters.reviewer;

        // 結果篩選 (使用 HTML option 的 value: pass/fail/待執行)
        const itemResultValue = item.result || '待執行'; // 確保未填寫時是 '待執行'

        const resultMatch = currentFilters.result === 'all' || 
                            currentFilters.result === itemResultValue; // 使用 pass/fail/待執行 進行匹配

        return executorMatch && reviewerMatch && resultMatch;
    });
    
    // 如果篩選結果為空
    if (filteredData.length === 0) {
        tableContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">沒有符合篩選條件的記錄。</p>';
        return;
    }
    
    // 2. 準備表格 HTML
    let tableHtml = `
        <table class="checklist-table w-full border-collapse rounded-xl overflow-hidden shadow-lg">
            <thead>
                <tr>
                    <th class="w-[5%]">ID</th>
                    <th class="w-[10%]">建立日期</th>
                    <th class="w-[15%]">客戶名稱</th>
                    <th class="w-[15%]">執行人 (Creator)</th>
                    <th class="w-[15%]">核對人 (Reviewer)</th>
                    <th class="w-[10%]">結果</th>
                    <th class="w-[20%]">動作</th>
                    <th class="w-[10%]">細節</th>
                </tr>
            </thead>
            <tbody id="checklist-table-body">
    `;

    // 3. 迴圈渲染篩選後的數據
    filteredData.forEach(item => {
        
        const isCreator = item.createdByUserId === userId;
        const isAdminOrCreator = isAdmin || isCreator;
        const statusClass = item.result === 'pass' ? 'bg-green-100 text-green-700' : 
                            item.result === 'fail' ? 'bg-red-100 text-red-700' : 
                            'bg-blue-100 text-blue-700';
        const resultText = item.result === 'pass' ? '✅ 通過' : 
                           item.result === 'fail' ? '❌ 不通過' : 
                           '📝 待執行';

        let actionButton;
        if (item.result === '待執行' || !item.result) { // 處理 result 為空或 '待執行' 的情況
            if (isCreator) {
                // 執行者：可以編輯或刪除自己的待執行記錄
                actionButton = `
                    <button onclick="startEditOrReview('${item.id}', 'edit_executor')" class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-medium py-1 px-3 rounded-full transition duration-150 mr-2">編輯</button>
                    <button onclick="deleteChecklist('${item.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-medium py-1 px-3 rounded-full transition duration-150">刪除</button>
                `;
            } else if (isAdmin || item.reviewer === 'N/A' || item.reviewerId === userId) {
                // 管理者或未被指定核對人或已被指定為核對人：可以進行核對
                actionButton = `<button onclick="startEditOrReview('${item.id}', 'edit_reviewer')" class="bg-green-500 hover:bg-green-600 text-white text-xs font-medium py-1 px-3 rounded-full transition duration-150">進行核對</button>`;
            } else {
                actionButton = '<span class="text-gray-500 text-xs">等待處理...</span>';
            }
        } else {
            // 已完成簽核的記錄 (pass/fail)，只有管理員可以刪除
            actionButton = isAdmin ? 
                `<button onclick="deleteChecklist('${item.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-medium py-1 px-3 rounded-full transition duration-150">刪除 (Admin)</button>` :
                '<span class="text-gray-500 text-xs">已完成</span>';
        }

        tableHtml += `
            <tr id="row-${item.id}">
                <td class="text-gray-500 text-xs">${item.id.substring(0, 4)}...</td>
                <td class="text-sm">${item.date}</td>
                <td class="font-medium text-gray-700">${item.clientName}</td>
                <td>${item.executor} (${item.creatorEmail || 'N/A'})</td>
                <td>${item.reviewer || 'N/A'}</td>
                <td><span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">${resultText}</span></td>
                <td>${actionButton}</td>
                <td><button onclick="showDetailModal('${item.id}')" class="text-indigo-600 hover:text-indigo-800 text-xs font-medium">查看</button></td>
            </tr>
        `;
    });

    tableHtml += `
            </tbody>
        </table>
    `;
    
    tableContainer.innerHTML = tableHtml;
}
        
        // --- 管理員後台功能 ---

        async function openAdminPanel() {
            if (!isAdmin) return;
            document.getElementById('adminPanel').style.display = 'flex';
            
            const userListContainer = document.getElementById('userListContainer');
            userListContainer.innerHTML = '<p class="text-center text-gray-500">載入用戶中...</p>';

            try {
                // 確保從最新的數據庫狀態獲取角色
                const q = collection(db, USER_ROLES_COLLECTION_PATH);
                const querySnapshot = await getDocs(q);
                
                let userListHtml = '';
                querySnapshot.forEach(docSnapshot => {
                    const docId = docSnapshot.id;
                    const userData = docSnapshot.data();
                    const currentIsAdminRole = userData.role === 'admin';
                    const isCurrentUser = docId === userId;
                    const userEmail = userData.email;
                    const isDefaultAdmin = userEmail && userEmail.toLowerCase() === DEFAULT_ADMIN_EMAIL.toLowerCase();

                    // 權限變更按鈕
                    const toggleButtonText = currentIsAdminRole ? '降級為一般用戶' : '升級為管理者';
                    const toggleButtonColor = currentIsAdminRole ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
                    let toggleButtonDisabled = isCurrentUser ? 'disabled' : ''; // 無法修改自己的權限
                    if (isDefaultAdmin && currentIsAdminRole) {
                        // 預設管理者無法被降級
                        toggleButtonDisabled = 'disabled';
                    }

                    const toggleButtonClass = toggleButtonDisabled ? 'opacity-50 cursor-not-allowed' : '';
                    const userRoleText = currentIsAdminRole ? '管理者' : '一般用戶';

                    // 移除角色記錄按鈕 (移除 Firestore 中的 user_roles 記錄)
                    const removeButton = !isCurrentUser && !isDefaultAdmin ? 
                        `<button onclick="window.removeUserRoleRecord('${docId}')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 text-xs font-bold py-1 px-2 rounded-lg transition duration-150 ml-2">移除記錄</button>` 
                        : '';

                    userListHtml += `
                        <div class="flex items-center justify-between p-3 border-b">
                            <div>
                                <p class="font-medium text-gray-900 break-all">${userData.email} 
                                    ${isDefaultAdmin ? '<span class="text-xs text-yellow-600">(預設管理員)</span>' : ''}
                                </p>
                                <p class="text-sm text-gray-500">ID: ${docId.substring(0, 8)}... (${userRoleText})</p>
                            </div>
                            <div class="flex items-center">
                                <button 
                                    id="roleBtn-${docId}"
                                    onclick="window.toggleUserRole('${docId}', '${currentIsAdminRole}')"
                                    class="${toggleButtonColor} text-white text-xs font-bold py-1 px-2 rounded-lg transition duration-150 ${toggleButtonClass}"
                                    ${toggleButtonDisabled}>
                                    ${isCurrentUser ? '自己的權限' : toggleButtonText}
                                </button>
                                ${removeButton}
                            </div>
                        </div>
                    `;
                });

                userListContainer.innerHTML = userListHtml || '<p class="text-center text-gray-500">目前沒有其他用戶記錄。</p>';

            } catch (e) {
                userListContainer.innerHTML = `<p class="text-red-500">載入用戶列表失敗: ${e.message}</p>`;
                console.error("Error loading user roles:", e);
            }
        }
        
        async function toggleUserRole(targetUserId, currentIsAdminString) {
            if (!isAdmin) return;
            
            const currentIsAdmin = currentIsAdminString === 'true';
            const newRole = currentIsAdmin ? 'user' : 'admin';
            const roleDocRef = doc(db, USER_ROLES_COLLECTION_PATH, targetUserId);

            try {
                // 確保無法降級預設管理者
                const targetUserData = (await getDocs(query(collection(db, USER_ROLES_COLLECTION_PATH)))).docs.find(d => d.id === targetUserId)?.data();
                const targetUserEmail = targetUserData?.email;
                if (targetUserData && targetUserEmail && targetUserEmail.toLowerCase() === DEFAULT_ADMIN_EMAIL.toLowerCase() && newRole === 'user') {
                     showStatus(`❌ 權限變更失敗: 無法將預設管理員降級。`, 'error', 'historyStatus');
                     return;
                }

                await setDoc(roleDocRef, { role: newRole }, { merge: true });
                showStatus(`✅ 用戶 ${targetUserId.substring(0, 8)}... 已成功設置為 ${newRole === 'admin' ? '管理者' : '一般用戶'}。`, 'success', 'historyStatus');
                openAdminPanel(); // 重新載入列表
            } catch (e) {
                showStatus(`❌ 權限變更失敗: ${e.message}`, 'error', 'historyStatus');
            }
        }

    async function removeUserRoleRecord(targetUserId) {
    // 檢查是否為管理員
            if (!isAdmin) return;

    // 1. 取得目標使用者資料
            const targetUserData = (await getDocs(query(collection(db, USER_ROLES_COLLECTION_PATH)))).docs.find(d => d.id === targetUserId)?.data();
    
    // 2. 安全地取出 email
            const targetUserEmail = targetUserData?.email; 

    // 確保無法移除自己的角色記錄
            if (targetUserId === userId) {
                showStatus(`❌ 移除記錄失敗: 無法移除自己的角色記錄。`, 'error', 'historyStatus');
                return;
    }
    
    // 3. 確保無法移除預設管理者的記錄 (已修正為安全檢查)
            if (targetUserEmail && targetUserEmail.toLowerCase() === DEFAULT_ADMIN_EMAIL.toLowerCase()) {
                showStatus(`❌ 移除記錄失敗: 無法移除預設管理員的角色記錄。`, 'error', 'historyStatus');
                return;
    }

            if (!confirm(`確定要移除用戶 ${targetUserId.substring(0, 8)}... 在 Firestore 中的角色記錄嗎？這將使他變回一般用戶。`)) return;

            const roleDocRef = doc(db, USER_ROLES_COLLECTION_PATH, targetUserId);

            try {
                await deleteDoc(roleDocRef);
                showStatus(`🗑️ 用戶 ${targetUserId.substring(0, 8)}... 的角色記錄已移除。`, 'success', 'historyStatus');
                openAdminPanel(); // 重新載入列表
    }         catch (e) {
                showStatus(`❌ 移除角色記錄失敗: ${e.message}`, 'error', 'historyStatus');
    }
}


        // --- 全域函數暴露 (供 HTML 內聯調用) ---
        window.startEditOrReview = startEditOrReview;
        window.deleteChecklist = deleteChecklist;
        window.resetForm = resetForm;
        window.toggleUserRole = toggleUserRole;
        window.removeUserRoleRecord = removeUserRoleRecord; // 新增移除功能
        window.closeAdminPanel = closeAdminPanel;
        
        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('loadingIndicator').classList.remove('hidden');

            try {
                app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                showStatus(`❌ 連線錯誤: ${e.message}。請檢查您的 Firebase 配置。`, 'error', 'loadingIndicator');
                return;
            }
            
            // 設定登入/登出監聽器
			// 【新增：在此處呼叫初始化函數，確保篩選器監聽器在頁面載入時綁定】
		///	initFilterListeners(); <--- 請新增此行
            onAuthStateChanged(auth, handleAuthStateChange);
            
            // 表單事件
            document.getElementById('checklistForm').addEventListener('submit', saveChecklist);
            document.getElementById('newRecordButton').addEventListener('click', () => { window.resetForm(); });
            document.getElementById('exportButton').addEventListener('click', exportToCSV);
            
            // 首次載入時，將表單設置為新增模式的預設狀態
            setFormMode('new'); 
        });
        
        // Export to CSV function (must be defined in module scope to access checklistData)
        function exportToCSV() {
            if (checklistData.length === 0) {
                showStatus("🚫 沒有可匯出的記錄。", 'error');
                return;
            }

            // 1. 定義 CSV 標頭 
            const headers = [
                "客戶名稱", "建立/修改日期", "廣告平台", "檢核類型", "帳號名稱/帳號ID", // 新欄位
                "原帳戶執行設定預算", "原帳戶檢核設定預算", "加值後執行設定預算", "加值後檢核設定預算", 
                "廣告預算類型", "廣告活動執行設定金額", "廣告活動檢核設定金額", 
                "執行設定開始日期", "執行設定結束日期", "檢核設定開始日期", "檢核設定結束日期", 
                "執行人", "核對人", "核對結果", "備註", 
                "最後執行時間", "最後檢核時間", // 新增時間戳記
                "建立者User ID", "建立者Email" // 新增創建者資訊
            ];
            
            // 2. Map data to header order
            const csvRows = [
                headers.join(',')
            ];

            checklistData.forEach(item => {
                const row = [
                    item.clientName, 
                    item.date, 
                    item.platform, 
                    item.verificationType, 
                    item.accountNameId, // 新欄位
                    item.targetOriginalAccountBudget, 
                    item.actualOriginalAccountBudget, 
                    item.targetAccountBudgetAfterTopUp, 
                    item.actualAccountBudgetAfterTopUp, 
                    item.adBudgetType, 
                    item.targetAmount, 
                    item.actualSet, 
                    item.targetStartDate || '', 
                    item.targetEndDate || '',   
                    item.actualStartDate || '', 
                    item.actualEndDate || '',   
                    item.executor, 
                    item.reviewer, 
                    item.result, 
                    `"${item.notes ? item.notes.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                    item.executionTimestampDisplay, // 執行時間
                    item.reviewTimestampDisplay, // 檢核時間
                    item.createdByUserId || 'N/A', 
                    item.creatorEmail || 'N/A'
                ];
                csvRows.push(row.map(cell => {
                    // 確保逗號被處理
                    let cellString = String(cell);
                    if (cellString.includes(',')) {
                        cellString = `"${cellString.replace(/"/g, '""')}"`;
                    }
                    return cellString;
                }).join(','));
            });

            const csvString = csvRows.join('\n');
            
            // 3. 建立 Blob 並下載 (加入 BOM 解決中文亂碼問題)
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'Budget_Checklist_Export_' + new Date().toISOString().slice(0, 10) + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus("⬇️ 歷史紀錄已匯出為 CSV 檔案。", 'success');
        }

    </script>
</body>
</html>





