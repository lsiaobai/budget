<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£å‘Šé ç®—æ ¸å°é›™ç°½è¡¨æ ¼ (å…±äº«æ­·å²ç´€éŒ„)</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥æ¨¡æ“¬ç¾ä»£ã€å°ˆæ¥­çš„è¨­è¨ˆæ„Ÿ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* è¼•å¾®çš„èƒŒæ™¯è‰² */
        }
        /* å®šç¾©è¡¨æ ¼çš„ç‰¹å®šæ¨£å¼ */
        .checklist-table th, .checklist-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist-table th {
            background-color: #eef2ff; /* æ·ºè—è‰²èƒŒæ™¯ï¼Œæ¨¡æ“¬ Canva çš„é…è‰² */
            color: #312e81; /* æ·±è—è‰²æ–‡å­— */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .checklist-table tr:hover {
            background-color: #f7fafc;
        }
        /* é‡å°æ—¥æœŸè¼¸å…¥æ¡†åšæ¨£å¼èª¿æ•´ */
        input[type="date"] {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* Highlight required fields with a special class */
        /* åƒ…é‡å°åŸ·è¡Œè¨­å®šï¼ˆéæª¢æ ¸è¨­å®šï¼‰æ‡‰ç”¨å¿…å¡«æ˜Ÿè™Ÿ */
        .is-required label::after, .is-required span.text-gray-700::after {
            content: " *";
            color: #ef4444; /* red-500 */
        }
        /* åƒ…é‡å°åŸ·è¡Œè¨­å®šï¼ˆéæª¢æ ¸è¨­å®šï¼‰çš„å¿…å¡«æ¬„ä½æ‡‰ç”¨ç´…è‰²é™°å½± */
        .input-group input:required:invalid:not([name*="actual"]):not([name="actualSet"]) {
             box-shadow: 0 0 0 1px #ef4444;
        }
        .input-group select:required:invalid:not([name*="actual"]):not([name="actualSet"]):not([name="result"]) {
             box-shadow: 0 0 0 1px #ef4444;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        
        <!-- æ¨™é¡Œå€å¡Š -->
        <header class="p-6 sm:p-8 bg-indigo-600 text-white">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-1">å»£å‘Šé ç®—æ ¸å°é›™ç°½è¡¨</h1>
            <p class="text-indigo-200 text-lg">Campaign Budget Verification Checklist (C-BVC)</p>
            <p class="mt-3 text-sm italic">æ­¤è¡¨å–®ç”¨æ–¼ç¢ºä¿æ‰€æœ‰é ç®—è¨­å®šç¶“éå…©å±¤æ¬¡æ ¸å°ï¼Œé˜²æ­¢è¶…æ”¯éŒ¯èª¤ã€‚**æ­·å²ç´€éŒ„ç‚ºæ‰€æœ‰ç”¨æˆ¶å…±äº«ã€‚**</p>
            <div id="userIdDisplay" class="mt-2 text-xs text-indigo-200 font-mono break-all">
                <span id="authStatus"></span>
            </div>
            <!-- Firebase å¤–éƒ¨éƒ¨ç½²æç¤º -->
            <div id="externalDeployAlert" class="mt-3 p-2 bg-yellow-400 text-gray-900 rounded-lg text-sm font-semibold hidden">
                âš ï¸ **è­¦å‘Š (GitHub éƒ¨ç½²):** Firebase é…ç½®éºå¤±ã€‚è«‹åœ¨ç¨‹å¼ç¢¼ä¸­æ›¿æ› `userFirebaseConfig` è®Šæ•¸ç‚ºæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé‡‘é‘°ï¼Œå¦å‰‡æ•¸æ“šå°‡ç„¡æ³•å„²å­˜ã€‚
            </div>
        </header>

        <!-- è¡¨å–®å…§å®¹ï¼šä½¿ç”¨ form æ¨™ç±¤ä»¥ä¾¿æ–¼é‡è¨­ -->
        <form id="checklistForm">
            <!-- åŸºæœ¬è³‡è¨Šå€å¡Š (Client Name & Date remain mandatory) -->
            <div class="p-6 sm:p-8 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">åŸºæœ¬è³‡æ–™</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-600">
                    <div class="flex flex-col">
                        <label class="font-medium text-sm mb-1">å®¢æˆ¶åç¨± (Client Name) <span class="text-red-500">*</span></label>
                        <input type="text" name="clientName" placeholder="è¼¸å…¥å®¢æˆ¶å…¨å" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label class="font-medium text-sm mb-1">å»ºç«‹/ä¿®æ”¹æ—¥æœŸ (Date) <span class="text-red-500">*</span></label>
                        <input type="date" name="date" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
            </div>

            <!-- é ç®—æ ¸å°è¡¨æ ¼ -->
            <div class="p-6 sm:p-8 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4" id="formTitle">å»£å‘Šæ´»å‹•èˆ‡é ç®—ç´°ç¯€</h2>
                
                <table class="checklist-table w-full border-collapse rounded-xl overflow-hidden">
                    <thead>
                        <tr>
                            <th class="w-1/4">æ¬„ä½é¡åˆ¥ (Category)</th>
                            <th class="w-1/4">è¨­å®šå…§å®¹ (Configuration)</th>
                            <th class="w-1/4">åŸ·è¡Œè¨­å®š (Executor Setting)</th> <!-- æ¨™é¡Œè®Šæ›´ -->
                            <th class="w-1/4">æª¢æ ¸è¨­å®š (Reviewer Setting)</th> <!-- æ¨™é¡Œè®Šæ›´ -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- å»£å‘Šå¹³å° -->
                        <tr>
                            <td class="font-medium text-gray-700">å»£å‘Šå¹³å°</td>
                            <td>
                                <select name="platform" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option>Meta Ads (Facebook/IG)</option>
                                    <option>Google Ads</option>
                                    <option>Line Ads</option>
                                    <option>TikTok Ads</option>
                                    <option>å…¶ä»–</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- æª¢æ ¸é¡å‹ (Control Field) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">æª¢æ ¸é¡å‹</td>
                            <td>
                                <select name="verificationType" id="verificationType" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                                    <option value="account_budget">å¸³æˆ¶é ç®— (Account Budget)</option>
                                    <option value="ad_budget">å»£å‘Šé ç®— (Ad Budget)</option>
                                    <option value="all">å…¨éƒ¨ (All)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- å»£å‘Šæ´»å‹•åç¨± -->
                        <tr>
                            <td class="font-medium text-gray-700">å»£å‘Šæ´»å‹•åç¨±</td>
                            <td>
                                <input type="text" name="campaignName" placeholder="è¼¸å…¥æ´»å‹•IDæˆ–åç¨±" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- åŸå¸³æˆ¶é ç®— -->
                        <tr id="row-targetOriginalAccountBudget">
                            <td class="font-medium text-gray-700">åŸå¸³æˆ¶é ç®—</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">é ç®—è®Šå‹•å‰çš„å€¼</label>
                            </td>
                            <td class="input-group">
                                <input type="number" name="targetOriginalAccountBudget" placeholder="åŸ·è¡Œé‡‘é¡" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group">
                                <input type="number" name="actualOriginalAccountBudget" placeholder="æª¢æ ¸å¯¦éš›å€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        <!-- åŠ å€¼å¾Œå¸³æˆ¶é ç®— -->
                        <tr id="row-targetAccountBudgetAfterTopUp">
                            <td class="font-medium text-gray-700">åŠ å€¼å¾Œå¸³æˆ¶é ç®—</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">é ç®—è®Šå‹•å¾Œçš„å€¼</label>
                            </td>
                            <td class="input-group">
                                <input type="number" name="targetAccountBudgetAfterTopUp" placeholder="åŸ·è¡Œé‡‘é¡" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group">
                                <input type="number" name="actualAccountBudgetAfterTopUp" placeholder="æª¢æ ¸å¯¦éš›å€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        <!-- å»£å‘Šé ç®—é¡å‹ -->
                        <tr id="row-adBudgetType">
                            <td class="font-medium text-gray-700">å»£å‘Šé ç®—é¡å‹</td>
                            <td class="input-group">
                                <select name="adBudgetType" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    <option>æ—¥é ç®— (Daily Budget)</option>
                                    <option>ç¸½é ç®— (Lifetime Budget)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">ï¼ˆé¸æ“‡é¡å‹å¾Œè«‹å¡«å¯«ï¼‰</td>
                        </tr>
                        <!-- é ç®—é‡‘é¡æ ¸å° -->
                        <tr id="row-targetAmount" class="bg-yellow-50/50">
                            <td class="font-bold text-indigo-700">å»£å‘Šæ´»å‹•é ç®—é‡‘é¡ (Budget)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">æœ€çµ‚è¨­å®šçš„é‡‘é¡</label>
                                <span class="text-gray-400 text-xs">ï¼ˆä»¥ç•¶åœ°è²¨å¹£è¨ˆåƒ¹ï¼‰</span>
                            </td>
                            <td class="input-group">
                                <input type="number" name="targetAmount" placeholder="åŸ·è¡Œæ•¸å€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-red-600 font-semibold">
                            </td>
                            <td class="input-group">
                                <input type="number" name="actualSet" placeholder="æª¢æ ¸è¨­å®šå€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-green-600 font-semibold">
                            </td>
                        </tr>
                        <!-- æŠ•æ”¾æœŸé–“ - é–‹å§‹æ—¥æœŸ (Start Date) -->
                        <tr id="row-targetStartDate1">
                            <td class="font-medium text-gray-700" rowspan="2">æŠ•æ”¾æœŸé–“ (Duration)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">é–‹å§‹æ—¥æœŸ (Start Date)</label>
                            </td>
                            <td class="input-group">
                                <label class="block text-xs text-gray-500 mb-1">åŸ·è¡Œè¨­å®š (Target)</label>
                                <input type="date" name="targetStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group">
                                <label class="block text-xs text-gray-500 mb-1">æª¢æ ¸è¨­å®š (Actual)</label>
                                <input type="date" name="actualStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                        <!-- æŠ•æ”¾æœŸé–“ - çµæŸæ—¥æœŸ (End Date) -->
                        <tr id="row-targetEndDate2">
                            <td>
                                <label class="block text-xs font-semibold mb-1">çµæŸæ—¥æœŸ (End Date)</label>
                            </td>
                            <td class="input-group">
                                <label class="block text-xs text-gray-500 mb-1">åŸ·è¡Œè¨­å®š (Target)</label>
                                <input type="date" name="targetEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group">
                                <label class="block text-xs text-gray-500 mb-1">æª¢æ ¸è¨­å®š (Actual)</label>
                                <input type="date" name="actualEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Budget Calculation Section -->
                <div class="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <button type="button" id="calculateBudgetButton" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            ğŸ§® è¨ˆç®—é ä¼°é ç®—èŠ±è²»
                        </button>
                        <div id="calculatedResult" class="text-lg font-semibold text-purple-800 w-full text-center sm:text-left">
                            ï¼ˆé»æ“ŠæŒ‰éˆ•é€²è¡Œè¨ˆç®—ï¼‰
                        </div>
                    </div>
                    <p class="text-xs text-purple-500 mt-2">åƒ…é©ç”¨æ–¼ã€Œæ—¥é ç®—ã€é¡å‹ï¼Œå°‡è¨ˆç®— [å»£å‘Šæ´»å‹•åŸ·è¡Œè¨­å®šé ç®—é‡‘é¡ * åŸ·è¡Œè¨­å®šæŠ•æ”¾æœŸé–“å¤©æ•¸] çš„ç¸½é ä¼°èŠ±è²»ã€‚</p>
                </div>
            </div>

            <!-- ç°½æ ¸å€å¡Š -->
            <div class="p-6 sm:p-8 bg-gray-50 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">é›™ç°½èˆ‡çµæœ</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- åŸ·è¡Œäººç°½å (Required) -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-indigo-300">
                        <label class="font-bold text-indigo-600 mb-2">åŸ·è¡Œäºº (Executor) ç°½æ ¸ <span class="text-red-500">*</span></label>
                        <p class="text-sm text-gray-500 mb-2">è¨­å®šé ç®—çš„ç¬¬ä¸€è²¬ä»»äººã€‚</p>
                        <input type="text" name="executor" id="executorInput" placeholder="è«‹è¼¸å…¥å§“å/å·¥è™Ÿç¢ºèª" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-indigo-500" required>
                        <div class="mt-3 text-xs text-gray-400">ç°½æ ¸æ™‚é–“: <span id="executorTime"></span></div>
                    </div>
                    
                    <!-- æ ¸å°äººç°½å (Optional) -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-green-500">
                        <label class="font-bold text-green-600 mb-2">æ ¸å°äºº (Reviewer) ç¨ç«‹ç¢ºèª</label>
                        <p class="text-sm text-gray-500 mb-2">ç¨ç«‹æ ¸å°ä¸¦ç¢ºèªè¨­å®šå€¼èˆ‡è¦æ±‚æ•¸å€¼ç›¸ç¬¦ã€‚</p>
                        <input type="text" name="reviewer" id="reviewerInput" placeholder="é¸å¡«ï¼šè«‹è¼¸å…¥å§“å/å·¥è™Ÿç¢ºèª" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-green-500">
                        <div class="mt-3 text-xs text-gray-400">ç°½æ ¸æ™‚é–“: <span id="reviewerTime"></span></div>
                    </div>
                </div>
                
                <!-- çµæœæ¬„ä½ (Optional) -->
                <div class="mt-6 p-4 bg-white rounded-lg shadow-md">
                    <label class="font-bold text-gray-800 mb-2 block">æœ€çµ‚æ ¸å°çµæœ</label>
                    <select name="result" id="resultSelect" class="p-3 border border-gray-300 rounded-lg w-full text-lg font-semibold text-center focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- è«‹é¸æ“‡ --</option>
                        <option value="pass">âœ… æ ¸å°é€šé (å¯é–‹å§‹æŠ•æ”¾)</option>
                        <option value="fail">âŒ æ ¸å°ä¸é€šé (å·²æš«åœ/éœ€ä¿®æ­£)</option>
                    </select>
                </div>
                
                <!-- å‚™è¨» -->
                <div class="mt-6">
                    <label for="notes" class="font-bold text-gray-800 mb-2 block">å‚™è¨»/ä¿®æ­£èªªæ˜</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="è«‹å¡«å¯«ä»»ä½•ç‰¹æ®Šæƒ…æ³æˆ–ä¿®æ­£éç¨‹ã€‚" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- å‹•ä½œæŒ‰éˆ• (æ–°å¢ "æ–°å¢è³‡æ–™" æŒ‰éˆ•) -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button type="submit" id="saveButton" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:bg-gray-400">
                        ğŸ’¾ å„²å­˜æ ¸å°çµæœ
                    </button>
                    <!-- æ–°å¢ä¸€ç­†æ–°è³‡æ–™æŒ‰éˆ•ï¼Œç¾åœ¨æœƒå‘¼å« window.resetForm ä¾†ç¢ºä¿ä½œç”¨åŸŸæ­£ç¢º -->
                    <button type="button" id="newRecordButton" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg">
                        â• æ–°å¢ä¸€ç­†æ–°è³‡æ–™
                    </button>
                    <button type="button" id="exportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:bg-gray-400">
                        â¬‡ï¸ åŒ¯å‡º Excel/CSV è¡¨å–®
                    </button>
                </div>

                <!-- ç‹€æ…‹è¨Šæ¯ -->
                <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center text-sm font-medium hidden"></div>

            </div>
        </form>
        
        <!-- æ­·å²è¨˜éŒ„å€å¡Š -->
        <div id="historySection" class="p-6 sm:p-8 bg-gray-100 border-t border-gray-300 mt-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">æ­·å²æ ¸å°è¨˜éŒ„ (æ‰€æœ‰ç”¨æˆ¶å…±äº«)</h2>
            <div id="historyTableContainer" class="overflow-x-auto">
                <p class="text-gray-500">æ­£åœ¨è¼‰å…¥æ­·å²è¨˜éŒ„...</p>
            </div>
            <div id="historyStatus" class="mt-4 text-sm font-medium text-center text-gray-600"></div>
        </div>
        <!-- åº•éƒ¨æç¤º -->
        <footer class="p-6 sm:p-8 bg-gray-800 text-white text-center text-sm">
            <p>ğŸ’¡ æç¤ºï¼šåœ¨æ¯æ¬¡è¨­å®šæˆ–èª¿æ•´é ç®—å¾Œï¼Œéƒ½å¿…é ˆåŸ·è¡Œæ­¤é›™ç°½æµç¨‹ã€‚</p>
        </footer>

    </div>

    <script>
        // JavaScript åƒ…ç”¨æ–¼è‡ªå‹•å¡«å¯«ç°½æ ¸æ™‚é–“ï¼ˆæ¨¡æ“¬é›»å­ç°½æ ¸çš„ä¸€éƒ¨åˆ†ï¼‰
        function updateTimeStamps() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            document.getElementById('executorTime').textContent = timeString;
            document.getElementById('reviewerTime').textContent = timeString;
        }
        
        // Function to calculate the number of days between two dates (inclusive)
        function calculateDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Check if end date is before start date
            if (start > end) return 0;

            // Calculate difference in milliseconds
            const diffTime = Math.abs(end.getTime() - start.getTime());
            
            // Convert to days (add 1 for inclusive count)
            // Use 1000 * 60 * 60 * 24 
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return diffDays;
        }

        // Function to handle the budget calculation
        function calculateEstimatedBudget() {
            const form = document.getElementById('checklistForm');
            const budgetType = form.elements['adBudgetType'].value;
            // ä½¿ç”¨åŸ·è¡Œè¨­å®šçš„é‡‘é¡ (targetAmount)
            const dailyBudget = parseFloat(form.elements['targetAmount'].value); 
            // ä½¿ç”¨åŸ·è¡Œè¨­å®šçš„æ—¥æœŸ (targetStartDate/targetEndDate)
            const startDate = form.elements['targetStartDate'].value;
            const endDate = form.elements['targetEndDate'].value;
            const resultEl = document.getElementById('calculatedResult');

            resultEl.className = 'text-lg font-semibold w-full text-center sm:text-left'; // Reset classes
            resultEl.classList.remove('text-red-600', 'text-green-700');

            if (budgetType !== 'æ—¥é ç®— (Daily Budget)') {
                resultEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼šè«‹é¸æ“‡ã€Œæ—¥é ç®—ã€é¡å‹é€²è¡Œè¨ˆç®—ã€‚';
                resultEl.classList.add('text-red-600');
                return;
            }

            if (isNaN(dailyBudget) || dailyBudget <= 0) {
                resultEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼šè«‹è¼¸å…¥æœ‰æ•ˆçš„ã€Œå»£å‘Šæ´»å‹•é ç®—é‡‘é¡ (åŸ·è¡Œè¨­å®š)ã€ã€‚';
                resultEl.classList.add('text-red-600');
                return;
            }

            const days = calculateDays(startDate, endDate);

            if (days <= 0) {
                resultEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼šè«‹é¸æ“‡æœ‰æ•ˆçš„ã€ŒæŠ•æ”¾æœŸé–“ã€åŸ·è¡Œè¨­å®šæ—¥æœŸç¯„åœ (é–‹å§‹æ—¥éœ€æ—©æ–¼æˆ–ç­‰æ–¼çµæŸæ—¥)ã€‚';
                resultEl.classList.add('text-red-600');
                return;
            }

            const estimatedTotal = dailyBudget * days;
            
            // Simple currency formatting 
            const formattedTotal = estimatedTotal.toLocaleString('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });

            resultEl.textContent = `é ä¼°ç¸½èŠ±è²»ï¼ˆå…± ${days} å¤©ï¼‰ï¼š${formattedTotal}`;
            resultEl.classList.add('text-green-700');
        }

        // ç‚ºäº†æ¨¡æ“¬ï¼Œæˆ‘å€‘åœ¨è¼‰å…¥æ™‚æ›´æ–°ä¸€æ¬¡æ™‚é–“
        updateTimeStamps();

        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('calculateBudgetButton').addEventListener('click', calculateEstimatedBudget);
             // æ³¨æ„ï¼šnewRecordButton çš„äº‹ä»¶ç›£è½å™¨å·²ç§»è‡³ type="module" å€å¡Šä»¥ç¢ºä¿å¯ä»¥èª¿ç”¨ resetForm
        });
    </script>
    
    <!-- FIREBASE å„²å­˜èˆ‡åŒ¯å‡ºåŠŸèƒ½ (å·²èª¿æ•´ç‚ºå…¬å…±/å…±äº«è·¯å¾‘) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            serverTimestamp,
            doc,
            setDoc,
            deleteDoc,
            setLogLevel,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è¨­å®š Firebase Debug Log
        setLogLevel('Debug');

        // --- CUSTOM FIREBASE CONFIGURATION (FOR EXTERNAL USE) ---
        // ğŸš¨ é€™æ˜¯ä¿®å¾©å¤–éƒ¨éƒ¨ç½²çš„é—œéµå€å¡Š ğŸš¨
        // å¦‚æœæ‚¨åœ¨ GitHub Pages ä¸Šé‹è¡Œæ­¤æª”æ¡ˆï¼Œè«‹å°‡æ‚¨è‡ªå·± Firebase å°ˆæ¡ˆçš„é…ç½®è²¼åˆ°ä¸‹æ–¹ã€‚
        // è«‹ç¢ºä¿æ‚¨å·²åœ¨è©²å°ˆæ¡ˆä¸­é–‹å•Ÿ Firestore å’Œ Authentication (åŒ¿åç™»å…¥)ã€‚
        const userFirebaseConfig = {
            apiKey: "AIzaSyB7GaY2z3mKeD3bd9r_KVcd_VYMzz42c7c", // <-- æ›¿æ›æˆæ‚¨çš„ API Key
            authDomain: "budgetcheck-7a2e9.firebaseapp.com", // <-- æ›¿æ›æˆæ‚¨çš„ Auth Domain
            projectId: "budgetcheck-7a2e9", // <-- æ›¿æ›æˆæ‚¨çš„ Project ID
            storageBucket: "budgetcheck-7a2e9.firebasestorage.app", // é¸å¡«
            messagingSenderId: "1084663157523", // é¸å¡«
            appId: "1:1084663157523:web:4e8160c5c3da30f92380e6", // é¸å¡«
            measurementId: "G-81VM0XN7VC" // é¸å¡«
        };
        // --- END CUSTOM FIREBASE CONFIGURATION ---

        // Global Firebase variables: å„ªå…ˆä½¿ç”¨ Canvas æä¾›çš„è¨­å®šï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨è‡ªå®šç¾©è¨­å®š
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const configToUse = canvasFirebaseConfig || userFirebaseConfig;
        
        // æ±ºå®šæœ€çµ‚ App ID (ç”¨æ–¼è³‡æ–™åº«è·¯å¾‘)
        const finalAppId = canvasAppId || userFirebaseConfig.projectId || 'default-external-app-id';

        let app = null;
        let db = null;
        let auth = null;
        let userId = 'N/A';
        let checklistData = []; 
        let editingId = null; 

        // æ ¸å¿ƒè®Šæ›´é»: ä½¿ç”¨å…¬å…±è·¯å¾‘ä»¥å¯¦ç¾å…±äº«æ­·å²ç´€éŒ„
        const PUBLIC_COLLECTION_PATH = `/artifacts/${finalAppId}/public/data/budget_checklists`;
        
        
        // Field groups for dynamic requirement setting
        const accountBudgetFields = [
            'targetOriginalAccountBudget', 'actualOriginalAccountBudget', 
            'targetAccountBudgetAfterTopUp', 'actualAccountBudgetAfterTopUp'
        ];
        
        const adBudgetFields = [
            'adBudgetType', 'targetAmount', 'actualSet', 
            'targetStartDate', 'targetEndDate', 'actualStartDate', 'actualEndDate'
        ];

        // Utility function to show status messages
        function showStatus(message, type = 'info', targetId = 'statusMessage') {
            const status = document.getElementById(targetId);
            status.textContent = message;
            status.className = 'mt-4 p-3 rounded-lg text-center text-sm font-medium';
            status.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'text-gray-600');

            if (type === 'error') {
                status.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                status.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'info') {
                 status.classList.add('bg-blue-100', 'text-blue-700');
            } else {
                status.classList.add('text-gray-600');
            }
        }
        
        /**
         * Dynamically sets the 'required' attribute on specified form elements and toggles the is-required class on their containers.
         */
        function setRequiredState(fieldNames, isRequired) {
            const form = document.getElementById('checklistForm');
            fieldNames.forEach(name => {
                const element = form.elements[name];
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºæª¢æ ¸è¨­å®šæ¬„ä½ (å¯¦éš›/è¨­å®šå€¼) æˆ–æœ€çµ‚çµæœæ¬„ä½ï¼Œé€™äº›æ¬„ä½ä¸éœ€è¦å¿…å¡«
                const isReviewerOrResultSetting = name.includes('actual') || name === 'actualSet' || name === 'result'; 
                
                if (element) {
                    if (isRequired && !isReviewerOrResultSetting) { 
                        element.setAttribute('required', 'required');
                    } else {
                        element.removeAttribute('required');
                    }
                    
                    // Toggle parent elements' is-required class for visual feedback
                    let parentRow = element.closest('tr');
                    let parentGroup = element.closest('.input-group');
                    
                    if (parentRow) {
                        const categoryCell = parentRow.querySelector('td:first-child');
                        // åƒ…å°ç›®æ¨™æ¬„ä½ (å³éæª¢æ ¸è¨­å®šæ¬„ä½) æ‡‰ç”¨è¦–è¦ºå¿…å¡«æ¨™è¨˜
                        if (categoryCell && !isReviewerOrResultSetting) {
                             categoryCell.classList.toggle('is-required', isRequired);
                        }
                    }
                    
                    if (parentGroup) {
                         // åƒ…å°ç›®æ¨™æ¬„ä½ (å³éæª¢æ ¸è¨­å®šæ¬„ä½) æ‡‰ç”¨è¦–è¦ºå¿…å¡«æ¨™è¨˜
                         if (!isReviewerOrResultSetting) {
                            parentGroup.classList.toggle('is-required', isRequired);
                         }
                    }
                }
            });
        }
        
        /**
         * Main function to handle conditional required fields based on verificationType.
         */
        function handleRequiredFields() {
            const verificationType = document.getElementById('verificationType').value;

            // 1. Reset all conditional fields to optional first
            setRequiredState(accountBudgetFields, false);
            setRequiredState(adBudgetFields, false);
            
            // 2. Apply new required states for 'target' fields
            if (verificationType === 'account_budget') {
                setRequiredState(accountBudgetFields, true);
            } else if (verificationType === 'ad_budget') {
                setRequiredState(adBudgetFields, true);
            } else if (verificationType === 'all') {
                setRequiredState(accountBudgetFields, true);
                setRequiredState(adBudgetFields, true);
            }
        }

        // Reset the form and editing state (Used by newRecordButton and after save)
        function resetForm() {
            document.getElementById('checklistForm').reset();
            document.getElementById('formTitle').textContent = "å»£å‘Šæ´»å‹•èˆ‡é ç®—ç´°ç¯€";
            document.getElementById('saveButton').textContent = "ğŸ’¾ å„²å­˜æ ¸å°çµæœ";
            editingId = null;
            
            handleRequiredFields();

            // Clear calculation result
            document.getElementById('calculatedResult').textContent = 'ï¼ˆé»æ“ŠæŒ‰éˆ•é€²è¡Œè¨ˆç®—ï¼‰'; 
            document.getElementById('calculatedResult').classList.remove('text-red-600', 'text-green-700');
            showStatus("å·²æ¸…ç©ºè¡¨å–®ï¼Œæ‚¨å¯ä»¥æ–°å¢ä¸€ç­†æ–°è³‡æ–™ã€‚", 'info');
        }

        // Function to collect form data
        function collectFormData() {
            const form = document.getElementById('checklistForm');
            
            // Native browser validation check before collecting data
            if (!form.checkValidity()) {
                showStatus("éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ä¸¦å¡«å¯«æ‰€æœ‰æ¨™è¨»æ˜Ÿè™Ÿçš„å¿…å¡«æ¬„ä½ (åƒ…åŸ·è¡Œè¨­å®šã€å®¢æˆ¶åç¨±èˆ‡æ—¥æœŸ)ã€‚", 'error');
                return null;
            }
            
            // ç¢ºä¿æ‰€æœ‰æ•¸æ“šè¢«æ”¶é›†ï¼Œå³ä½¿æ˜¯ç©ºå€¼ (æª¢æ ¸è¨­å®šæ¬„ä½èˆ‡æœ€çµ‚çµæœæ¬„ä½å¯èƒ½ç‚ºç©º)
            const data = {
                clientName: form.elements['clientName'].value,
                date: form.elements['date'].value,
                platform: form.elements['platform'].value,
                verificationType: form.elements['verificationType'].value, 
                campaignName: form.elements['campaignName'].value, 
                targetOriginalAccountBudget: form.elements['targetOriginalAccountBudget'].value, 
                actualOriginalAccountBudget: form.elements['actualOriginalAccountBudget'].value, 
                targetAccountBudgetAfterTopUp: form.elements['targetAccountBudgetAfterTopUp'].value, 
                actualAccountBudgetAfterTopUp: form.elements['actualAccountBudgetAfterTopUp'].value, 
                adBudgetType: form.elements['adBudgetType'].value, 
                targetAmount: form.elements['targetAmount'].value,
                actualSet: form.elements['actualSet'].value,
                targetStartDate: form.elements['targetStartDate'].value, 
                targetEndDate: form.elements['targetEndDate'].value,     
                actualStartDate: form.elements['actualStartDate'].value, 
                actualEndDate: form.elements['actualEndDate'].value,     
                executor: form.elements['executor'].value,
                reviewer: form.elements['reviewer'].value, 
                result: form.elements['result'].value, 
                notes: form.elements['notes'].value,
                createdAt: serverTimestamp(),
                // æ–°å¢æ¬„ä½ä¾†å„²å­˜å‰µå»ºæ­¤è¨˜éŒ„çš„ä½¿ç”¨è€… IDï¼Œç”¨æ–¼å…±äº«ç’°å¢ƒä¸‹çš„è¿½è¹¤
                createdByUserId: userId 
            };

            // Business logic check: If the user explicitly selects 'fail', we prevent saving.
            if (data.result === 'fail') {
                showStatus("éŒ¯èª¤ï¼šæ ¸å°çµæœç‚ºã€Œä¸é€šéã€ï¼Œè«‹å…ˆä¿®æ­£å¾Œå†å„²å­˜ã€‚", 'error');
                return null;
            }

            return data;
        }

        // Save (Add or Update) to Firestore
        async function saveChecklist(event) {
            event.preventDefault(); // Prevent default form submission
            if (!db) {
                 showStatus("âŒ å„²å­˜å¤±æ•—: Firebase å°šæœªåˆå§‹åŒ–ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firebase é…ç½®ã€‚", 'error');
                 return;
            }
            
            const data = collectFormData();
            if (!data) return;
            
            // ä½¿ç”¨å…¬å…±è·¯å¾‘ä»¥å…±äº«è³‡æ–™
            const path = PUBLIC_COLLECTION_PATH;
            const docRef = editingId ? doc(db, path, editingId) : collection(db, path);

            try {
                if (editingId) {
                    // Update existing document
                    await setDoc(docRef, data);
                    showStatus("âœ… æ ¸å°çµæœå·²æˆåŠŸæ›´æ–°ã€‚", 'success');
                } else {
                    // Add new document
                    await addDoc(docRef, data);
                    showStatus("âœ… æ ¸å°çµæœå·²æˆåŠŸå„²å­˜è‡³é›²ç«¯å…±äº«è¨˜éŒ„ã€‚", 'success');
                }
                resetForm(); // Reset form after successful save/update
                
            } catch (e) {
                console.error("Error saving document: ", e);
                showStatus(`âŒ å„²å­˜å¤±æ•—: ${e.message}`, 'error');
            }
        }

        // Load data using onSnapshot (and re-render the history table)
        function loadChecklists() {
            if (!db) return;
            // ä½¿ç”¨å…¬å…±è·¯å¾‘ä»¥å…±äº«è³‡æ–™
            const path = PUBLIC_COLLECTION_PATH;
            const q = collection(db, path); 

            onSnapshot(q, (snapshot) => {
                // å°‡è³‡æ–™å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸
                checklistData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate().toLocaleString('zh-TW') || 'N/A'
                    };
                }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // ä¾æ™‚é–“å€’åºæ’åˆ—

                showStatus(`ğŸ’¾ å·²è¼‰å…¥ ${checklistData.length} ç­†å…±äº«æ­·å²æ ¸å°è¨˜éŒ„ã€‚`, 'info', 'historyStatus');
                renderHistoryTable(); // è¼‰å…¥å¾Œæ¸²æŸ“è¡¨æ ¼
            }, (error) => {
                console.error("Error listening to collection: ", error);
                showStatus(`âŒ è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—: ${error.message}`, 'error', 'historyStatus');
            });
        }

        // Delete a record
        async function deleteChecklist(id) {
            if (!db) return;
            
            const confirmation = window.confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚"); // æš«æ™‚ä»£æ›¿ custom modal
            if (!confirmation) {
                return;
            }
            
            // ä½¿ç”¨å…¬å…±è·¯å¾‘
            const path = PUBLIC_COLLECTION_PATH;
            const docRef = doc(db, path, id);
            
            try {
                await deleteDoc(docRef);
                showStatus("ğŸ—‘ï¸ è¨˜éŒ„å·²åˆªé™¤ã€‚", 'success', 'historyStatus');
                // If the user was editing the deleted item, reset the form
                if (editingId === id) {
                    resetForm();
                }
            } catch (e) {
                console.error("Error deleting document: ", e);
                showStatus(`âŒ åˆªé™¤å¤±æ•—: ${e.message}`, 'error', 'historyStatus');
            }
        }

        // Start editing a record
        function startEdit(id) {
            const item = checklistData.find(d => d.id === id);
            if (!item) {
                showStatus(`æ‰¾ä¸åˆ° ID ç‚º ${id} çš„è¨˜éŒ„ã€‚`, 'error');
                return;
            }
            
            const form = document.getElementById('checklistForm');
            // 1. å¡«å……è¡¨å–®
            for (const key in item) {
                if (form.elements[key]) {
                    // ç¢ºä¿ç©ºå€¼ä¸æœƒè¦†è“‹ placeholderï¼Œä¸¦ä¸”æ‰€æœ‰æ¬„ä½éƒ½èƒ½è¢«å¡«å……
                    form.elements[key].value = item[key] || '';
                }
            }

            // 2. æ›´æ–°ç·¨è¼¯ç‹€æ…‹
            editingId = id;
            document.getElementById('formTitle').textContent = `å»£å‘Šæ´»å‹•èˆ‡é ç®—ç´°ç¯€ (æ­£åœ¨ç·¨è¼¯: ${item.clientName} - ${item.date})`;
            document.getElementById('saveButton').textContent = "ğŸ”„ æ›´æ–°æ ¸å°çµæœ";
            
            // 3. é‡æ–°é‹è¡Œå¿…å¡«æ¬„ä½é‚è¼¯ä»¥åŒ¹é…è¼‰å…¥çš„ç´€éŒ„
            handleRequiredFields();

            // 4. æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨
            document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });

            // 5. é‡è¨­è¨ˆç®—çµæœ
            document.getElementById('calculatedResult').textContent = 'ï¼ˆé»æ“ŠæŒ‰éˆ•é€²è¡Œé‡æ–°è¨ˆç®—ï¼‰'; 
            document.getElementById('calculatedResult').classList.remove('text-red-600', 'text-green-700');
        }

        // Render the history table
        function renderHistoryTable() {
            const container = document.getElementById('historyTableContainer');
            if (checklistData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-4 text-center">ç›®å‰æ²’æœ‰æ­·å²æ ¸å°è¨˜éŒ„ã€‚</p>';
                return;
            }

            let html = `
                <table class="w-full text-sm text-left text-gray-700 bg-white shadow-md rounded-lg overflow-hidden">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">å®¢æˆ¶ / æ´»å‹•åç¨±</th>
                            <th scope="col" class="px-6 py-3">æª¢æ ¸é¡å‹</th> 
                            <th scope="col" class="px-6 py-3">æœŸé–“ (åŸ·è¡Œè¨­å®š)</th>
                            <th scope="col" class="px-6 py-3">åŸ·è¡Œäºº</th> 
                            <th scope="col" class="px-6 py-3">å»ºç«‹è€… (User ID)</th>
                            <th scope="col" class="px-6 py-3">çµæœ</th>
                            <th scope="col" class="px-6 py-3">ç°½æ ¸æ™‚é–“</th>
                            <th scope="col" class="px-6 py-3">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            checklistData.forEach(item => {
                const statusClass = item.result === 'pass' ? 'text-green-600 bg-green-50' : (item.result === 'fail' ? 'text-red-600 bg-red-50' : 'text-gray-600 bg-gray-50');
                const statusText = item.result === 'pass' ? 'âœ… é€šé' : (item.result === 'fail' ? 'âŒ ä¸é€šé' : 'âšª å¾…ç¢ºèª');
                const duration = item.targetStartDate && item.targetEndDate 
                    ? `${item.targetStartDate.slice(5)} ~ ${item.targetEndDate.slice(5)}`
                    : 'æœªå¡«å¯«';

                let verificationTypeText;
                if (item.verificationType === 'account_budget') {
                    verificationTypeText = `å¸³æˆ¶é ç®—`;
                } else if (item.verificationType === 'ad_budget') {
                    verificationTypeText = `å»£å‘Šé ç®—`;
                } else if (item.verificationType === 'all') {
                    verificationTypeText = `å…¨éƒ¨`;
                } else {
                     verificationTypeText = `N/A`;
                }
                
                // é¡¯ç¤ºå»ºç«‹è€… User ID (æˆªå–å‰ 4 ä½ + å¾Œ 4 ä½)
                const creatorId = item.createdByUserId || 'N/A';
                const displayCreatorId = creatorId.length > 8 
                    ? `${creatorId.substring(0, 4)}...${creatorId.substring(creatorId.length - 4)}` 
                    : creatorId;

                html += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">
                            ${item.clientName}<br>
                            <span class="text-xs text-gray-500">${item.campaignName || 'N/A'}</span>
                        </td>
                        <td class="px-6 py-4">
                            ${verificationTypeText}<br>
                            <span class="font-bold text-xs text-gray-500">${item.adBudgetType.split(' ')[0] || 'N/A'}</span>
                        </td>
                        <td class="px-6 py-4">${duration}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${item.executor || 'N/A'}</td> 
                        <td class="px-6 py-4 text-xs font-mono text-gray-500" title="å®Œæ•´ ID: ${creatorId}">
                            ${displayCreatorId}
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-xs">${item.createdAt}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="window.startEdit('${item.id}')" class="text-indigo-600 hover:text-indigo-900 font-medium mr-3">ç·¨è¼¯</button>
                            <button onclick="window.deleteChecklist('${item.id}')" class="text-red-600 hover:text-red-900 font-medium">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            container.innerHTML = html;
        }

        // Export to CSV function 
        function exportToCSV() {
            if (checklistData.length === 0) {
                showStatus("ğŸš« æ²’æœ‰å¯åŒ¯å‡ºçš„è¨˜éŒ„ã€‚", 'error');
                return;
            }

            // 1. å®šç¾© CSV æ¨™é ­ 
            const headers = [
                "å®¢æˆ¶åç¨±", "å»ºç«‹/ä¿®æ”¹æ—¥æœŸ", "å»£å‘Šå¹³å°", "æª¢æ ¸é¡å‹", "å»£å‘Šæ´»å‹•åç¨±", 
                "åŸå¸³æˆ¶åŸ·è¡Œè¨­å®šé ç®—", "åŸå¸³æˆ¶æª¢æ ¸è¨­å®šé ç®—", "åŠ å€¼å¾ŒåŸ·è¡Œè¨­å®šé ç®—", "åŠ å€¼å¾Œæª¢æ ¸è¨­å®šé ç®—", 
                "å»£å‘Šé ç®—é¡å‹", "å»£å‘Šæ´»å‹•åŸ·è¡Œè¨­å®šé‡‘é¡", "å»£å‘Šæ´»å‹•æª¢æ ¸è¨­å®šé‡‘é¡", 
                "åŸ·è¡Œè¨­å®šé–‹å§‹æ—¥æœŸ", "åŸ·è¡Œè¨­å®šçµæŸæ—¥æœŸ", "æª¢æ ¸è¨­å®šé–‹å§‹æ—¥æœŸ", "æª¢æ ¸è¨­å®šçµæŸæ—¥æœŸ", 
                "åŸ·è¡Œäºº", "æ ¸å°äºº", "æ ¸å°çµæœ", "å‚™è¨»", "å„²å­˜æ™‚é–“", "å»ºç«‹è€…User ID" // æ–°å¢æ¬„ä½
            ];
            
            // 2. Map data to header order
            const csvRows = [
                headers.join(',')
            ];

            checklistData.forEach(item => {
                const row = [
                    item.clientName, 
                    item.date, 
                    item.platform, 
                    item.verificationType, 
                    item.campaignName, 
                    item.targetOriginalAccountBudget, 
                    item.actualOriginalAccountBudget, 
                    item.targetAccountBudgetAfterTopUp, 
                    item.actualAccountBudgetAfterTopUp, 
                    item.adBudgetType, 
                    item.targetAmount, 
                    item.actualSet, 
                    item.targetStartDate || '', 
                    item.targetEndDate || '',   
                    item.actualStartDate || '', 
                    item.actualEndDate || '',   
                    item.executor, 
                    item.reviewer, 
                    item.result, 
                    // è™•ç†å‚™è¨»æ¬„ä½ï¼šç”¨é›™å¼•è™ŸåŒ…ä½ä¸¦æ›¿æ›æ›è¡Œç¬¦è™Ÿ
                    `"${item.notes ? item.notes.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                    item.createdAt,
                    item.createdByUserId || 'N/A' // æ–°å¢ User ID
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            
            // 3. å»ºç«‹ Blob ä¸¦ä¸‹è¼‰ (åŠ å…¥ BOM è§£æ±ºä¸­æ–‡äº‚ç¢¼å•é¡Œ)
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'Budget_Checklist_Export_' + new Date().toISOString().slice(0, 10) + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus("â¬‡ï¸ æ­·å²ç´€éŒ„å·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆã€‚", 'success');
        }

        // Global function exposure for button clicks and history table interactions
        window.startEdit = startEdit;
        window.deleteChecklist = deleteChecklist;
        window.resetForm = resetForm;


        document.addEventListener('DOMContentLoaded', async () => {
            // æª¢æŸ¥ Firebase é…ç½®æ˜¯å¦è¶³å¤ 
            const isConfigSufficient = !!configToUse.apiKey && !!configToUse.projectId;
            
            if (!isConfigSufficient) {
                // å¦‚æœé…ç½®ä¸è¶³ï¼Œé¡¯ç¤ºè­¦å‘Šä¸¦åœæ­¢ Firebase åˆå§‹åŒ–
                document.getElementById('externalDeployAlert').classList.remove('hidden');
                document.getElementById('historyTableContainer').innerHTML = '<p class="text-red-500 p-4 text-center">ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«ï¼šè«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ Firebase å°ˆæ¡ˆé…ç½®ã€‚</p>';
                document.getElementById('saveButton').disabled = true;
                return;
            }

            // 1. Auth Setup and Get userId
            try {
                // åªæœ‰åœ¨é…ç½®è¶³å¤ æ™‚æ‰åˆå§‹åŒ–
                app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Firebase Initialization or Sign-in Failed:", e);
                document.getElementById('externalDeployAlert').textContent = `âŒ é€£ç·šéŒ¯èª¤: ${e.message}ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firebase é…ç½®æˆ–å®‰å…¨è¦å‰‡ã€‚`;
                document.getElementById('externalDeployAlert').classList.remove('hidden');
                document.getElementById('historyTableContainer').innerHTML = '<p class="text-red-500 p-4 text-center">é€£ç·šè‡³è³‡æ–™åº«å¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„é€£ç·šè¨­å®šå’Œç¶²è·¯ã€‚</p>';
                document.getElementById('saveButton').disabled = true;
                return;
            }


            // Get the current user ID after authentication
            if (auth.currentUser) {
                userId = auth.currentUser.uid;
                document.getElementById('authStatus').innerHTML = `**ç•¶å‰ç”¨æˆ¶ ID:** ${userId}`;
                document.getElementById('authStatus').classList.add('font-bold', 'text-yellow-300');
            } else {
                 userId = crypto.randomUUID();
                 document.getElementById('authStatus').innerHTML = `**åŒ¿åç”¨æˆ¶ ID:** ${userId}`;
            }

            // 2. Initial Setup
            handleRequiredFields(); // Run once on load
            loadChecklists(); // Start listening to the shared collection
            
            // 3. Add Event Listeners
            document.getElementById('checklistForm').addEventListener('submit', saveChecklist);
            document.getElementById('verificationType').addEventListener('change', handleRequiredFields);
            document.getElementById('newRecordButton').addEventListener('click', () => { window.resetForm(); });
            document.getElementById('exportButton').addEventListener('click', exportToCSV);
        });

    </script>
</body>
</html>
