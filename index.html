<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告預算核對雙簽表格 (Google 登入 & 權限控管)</title>
    <!-- 載入 Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體以模擬現代、專業的設計感 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* 輕微的背景色 */
        }
        /* 定義表格的特定樣式 */
        .checklist-table th, .checklist-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist-table th {
            background-color: #eef2ff; /* 淺藍色背景 */
            color: #312e81; /* 深藍色文字 */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .checklist-table tr:hover {
            background-color: #f7fafc;
        }
        /* 針對日期欄位設置固定寬度以保持整齊 */
        .date-col {
            width: 150px; 
        }
        /* 確保按鈕有足夠的觸控面積 */
        .action-button {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: transform 0.1s ease-in-out, background-color 0.1s;
        }
        .action-button:hover {
            transform: translateY(-1px);
        }
        .action-button:active {
            transform: translateY(0);
        }
        /* 彈出視窗樣式 */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); 
            padding-top: 50px;
        }
        .modal-content {
            background-color: #fff;
            margin: 5% auto; 
            padding: 24px;
            border-radius: 12px;
            width: 95%; 
            max-width: 900px; /* 增加寬度以容納雙欄 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // 應用程式初始化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // -------------------------------------------------------------
        // 全域狀態管理 (Global State Management)
        // -------------------------------------------------------------
        let currentUser = null; 
        let userRole = 'guest'; 
        let isAuthReady = false; 
        let checklistData = []; 
        // **!!! 必須更改為您的預設管理員 Email !!!**
        const defaultAdminEmail = 'lsiaobai@gmail.com'; 

        // 簡化路徑 (Simplified Paths - Essential for Firestore Rules)
        const BUDGET_CHECKLIST_COLLECTION = `artifacts/${appId}/public/data/budget_checklists`;
        const USER_ROLES_COLLECTION = `artifacts/${appId}/public/data/user_roles`;


        // -------------------------------------------------------------
        // 驗證與用戶狀態 (Authentication & User Status)
        // -------------------------------------------------------------

        /**
         * 檢查用戶角色並更新全域狀態
         * @param {string} uid 用戶 UID
         * @param {string} email 用戶 Email
         */
        async function checkUserRole(uid, email) {
            if (!uid) {
                userRole = 'guest';
                return;
            }

            try {
                // 1. 檢查是否為硬編碼的預設管理員
                if (email && email.toLowerCase() === defaultAdminEmail.toLowerCase()) {
                    userRole = 'admin';
                } else {
                    userRole = 'user'; // 預設為一般用戶
                }

                // 2. 檢查 Firestore 中的 user_roles 記錄
                const roleDocRef = doc(db, USER_ROLES_COLLECTION, uid);
                const roleSnapshot = await new Promise((resolve) => onSnapshot(roleDocRef, resolve));

                if (roleSnapshot.exists()) {
                    const roleData = roleSnapshot.data();
                    if (roleData.role === 'admin') {
                        userRole = 'admin';
                    } else if (roleData.role === 'user') {
                        // 保持 user
                    }
                } else {
                    // 如果用戶角色文檔不存在，則新增一個預設的文檔
                    const newRole = userRole; // 可能是 'admin' 或 'user'
                    await setDoc(roleDocRef, { 
                        role: newRole, 
                        email: email || 'N/A', 
                        uid: uid,
                        createdAt: new Date()
                    }, { merge: true });
                }

                // 3. 更新最後登入時間 (Last Login)
                await setDoc(roleDocRef, { lastLogin: new Date() }, { merge: true });

            } catch (error) {
                console.error("檢查/設定用戶角色失敗:", error);
                document.getElementById('admin-error').textContent = `載入用戶列表失敗: ${error.message}`;
                userRole = 'user'; 
            }
        }

        /**
         * 處理 Firebase 驗證狀態變更
         */
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            
            if (user) {
                await checkUserRole(user.uid, user.email || 'N/A');
                
                // 登入後更新 UI
                document.getElementById('auth-status').innerHTML = `<span class="font-bold">${user.email || 'N/A'}</span> (<span class="text-indigo-200">${userRole === 'admin' ? '管理員' : '一般用戶'}</span>)`;
                document.getElementById('login-button').classList.add('hidden');
                document.getElementById('logout-button').classList.remove('hidden');
                
                // 載入歷史紀錄 (確保在角色檢查之後執行)
                loadChecklists(); 
            } else {
                // 登出後重設狀態
                currentUser = null;
                userRole = 'guest';
                document.getElementById('auth-status').textContent = '請登入';
                document.getElementById('login-button').classList.remove('hidden');
                document.getElementById('logout-button').classList.add('hidden');
                document.getElementById('checklist-history-content').innerHTML = `<p class="text-center text-gray-500 py-10">請先登入以查看共享歷史記錄。</p>`;
            }
            
            // 每次狀態改變都要更新管理員按鈕
            renderUI();
            isAuthReady = true;
        });

        /**
         * 觸發 Google 登入
         */
        window.signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                // 嘗試開啟彈出視窗登入
                await signInWithPopup(auth, provider);
                document.getElementById('auth-error').classList.add('hidden');
            } catch (error) {
                console.error("Google 登入失敗:", error);
                
                // 強化錯誤訊息，提示用戶檢查彈出視窗阻擋器
                document.getElementById('auth-error').innerHTML = `
                    <span class="font-bold">❌ Google 登入失敗:</span> Firebase Error (${error.code || error.message}). 
                    <br>
                    <span class="text-yellow-100">
                    若登入按鈕點擊無反應，請檢查瀏覽器是否阻擋了彈出視窗 
                    <span class="font-extrabold">(Popup Blocker)</span> 
                    或 Firebase 專案設定中的 Authorized domains。
                    </span>
                `;
                document.getElementById('auth-error').classList.remove('hidden');
            }
        };

        /**
         * 登出
         */
        window.signOutUser = () => {
            signOut(auth);
            document.getElementById('auth-error').classList.add('hidden');
        };

        // -------------------------------------------------------------
        // 資料庫操作 (Database Operations)
        // -------------------------------------------------------------

        /**
         * 監聽並載入歷史紀錄
         */
        function loadChecklists() {
            if (!currentUser) return;

            const checklistRef = collection(db, BUDGET_CHECKLIST_COLLECTION);
            // 查詢，按照日期降序排序
            const q = query(checklistRef, orderBy("date", "desc"));

            // 監聽器
            onSnapshot(q, (snapshot) => {
                checklistData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    
                    // 確保 Timestamp 轉換
                    const executionTimestampDisplay = data.executionTimestamp ? new Date(data.executionTimestamp.toDate()).toLocaleString() : 'N/A';
                    const reviewTimestampDisplay = data.reviewTimestamp ? new Date(data.reviewTimestamp.toDate()).toLocaleString() : 'N/A';
                    
                    // 確保 date 欄位是日期物件以便後續的 date input 填入
                    const dateObj = data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : null);

                    return {
                        id: doc.id,
                        ...data,
                        // 將 date 欄位轉為 YYYY-MM-DD 格式，方便填入 form
                        date: dateObj ? dateObj.toISOString().split('T')[0] : '', 
                        targetStartDate: data.targetStartDate && data.targetStartDate.toDate ? data.targetStartDate.toDate().toISOString().split('T')[0] : (data.targetStartDate || ''),
                        targetEndDate: data.targetEndDate && data.targetEndDate.toDate ? data.targetEndDate.toDate().toISOString().split('T')[0] : (data.targetEndDate || ''),
                        actualStartDate: data.actualStartDate && data.actualStartDate.toDate ? data.actualStartDate.toDate().toISOString().split('T')[0] : (data.actualStartDate || ''),
                        actualEndDate: data.actualEndDate && data.actualEndDate.toDate ? data.actualEndDate.toDate().toISOString().split('T')[0] : (data.actualEndDate || ''),
                        executionTimestampDisplay,
                        reviewTimestampDisplay
                    };
                });
                renderChecklistHistory(checklistData);
                document.getElementById('history-error').classList.add('hidden');
            }, (error) => {
                console.error("載入歷史記錄失敗:", error);
                document.getElementById('history-error').textContent = `❌ 載入歷史記錄失敗: ${error.message}。請檢查 Firestore 規則是否允許讀取。`;
                document.getElementById('history-error').classList.remove('hidden');
            });
        }

        /**
         * 儲存或更新核對記錄
         * @param {Object} formData 表單資料
         * @param {string|null} docId 文件ID，如果為null則新增
         */
        async function saveChecklist(formData, docId = null) {
            if (!currentUser) {
                showToast('請先登入以執行操作。', 'error');
                return;
            }

            try {
                // 將 date 欄位轉換回 Firestore Timestamp (Date Object)
                const dataToSave = { ...formData };
                ['date', 'targetStartDate', 'targetEndDate', 'actualStartDate', 'actualEndDate'].forEach(key => {
                    if (dataToSave[key]) {
                        // 轉換為 Date 物件
                        dataToSave[key] = new Date(dataToSave[key]); 
                    } else {
                        dataToSave[key] = null;
                    }
                });

                if (docId) {
                    // 更新現有文件
                    const docRef = doc(db, BUDGET_CHECKLIST_COLLECTION, docId);
                    await updateDoc(docRef, dataToSave);
                    showToast('文件更新成功！', 'success');
                } else {
                    // 新增文件
                    const newDocRef = collection(db, BUDGET_CHECKLIST_COLLECTION);
                    const docToSave = {
                        ...dataToSave,
                        createdByUserId: currentUser.uid,
                        creatorEmail: currentUser.email,
                        reviewTimestamp: null // 新增時檢核時間為空
                    };
                    await addDoc(newDocRef, docToSave);
                    showToast('文件新增成功！', 'success');
                }
                
                closeModal('checklistModal'); // 儲存成功後關閉視窗

            } catch (error) {
                console.error("儲存失敗:", error);
                showToast(`❌ 儲存失敗: ${error.message}`, 'error');
            }
        }

        /**
         * 刪除核對記錄 (僅限管理員)
         * @param {string} docId 文件ID
         */
        window.deleteChecklist = async (docId) => {
            if (userRole !== 'admin') {
                showToast('只有管理員可以刪除記錄。', 'error');
                return;
            }
            
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            document.getElementById('confirmDeleteText').textContent = '確定要永久刪除此筆記錄嗎？此操作無法恢復。';
            confirmDeleteModal.style.display = 'block';

            document.getElementById('confirmDeleteBtn').onclick = async () => {
                confirmDeleteModal.style.display = 'none';
                try {
                    const docRef = doc(db, BUDGET_CHECKLIST_COLLECTION, docId);
                    await deleteDoc(docRef);
                    showToast('文件刪除成功！', 'success');
                } catch (error) {
                    console.error("刪除失敗:", error);
                    showToast(`刪除失敗: ${error.message}`, 'error');
                }
            };

            document.getElementById('cancelDeleteBtn').onclick = () => {
                confirmDeleteModal.style.display = 'none';
            };
        };

        // -------------------------------------------------------------
        // UI 渲染與互動 (UI Rendering & Interaction)
        // -------------------------------------------------------------
        
        /**
         * 顯示浮動提示訊息
         * @param {string} message 訊息內容
         * @param {'success'|'error'} type 訊息類型
         */
        function showToast(message, type) {
            const toast = document.getElementById('toastNotification');
            toast.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            
            if (type === 'success') {
                toast.classList.add('bg-green-500');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
            }

            // 顯示 toast
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 10); 

            // 隱藏 toast
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.classList.add('hidden'), 500); // 延遲隱藏
            }, 3000); 
        }

        /**
         * 渲染UI元素，例如管理員按鈕
         */
        function renderUI() {
            // 更新用戶狀態顯示
            const userEmail = currentUser ? currentUser.email || 'N/A' : 'N/A';
            const statusText = currentUser ? `<span class="font-bold">${userEmail}</span> (<span class="text-indigo-200">${userRole === 'admin' ? '管理員' : '一般用戶'}</span>)` : '請登入';
            document.getElementById('auth-status').innerHTML = statusText;

            // 顯示/隱藏管理員按鈕
            const adminButton = document.getElementById('admin-button');
            if (userRole === 'admin') {
                adminButton.classList.remove('hidden');
            } else {
                adminButton.classList.add('hidden');
            }
        }
        
        /**
         * 將歷史紀錄渲染到表格中
         * @param {Array<Object>} data 歷史紀錄陣列
         */
        function renderChecklistHistory(data) {
            const historyTableBody = document.getElementById('history-table-body');
            historyTableBody.innerHTML = '';
            
            if (data.length === 0) {
                document.getElementById('checklist-history-content').innerHTML = `<p class="text-center text-gray-500 py-10">尚無歷史記錄。</p>`;
                return;
            } else {
                // 如果有數據，則確保表格內容是可見的
                document.getElementById('checklist-history-content').innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full checklist-table">
                            <thead>
                                <tr>
                                    <th>帳號名稱/ID</th>
                                    <th class="date-col">日期</th>
                                    <th>平台</th>
                                    <th>目標金額</th>
                                    <th>檢核結果</th>
                                    <th>執行人 Email</th>
                                    <th>檢核時間</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body-actual">
                            </tbody>
                        </table>
                    </div>
                `;
                const actualBody = document.getElementById('history-table-body-actual');
                actualBody.innerHTML = '';

                data.forEach(item => {
                    const isCreator = currentUser && item.createdByUserId === currentUser.uid;
                    const isLoggedIn = currentUser !== null;
                    
                    // 決定操作按鈕
                    let actionButton;
                    if (!isLoggedIn) {
                        actionButton = `
                            <button onclick="window.openEditModal('${item.id}', 'view')" 
                                    class="action-button bg-gray-500 hover:bg-gray-600 text-white shadow-md">
                                查看
                            </button>
                        `;
                    } else if (isCreator) {
                        actionButton = `
                            <button onclick="window.openEditModal('${item.id}', 'executor')" 
                                    class="action-button bg-blue-500 hover:bg-blue-600 text-white shadow-md">
                                修改 (執行)
                            </button>
                        `;
                    } else {
                        actionButton = `
                            <button onclick="window.openEditModal('${item.id}', 'reviewer')" 
                                    class="action-button bg-green-500 hover:bg-green-600 text-white shadow-md">
                                檢核
                            </button>
                        `;
                    }
                    
                    // 決定刪除按鈕
                    const deleteButton = (userRole === 'admin') ? `
                        <button onclick="window.deleteChecklist('${item.id}')" 
                                class="action-button bg-red-500 hover:bg-red-600 text-white ml-2 shadow-md">
                            刪除
                        </button>
                    ` : '';

                    // 判斷檢核結果的顏色
                    const resultColor = item.result === '通過' ? 'bg-green-100 text-green-800' : 
                                        item.result === '不通過' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';

                    const row = `
                        <tr class="hover:bg-gray-50 transition duration-150">
                            <td class="font-medium">${item.accountNameId || 'N/A'}</td>
                            <td class="date-col">${item.date || 'N/A'}</td>
                            <td>${item.platform || 'N/A'}</td>
                            <td class="font-semibold">NT$ ${item.targetAmount ? item.targetAmount.toLocaleString() : 'N/A'}</td>
                            <td>
                                <span class="px-3 py-1 text-xs font-semibold rounded-full ${resultColor}">${item.result || '待檢核'}</span>
                            </td>
                            <td>${item.creatorEmail || 'N/A'}</td>
                            <td>${item.reviewTimestampDisplay}</td>
                            <td class="flex flex-wrap space-x-2">
                                ${actionButton}
                                ${deleteButton}
                            </td>
                        </tr>
                    `;
                    actualBody.innerHTML += row;
                });
            }
        }
        
        /**
         * 打開編輯/檢核/查看 modal
         * @param {string|null} docId 編輯的文件ID，null表示新增
         * @param {string} mode 'new', 'executor', 'reviewer', 'view'
         */
        window.openEditModal = (docId = null, mode = 'new') => {
            // ** 關鍵安全檢查：未登入者只能查看，不能新增或編輯 **
            if (!currentUser && mode !== 'view') {
                showToast('請先登入才能新增或編輯資料。', 'error');
                return; // 直接返回，不執行開啟 modal 的程式碼
            }

            const modal = document.getElementById('checklistModal');
            const form = document.getElementById('modalChecklistForm');
            const saveButton = document.getElementById('modalSaveBtn');

            // 1. 重置表單
            form.reset();
            document.getElementById('docIdFieldModal').value = docId || ''; // 隱藏欄位 for docId
            document.getElementById('modal-error').classList.add('hidden');
            
            // 2. 載入資料 (如果 docId 存在)
            let item = {};
            if (docId) {
                item = checklistData.find(d => d.id === docId) || {};
                Object.keys(item).forEach(key => {
                    const input = form.elements[key];
                    if (input) {
                        input.value = item[key] || '';
                    }
                });
            }

            // 3. 根據模式設定標題、欄位狀態和儲存事件
            const leftInputs = form.querySelectorAll('[data-group="executor"]');
            const rightInputs = form.querySelectorAll('[data-group="reviewer"]');
            let currentTimestampField = '';
            
            if (mode === 'new') {
                document.getElementById('modalTitle').textContent = '新增核對資料 (執行設定)';
                leftInputs.forEach(input => input.disabled = false);
                rightInputs.forEach(input => input.disabled = true);
                saveButton.textContent = '儲存新的執行設定';
                saveButton.classList.remove('hidden');
                currentTimestampField = 'executionTimestamp';
            } else if (mode === 'executor') {
                document.getElementById('modalTitle').textContent = '修改紀錄 (執行設定)';
                leftInputs.forEach(input => input.disabled = false);
                rightInputs.forEach(input => input.disabled = true);
                saveButton.textContent = '更新執行設定';
                saveButton.classList.remove('hidden');
                currentTimestampField = 'executionTimestamp';
            } else if (mode === 'reviewer') {
                document.getElementById('modalTitle').textContent = '檢核紀錄 (檢核設定)';
                leftInputs.forEach(input => input.disabled = true);
                rightInputs.forEach(input => input.disabled = false);
                saveButton.textContent = '確認並更新檢核結果';
                saveButton.classList.remove('hidden');
                currentTimestampField = 'reviewTimestamp';
            } else if (mode === 'view') {
                document.getElementById('modalTitle').textContent = '查看紀錄';
                leftInputs.forEach(input => input.disabled = true);
                rightInputs.forEach(input => input.disabled = true);
                saveButton.classList.add('hidden');
            }

            // 4. 設定儲存按鈕的點擊事件
            saveButton.onclick = async (e) => {
                e.preventDefault();
                
                const data = new FormData(form);
                let formData = {};
                for (const [key, value] of data.entries()) {
                    if (value === '') {
                        formData[key] = null;
                    } else if (key.includes('Budget') || key === 'targetAmount') {
                        formData[key] = parseFloat(value) || 0;
                    } else {
                        formData[key] = value;
                    }
                }
                
                // 只有在可編輯模式下才更新時間戳記
                if (mode !== 'view') {
                    formData[currentTimestampField] = new Date();
                }

                try {
                    // 根據模式只傳送允許更新的欄位 (確保只改動自己有權限的欄位)
                    let updates = {};
                    const allKeys = Object.keys(formData);
                    
                    // 定義左側和右側的欄位列表
                    const executorKeys = ['clientName', 'date', 'platform', 'verificationType', 'accountNameId', 
                                          'targetOriginalAccountBudget', 'targetAccountBudgetAfterTopUp', 
                                          'adBudgetType', 'targetAmount', 'targetStartDate', 'targetEndDate',
                                          'executor', 'notes', 'executionTimestamp'];
                    const reviewerKeys = ['actualOriginalAccountBudget', 'actualAccountBudgetAfterTopUp', 
                                          'actualSet', 'actualStartDate', 'actualEndDate',
                                          'reviewer', 'result', 'notes', 'reviewTimestamp'];

                    if (mode === 'executor' || mode === 'new') {
                        executorKeys.forEach(key => {
                            if (allKeys.includes(key)) updates[key] = formData[key];
                        });
                        // 備註是通用欄位，可以一起更新
                        updates.notes = formData.notes;
                    } 
                    
                    if (mode === 'reviewer') {
                        reviewerKeys.forEach(key => {
                            if (allKeys.includes(key)) updates[key] = formData[key];
                        });
                        // 備註是通用欄位，可以一起更新
                        updates.notes = formData.notes;
                    }
                    
                    // 新增模式需要所有欄位
                    if (mode === 'new') {
                        updates = formData;
                    }
                    
                    await saveChecklist(updates, docId);

                } catch (error) {
                    console.error("儲存表單資料失敗:", error);
                    document.getElementById('modal-error').textContent = `❌ 儲存失敗: ${error.message}`;
                    document.getElementById('modal-error').classList.remove('hidden');
                }
            };

            // ** 開啟 Modal **
            modal.style.display = 'block';
        };

        /**
         * 關閉任一 modal
         * @param {string} modalId 視窗 ID
         */
        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        // -------------------------------------------------------------
        // 管理員後台 (Admin Panel)
        // -------------------------------------------------------------

        /**
         * 打開管理員面板
         */
        window.openAdminPanel = async () => {
            if (userRole !== 'admin') return;

            const adminModal = document.getElementById('adminModal');
            const userListBody = document.getElementById('userListBody');
            userListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">載入中...</td></tr>';
            
            try {
                // 載入 user_roles 集合中的所有用戶
                const userRef = collection(db, USER_ROLES_COLLECTION);
                const q = query(userRef, orderBy("email", "asc"));

                const snapshot = await new Promise((resolve) => onSnapshot(q, resolve));

                userListBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const isDefaultAdmin = userData.email && userData.email.toLowerCase() === defaultAdminEmail.toLowerCase();
                    
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2">${userData.email || 'N/A'}</td>
                            <td class="px-4 py-2 text-xs truncate">${userData.uid}</td>
                            <td class="px-4 py-2">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full ${userData.role === 'admin' ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-800'}">
                                    ${userData.role === 'admin' ? '管理員' : '一般用戶'}
                                </span>
                            </td>
                            <td class="px-4 py-2">
                                ${isDefaultAdmin ? '<span class="text-sm text-gray-500">預設管理員</span>' : 
                                    (userData.role === 'admin' ? 
                                        `<button onclick="window.removeAdminRole('${userData.uid}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 text-xs rounded-lg shadow-md">
                                            移除管理員
                                        </button>` 
                                    : 
                                        `<button onclick="window.grantAdminRole('${userData.uid}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 text-xs rounded-lg shadow-md">
                                            提升為管理員
                                        </button>`)
                                }
                            </td>
                        </tr>
                    `;
                    userListBody.innerHTML += row;
                });
                
                document.getElementById('admin-error').classList.add('hidden');
            } catch (error) {
                console.error("載入管理員後台資料失敗:", error);
                document.getElementById('admin-error').textContent = `❌ 載入用戶列表失敗: ${error.message}`;
                document.getElementById('admin-error').classList.remove('hidden');
            }

            adminModal.style.display = 'block';
        };

        /**
         * 提升用戶為管理員
         * @param {string} uid 用戶 UID
         */
        window.grantAdminRole = async (uid) => {
            if (userRole !== 'admin') return;
            try {
                const docRef = doc(db, USER_ROLES_COLLECTION, uid);
                await updateDoc(docRef, { role: 'admin' });
                showToast('用戶已提升為管理員。', 'success');
                window.openAdminPanel(); // 重新載入面板
            } catch (error) {
                showToast(`提升權限失敗: ${error.message}`, 'error');
                console.error("提升權限失敗:", error);
            }
        };

        /**
         * 移除用戶的管理員角色 (降級為一般用戶)
         * @param {string} uid 用戶 UID
         */
        window.removeAdminRole = async (uid) => {
            if (userRole !== 'admin') return;
            try {
                const docRef = doc(db, USER_ROLES_COLLECTION, uid);
                await updateDoc(docRef, { role: 'user' });
                showToast('用戶權限已降級為一般用戶。', 'success');
                window.openAdminPanel(); // 重新載入面板
            } catch (error) {
                showToast(`降級權限失敗: ${error.message}`, 'error');
                console.error("降級權限失敗:", error);
            }
        };

        // -------------------------------------------------------------
        // 資料匯出 (Data Export)
        // -------------------------------------------------------------

        /**
         * 將歷史紀錄匯出為 CSV 檔案
         */
        window.exportToCSV = () => {
            if (checklistData.length === 0) {
                showToast('沒有數據可以匯出。', 'error');
                return;
            }

            // 1. 定義 CSV 標頭
            const headers = [
                '客戶名稱', '日期', '平台', '檢核項目', '帳號名稱/帳號ID', 
                '目標 - 原始帳戶預算', '目標 - 儲值後帳戶預算', '廣告預算類型', '目標 - 儲值金額', 
                '目標 - 預計起始日', '目標 - 預計結束日', '執行人', 
                '實際 - 原始帳戶預算', '實際 - 儲值後帳戶預算', '實際 - 儲值是否成功', 
                '實際 - 起始日', '實際 - 結束日', '檢核人', '檢核結果', '備註/修正說明', 
                '執行時間', '檢核時間', '建立者UID', '建立者Email'
            ];
            const csvRows = [headers.join(',')];

            // 2. 處理數據行
            checklistData.forEach(item => {
                const row = [
                    item.clientName,
                    item.date, // 已經是 YYYY-MM-DD 格式
                    item.platform,
                    item.verificationType,
                    item.accountNameId,
                    item.targetOriginalAccountBudget || 0,
                    item.targetAccountBudgetAfterTopUp || 0,
                    item.adBudgetType,
                    item.targetAmount || 0,
                    item.targetStartDate, // 已經是 YYYY-MM-DD 格式
                    item.targetEndDate,   // 已經是 YYYY-MM-DD 格式
                    item.executor,
                    item.actualOriginalAccountBudget || 0,
                    item.actualAccountBudgetAfterTopUp || 0,
                    item.actualSet,
                    item.actualStartDate, // 已經是 YYYY-MM-DD 格式
                    item.actualEndDate,   // 已經是 YYYY-MM-DD 格式
                    item.reviewer,
                    item.result,
                    // 處理備註中的換行符和逗號
                    `"${item.notes ? item.notes.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                    item.executionTimestampDisplay, // 執行時間
                    item.reviewTimestampDisplay, // 檢核時間
                    item.createdByUserId || 'N/A', 
                    item.creatorEmail || 'N/A'
                ];
                csvRows.push(row.map(cell => {
                    // 確保包含逗號的單元格被引號包圍
                    let cellString = String(cell);
                    if (cellString.includes(',') && !cellString.startsWith('"')) {
                        cellString = `"${cellString.replace(/"/g, '""')}"`;
                    }
                    return cellString;
                }).join(','));
            });

            const csvString = csvRows.join('\n');
            
            // 3. 建立 Blob 並下載 (加入 BOM 解決中文亂碼問題)
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'Budget_Checklist_Export_' + new Date().toISOString().slice(0, 10) + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };
    </script>

    <!-- 頂部標題和驗證狀態 -->
    <header class="bg-indigo-600 text-white p-6 rounded-t-xl shadow-lg mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <h1 class="text-3xl font-bold mb-2 sm:mb-0">廣告預算核對雙簽表</h1>
            <div class="flex items-center space-x-3">
                <span id="auth-status" class="text-sm italic">請登入</span>
                <!-- 登入按鈕修正為顯示狀態 -->
                <button id="login-button" onclick="signInWithGoogle()" 
                        class="bg-white text-indigo-600 px-4 py-2 rounded-full font-semibold shadow-md hover:bg-gray-100 transition duration-150">
                    登入 Google
                </button>
                <button id="logout-button" onclick="signOutUser()" 
                        class="bg-white text-red-600 px-4 py-2 rounded-full font-semibold shadow-md hover:bg-red-100 transition duration-150 hidden">
                    登出
                </button>
            </div>
        </div>
        <p class="text-indigo-200 mt-1">Campaign Budget Verification Checklist (C-BVC) - 權限管控版</p>
        <!-- 強化錯誤訊息顯示區塊 -->
        <p id="auth-error" class="text-yellow-300 bg-red-800 p-2 rounded-lg mt-3 hidden text-sm font-medium"></p>
    </header>

    <!-- 主頁面操作按鈕 -->
    <main class="bg-white p-6 rounded-b-xl shadow-lg mb-6">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
            <h2 class="text-2xl font-semibold text-gray-800">歷史記錄與操作</h2>
            <div class="flex space-x-3">
                <button onclick="window.openEditModal()" 
                        class="action-button bg-indigo-600 hover:bg-indigo-700 text-white shadow-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    新增一筆資料
                </button>
                <button id="admin-button" onclick="openAdminPanel()" 
                        class="action-button bg-yellow-500 hover:bg-yellow-600 text-white shadow-md hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18H4v-1a4 4 0 018 0v1h4z" /></svg>
                    管理員後台
                </button>
                <button onclick="window.exportToCSV()" 
                        class="action-button bg-green-500 hover:bg-green-600 text-white shadow-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    匯出 CSV
                </button>
            </div>
        </div>
    </main>

    <!-- 歷史紀錄區 -->
    <section id="checklist-history" class="p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">歷史核對記錄 (所有用戶共享)</h2>
        <p id="history-error" class="p-3 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg hidden mb-4 text-sm" role="alert"></p>

        <div id="checklist-history-content">
            <!-- 歷史紀錄將由 JavaScript 渲染到此 -->
            <p class="text-center text-gray-500 py-10">載入中，請稍候...</p>
        </div>
    </section>

    <!-- 浮動提示通知 (Toast Notification) -->
    <div id="toastNotification" class="hidden fixed bottom-5 right-5 z-50 p-4 rounded-lg text-white shadow-xl transition-all duration-500 ease-in-out" style="opacity: 0; transform: translateY(-20px);">
        訊息內容
    </div>


    <!-- Modal for 新增/編輯/檢核 -->
    <div id="checklistModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 id="modalTitle" class="text-2xl font-bold text-indigo-700"></h2>
                <span onclick="closeModal('checklistModal')" class="text-gray-500 hover:text-gray-700 text-3xl cursor-pointer">&times;</span>
            </div>
            
            <form id="modalChecklistForm" class="space-y-6">
                <!-- 隱藏欄位 for docId -->
                <input type="hidden" name="id" id="docIdFieldModal">

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                    <!-- 左側：執行設定 (Executor Settings) -->
                    <div class="p-4 border border-indigo-300 rounded-xl bg-indigo-50 shadow-sm">
                        <h3 class="text-xl font-bold text-indigo-800 mb-4 border-b pb-2">執行人填寫</h3>
                        
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">客戶名稱: <input type="text" name="clientName" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></label>
                            <label class="block text-sm font-medium text-gray-700">日期: <input type="date" name="date" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md"></label>
                            <label class="block text-sm font-medium text-gray-700">平台: <select name="platform" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md">
                                <option value="">選擇平台</option>
                                <option value="Google Ads">Google Ads</option>
                                <option value="Meta Ads">Meta Ads</option>
                                <option value="Line Ads">Line Ads</option>
                                <option value="Other">其他</option>
                            </select></label>
                            <label class="block text-sm font-medium text-gray-700">檢核項目: <select name="verificationType" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md">
                                <option value="">選擇項目</option>
                                <option value="新增/調整預算">新增/調整預算</option>
                                <option value="活動上線">活動上線</option>
                                <option value="其他設定">其他設定</option>
                            </select></label>
                            <label class="block text-sm font-medium text-gray-700 font-bold">帳號名稱/帳號ID: <input type="text" name="accountNameId" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md"></label>
                            
                            <hr class="my-4 border-indigo-200">
                            <p class="font-medium text-indigo-700">目標預算設定 (Target Budget Settings)</p>
                            
                            <label class="block text-sm font-medium text-gray-700">目標 - 原始帳戶預算 (NT$): <input type="number" name="targetOriginalAccountBudget" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md"></label>
                            <label class="block text-sm font-medium text-gray-700">目標 - 儲值後帳戶預算 (NT$): <input type="number" name="targetAccountBudgetAfterTopUp" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md"></label>
                            
                            <label class="block text-sm font-medium text-gray-700">廣告預算類型: <select name="adBudgetType" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md">
                                <option value="">選擇類型</option><option value="儲值金額">儲值金額</option><option value="日預算">日預算</option><option value="活動預算">活動預算</option>
                            </select></label>
                            <label class="block text-sm font-medium text-gray-700 font-bold">目標 - 儲值/設定金額 (NT$): <input type="number" name="targetAmount" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md"></label>
                            
                            <label class="block text-sm font-medium text-gray-700">目標 - 預計起始日: <input type="date" name="targetStartDate" data-group="executor" class="w-full p-2 border border-indigo-200 rounded-md"></label>
                            <label class="block text-sm font-medium text-gray-700">目標 - 預計結束日: <input type="date" name="targetEndDate" data-group="executor" class="w-full p-2 border border-indigo-200 rounded-md"></label>
                            
                            <label class="block text-sm font-medium text-gray-700">執行人 (姓名/Email): <input type="text" name="executor" data-group="executor" required class="w-full p-2 border border-indigo-200 rounded-md"></label>
                        </div>
                    </div>

                    <!-- 右側：檢核設定 (Reviewer Settings) -->
                    <div class="p-4 border border-green-300 rounded-xl bg-green-50 shadow-sm">
                        <h3 class="text-xl font-bold text-green-800 mb-4 border-b pb-2">檢核人填寫 (雙簽)</h3>

                        <div class="space-y-3">
                            <p class="font-medium text-green-700">實際執行結果 (Actual Execution Results)</p>
                            
                            <label class="block text-sm font-medium text-gray-700">實際 - 原始帳戶預算 (NT$): <input type="number" name="actualOriginalAccountBudget" data-group="reviewer" class="w-full p-2 border border-green-200 rounded-md"></label>
                            <label class="block text-sm font-medium text-gray-700">實際 - 儲值後帳戶預算 (NT$): <input type="number" name="actualAccountBudgetAfterTopUp" data-group="reviewer" class="w-full p-2 border border-green-200 rounded-md"></label>

                            <label class="block text-sm font-medium text-gray-700">實際 - 儲值/設定是否成功: <select name="actualSet" data-group="reviewer" class="w-full p-2 border border-green-200 rounded-md">
                                <option value="">選擇結果</option><option value="成功">成功</option><option value="失敗">失敗</option><option value="不適用">不適用</option>
                            </select></label>
                            
                            <label class="block text-sm font-medium text-gray-700">實際 - 起始日: <input type="date" name="actualStartDate" data-group="reviewer" class="w-full p-2 border border-green-200 rounded-md"></label>
                            <label class="block text-sm font-medium text-gray-700">實際 - 結束日: <input type="date" name="actualEndDate" data-group="reviewer" class="w-full p-2 border border-green-200 rounded-md"></label>
                            
                            <label class="block text-sm font-medium text-gray-700">檢核人 (姓名/Email): <input type="text" name="reviewer" data-group="reviewer" class="w-full p-2 border border-green-200 rounded-md"></label>
                            
                            <label class="block text-sm font-medium text-gray-700 font-bold">檢核結果: <select name="result" data-group="reviewer" class="w-full p-2 border border-green-200 rounded-md">
                                <option value="">選擇檢核結果</option><option value="通過">通過</option><option value="不通過">不通過</option><option value="待處理">待處理</option>
                            </select></label>
                        </div>
                    </div>
                </div>

                <!-- 備註/修正說明 (通用欄位) -->
                <div class="mt-6 p-4 border rounded-xl bg-gray-50 shadow-sm">
                    <label class="block text-lg font-semibold mb-2">備註/修正說明 (兩方皆可填寫):</label>
                    <textarea name="notes" rows="3" class="w-full p-2 border rounded-md" placeholder="請填寫任何特殊情況或修正過程。"></textarea>
                </div>
                
                <p id="modal-error" class="p-2 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg hidden text-sm" role="alert">錯誤訊息</p>

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('checklistModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold">
                        取消/關閉
                    </button>
                    <button type="button" id="modalSaveBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold">
                        儲存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for 管理員後台 (保持不變) -->
    <div id="adminModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold text-indigo-700">管理員後台 - 用戶權限管理</h2>
                <span onclick="closeModal('adminModal')" class="text-gray-500 hover:text-gray-700 text-3xl cursor-pointer">&times;</span>
            </div>

            <p class="text-sm text-gray-600 mb-4">您可以將用戶提升或降級為管理員。您的 Email (${defaultAdminEmail}) 是預設管理員且無法移除。</p>
            <p id="admin-error" class="p-2 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg hidden text-sm mb-4" role="alert"></p>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="userListBody" class="bg-white divide-y divide-gray-200">
                        <!-- 用戶列表將由 JavaScript 渲染到此 -->
                    </tbody>
                </table>
            </div>
            
            <div class="flex justify-end mt-4">
                <button type="button" onclick="closeModal('adminModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for 刪除確認 (保持不變) -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content max-w-sm">
            <h2 class="text-xl font-bold text-red-600 mb-4">確認刪除</h2>
            <p id="confirmDeleteText" class="mb-6">確定要永久刪除此筆記錄嗎？</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold">
                    取消
                </button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                    確定刪除
                </button>
            </div>
        </div>
    </div>

</body>
</html>
