<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£å‘Šé ç®—æ ¸å°é›™ç°½è¡¨æ ¼ (Google ç™»å…¥ & æ¬Šé™æ§ç®¡)</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥æ¨¡æ“¬ç¾ä»£ã€å°ˆæ¥­çš„è¨­è¨ˆæ„Ÿ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* è¼•å¾®çš„èƒŒæ™¯è‰² */
        }
        /* å®šç¾©è¡¨æ ¼çš„ç‰¹å®šæ¨£å¼ */
        .checklist-table th, .checklist-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist-table th {
            background-color: #eef2ff; /* æ·ºè—è‰²èƒŒæ™¯ï¼Œæ¨¡æ“¬ Canva çš„é…è‰² */
            color: #312e81; /* æ·±è—è‰²æ–‡å­— */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .checklist-table tr:hover {
            background-color: #f7fafc;
        }
        /* é‡å°æ—¥æœŸè¼¸å…¥æ¡†åšæ¨£å¼èª¿æ•´ */
        input[type="date"] {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* Highlight required fields with a special class */
        .is-required label::after, .is-required span.text-gray-700::after, 
        .form-group-required label::after {
            content: " *";
            color: #ef4444; /* red-500 */
        }
        /* Disabled input style */
        input:disabled, select:disabled, textarea:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
            opacity: 0.8;
        }
        /* Admin Panel Modal */
        #adminPanel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .admin-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        
        <!-- æ¨™é¡Œå€å¡Š -->
        <header class="p-6 sm:p-8 bg-indigo-600 text-white">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-1">å»£å‘Šé ç®—æ ¸å°é›™ç°½è¡¨</h1>
            <p class="text-indigo-200 text-lg">Campaign Budget Verification Checklist (C-BVC) - æ¬Šé™æ§ç®¡ç‰ˆ</p>
            <p class="mt-3 text-sm italic">æ­¤è¡¨å–®ç”¨æ–¼ç¢ºä¿æ‰€æœ‰é ç®—è¨­å®šç¶“éå…©å±¤æ¬¡æ ¸å°ï¼Œé˜²æ­¢è¶…æ”¯éŒ¯èª¤ã€‚</p>

            <div class="mt-4 flex items-center justify-between">
                <div id="authStatus" class="text-xs font-mono break-all">
                    <span id="userEmailDisplay">è«‹ç™»å…¥</span>
                </div>
                <div class="flex space-x-2">
                    <button id="adminPanelButton" class="hidden bg-yellow-500 hover:bg-yellow-600 text-gray-900 text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md">
                        ğŸ‘¤ ç®¡ç†å“¡å¾Œå°
                    </button>
                    <button id="authButton" class="bg-indigo-700 hover:bg-indigo-800 text-white text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md">
                        ç™»å…¥ Google
                    </button>
                </div>
            </div>
            
            <!-- è¼‰å…¥æç¤º -->
            <div id="loadingIndicator" class="mt-3 text-sm font-semibold text-yellow-300 hidden">
                æ­£åœ¨è¼‰å…¥ä¸­...
            </div>
        </header>

        <!-- è¡¨å–®å…§å®¹ï¼šä½¿ç”¨ form æ¨™ç±¤ä»¥ä¾¿æ–¼é‡è¨­ -->
        <form id="checklistForm" class="hidden">
            <!-- åŸºæœ¬è³‡è¨Šå€å¡Š -->
            <div class="p-6 sm:p-8 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">åŸºæœ¬è³‡æ–™</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-600">
                    <div class="flex flex-col form-group-required">
                        <label class="font-medium text-sm mb-1">å®¢æˆ¶åç¨± (Client Name)</label>
                        <input type="text" name="clientName" placeholder="è¼¸å…¥å®¢æˆ¶å…¨å" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="flex flex-col form-group-required">
                        <label class="font-medium text-sm mb-1">å»ºç«‹/ä¿®æ”¹æ—¥æœŸ (Date)</label>
                        <input type="date" name="date" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
            </div>

            <!-- é ç®—æ ¸å°è¡¨æ ¼ -->
            <div class="p-6 sm:p-8 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4" id="formTitle">å»£å‘Šæ´»å‹•èˆ‡é ç®—ç´°ç¯€</h2>
                
                <table class="checklist-table w-full border-collapse rounded-xl overflow-hidden">
                    <thead>
                        <tr>
                            <th class="w-1/4">æ¬„ä½é¡åˆ¥ (Category)</th>
                            <th class="w-1/4">è¨­å®šå…§å®¹ (Configuration)</th>
                            <th class="w-1/4">åŸ·è¡Œè¨­å®š (Executor Setting)</th> <!-- Executor only fill -->
                            <th class="w-1/4">æª¢æ ¸è¨­å®š (Reviewer Setting)</th> <!-- Reviewer only fill -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- å»£å‘Šå¹³å° -->
                        <tr>
                            <td class="font-medium text-gray-700">å»£å‘Šå¹³å°</td>
                            <td>
                                <select name="platform" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option>Meta Ads (Facebook/IG)</option>
                                    <option>Google Ads</option>
                                    <option>Line Ads</option>
                                    <option>TikTok Ads</option>
                                    <option>å…¶ä»–</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- å¸³è™Ÿåç¨±/å¸³è™ŸID (New Field Name) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">å¸³è™Ÿåç¨±/å¸³è™ŸID</td>
                            <td>
                                <input type="text" name="accountNameId" placeholder="è¼¸å…¥å¸³è™Ÿåç¨±/ID" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- æª¢æ ¸é¡å‹ (Control Field) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">æª¢æ ¸é¡å‹</td>
                            <td>
                                <select name="verificationType" id="verificationType" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                                    <option value="account_budget">å¸³æˆ¶é ç®— (Account Budget)</option>
                                    <option value="ad_budget">å»£å‘Šé ç®— (Ad Budget)</option>
                                    <option value="all">å…¨éƒ¨ (All)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        
                        <!-- é ç®—ç›¸é—œæ¬„ä½ (Account Budget) -->
                        <tr id="row-targetOriginalAccountBudget">
                            <td class="font-medium text-gray-700">åŸå¸³æˆ¶é ç®—</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">é ç®—è®Šå‹•å‰çš„å€¼</label>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetOriginalAccountBudget" placeholder="åŸ·è¡Œé‡‘é¡" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualOriginalAccountBudget" placeholder="æª¢æ ¸å¯¦éš›å€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        <tr id="row-targetAccountBudgetAfterTopUp">
                            <td class="font-medium text-gray-700">åŠ å€¼å¾Œå¸³æˆ¶é ç®—</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">é ç®—è®Šå‹•å¾Œçš„å€¼</label>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetAccountBudgetAfterTopUp" placeholder="åŸ·è¡Œé‡‘é¡" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualAccountBudgetAfterTopUp" placeholder="æª¢æ ¸å¯¦éš›å€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        
                        <!-- å»£å‘Šæ´»å‹•é ç®—é¡å‹ (Ad Budget) -->
                        <tr id="row-adBudgetType">
                            <td class="font-medium text-gray-700">å»£å‘Šé ç®—é¡å‹</td>
                            <td class="input-group executor-field">
                                <select name="adBudgetType" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    <option>æ—¥é ç®— (Daily Budget)</option>
                                    <option>ç¸½é ç®— (Lifetime Budget)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">ï¼ˆé¸æ“‡é¡å‹å¾Œè«‹å¡«å¯«ï¼‰</td>
                        </tr>
                        
                        <!-- é ç®—é‡‘é¡æ ¸å° (Ad Budget) -->
                        <tr id="row-targetAmount" class="bg-yellow-50/50">
                            <td class="font-bold text-indigo-700">å»£å‘Šæ´»å‹•é ç®—é‡‘é¡ (Budget)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">æœ€çµ‚è¨­å®šçš„é‡‘é¡</label>
                                <span class="text-gray-400 text-xs">ï¼ˆä»¥ç•¶åœ°è²¨å¹£è¨ˆåƒ¹ï¼‰</span>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetAmount" placeholder="åŸ·è¡Œæ•¸å€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-red-600 font-semibold">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualSet" placeholder="æª¢æ ¸è¨­å®šå€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-green-600 font-semibold">
                            </td>
                        </tr>
                        
                        <!-- æŠ•æ”¾æœŸé–“ - é–‹å§‹æ—¥æœŸ (Ad Budget) -->
                        <tr id="row-targetStartDate1">
                            <td class="font-medium text-gray-700" rowspan="2">æŠ•æ”¾æœŸé–“ (Duration)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">é–‹å§‹æ—¥æœŸ (Start Date)</label>
                            </td>
                            <td class="input-group executor-field">
                                <label class="block text-xs text-gray-500 mb-1">åŸ·è¡Œè¨­å®š (Target)</label>
                                <input type="date" name="targetStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group reviewer-field">
                                <label class="block text-xs text-gray-500 mb-1">æª¢æ ¸è¨­å®š (Actual)</label>
                                <input type="date" name="actualStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                        <!-- æŠ•æ”¾æœŸé–“ - çµæŸæ—¥æœŸ (Ad Budget) -->
                        <tr id="row-targetEndDate2">
                            <td>
                                <label class="block text-xs font-semibold mb-1">çµæŸæ—¥æœŸ (End Date)</label>
                            </td>
                            <td class="input-group executor-field">
                                <label class="block text-xs text-gray-500 mb-1">åŸ·è¡Œè¨­å®š (Target)</label>
                                <input type="date" name="targetEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group reviewer-field">
                                <label class="block text-xs text-gray-500 mb-1">æª¢æ ¸è¨­å®š (Actual)</label>
                                <input type="date" name="actualEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Budget Calculation Section -->
                <div class="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <button type="button" id="calculateBudgetButton" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            ğŸ§® è¨ˆç®—é ä¼°é ç®—èŠ±è²»
                        </button>
                        <div id="calculatedResult" class="text-lg font-semibold text-purple-800 w-full text-center sm:text-left">
                            ï¼ˆé»æ“ŠæŒ‰éˆ•é€²è¡Œè¨ˆç®—ï¼‰
                        </div>
                    </div>
                    <p class="text-xs text-purple-500 mt-2">åƒ…é©ç”¨æ–¼ã€Œæ—¥é ç®—ã€é¡å‹ï¼Œå°‡è¨ˆç®— [å»£å‘Šæ´»å‹•åŸ·è¡Œè¨­å®šé ç®—é‡‘é¡ * åŸ·è¡Œè¨­å®šæŠ•æ”¾æœŸé–“å¤©æ•¸] çš„ç¸½é ä¼°èŠ±è²»ã€‚</p>
                </div>
            </div>

            <!-- ç°½æ ¸å€å¡Š -->
            <div class="p-6 sm:p-8 bg-gray-50 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">é›™ç°½èˆ‡çµæœ</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- åŸ·è¡Œäººç°½å -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-indigo-300">
                        <label class="font-bold text-indigo-600 mb-2">åŸ·è¡Œäºº (Executor) ç°½æ ¸ <span class="text-red-500">*</span></label>
                        <p class="text-sm text-gray-500 mb-2">è¨­å®šé ç®—çš„ç¬¬ä¸€è²¬ä»»äººã€‚</p>
                        <input type="text" name="executor" id="executorInput" placeholder="è«‹è¼¸å…¥å§“å/å·¥è™Ÿç¢ºèª" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-indigo-500" required>
                        <div class="mt-3 text-xs text-gray-400">
                            åŸ·è¡Œäººæœ€å¾Œæ›´æ–°: <span id="executorTimeDisplay" class="font-medium text-gray-700">N/A</span>
                        </div>
                    </div>
                    
                    <!-- æ ¸å°äººç°½å -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-green-500">
                        <label class="font-bold text-green-600 mb-2">æ ¸å°äºº (Reviewer) ç¨ç«‹ç¢ºèª</label>
                        <p class="text-sm text-gray-500 mb-2">ç¨ç«‹æ ¸å°ä¸¦ç¢ºèªè¨­å®šå€¼èˆ‡è¦æ±‚æ•¸å€¼ç›¸ç¬¦ã€‚</p>
                        <input type="text" name="reviewer" id="reviewerInput" placeholder="é¸å¡«ï¼šè«‹è¼¸å…¥å§“å/å·¥è™Ÿç¢ºèª" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-green-500">
                        <div class="mt-3 text-xs text-gray-400">
                            æ ¸å°äººæœ€å¾Œæ›´æ–°: <span id="reviewerTimeDisplay" class="font-medium text-gray-700">N/A</span>
                        </div>
                    </div>
                </div>
                
                <!-- çµæœæ¬„ä½ -->
                <div class="mt-6 p-4 bg-white rounded-lg shadow-md reviewer-field">
                    <label class="font-bold text-gray-800 mb-2 block">æœ€çµ‚æ ¸å°çµæœ</label>
                    <select name="result" id="resultSelect" class="p-3 border border-gray-300 rounded-lg w-full text-lg font-semibold text-center focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- è«‹é¸æ“‡ --</option>
                        <option value="pass">âœ… æ ¸å°é€šé (å¯é–‹å§‹æŠ•æ”¾)</option>
                        <option value="fail">âŒ æ ¸å°ä¸é€šé (å·²æš«åœ/éœ€ä¿®æ­£)</option>
                    </select>
                </div>
                
                <!-- å‚™è¨» -->
                <div class="mt-6">
                    <label for="notes" class="font-bold text-gray-800 mb-2 block">å‚™è¨»/ä¿®æ­£èªªæ˜</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="è«‹å¡«å¯«ä»»ä½•ç‰¹æ®Šæƒ…æ³æˆ–ä¿®æ­£éç¨‹ã€‚" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- å‹•ä½œæŒ‰éˆ• -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button type="submit" id="saveButton" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:bg-gray-400" disabled>
                        ğŸ’¾ å„²å­˜ (è«‹å…ˆç™»å…¥)
                    </button>
                    <button type="button" id="newRecordButton" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg" disabled>
                        â• æ–°å¢ä¸€ç­†æ–°è³‡æ–™
                    </button>
                    <button type="button" id="exportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg" disabled>
                        â¬‡ï¸ åŒ¯å‡º Excel/CSV è¡¨å–®
                    </button>
                </div>

                <!-- ç‹€æ…‹è¨Šæ¯ -->
                <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center text-sm font-medium hidden"></div>

            </div>
        </form>
        
        <!-- æ­·å²è¨˜éŒ„å€å¡Š -->
        <div id="historySection" class="p-6 sm:p-8 bg-gray-100 border-t border-gray-300 mt-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">æ­·å²æ ¸å°è¨˜éŒ„</h2>
            <div id="historyTableContainer" class="overflow-x-auto">
                <p class="text-gray-500 p-4 text-center">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹å…±äº«æ­·å²è¨˜éŒ„...</p>
            </div>
            <div id="historyStatus" class="mt-4 text-sm font-medium text-center text-gray-600"></div>
        </div>
        <!-- åº•éƒ¨æç¤º -->
        <footer class="p-6 sm:p-8 bg-gray-800 text-white text-center text-sm">
            <p>ğŸ’¡ æç¤ºï¼šåœ¨æ¯æ¬¡è¨­å®šæˆ–èª¿æ•´é ç®—å¾Œï¼Œéƒ½å¿…é ˆåŸ·è¡Œæ­¤é›™ç°½æµç¨‹ã€‚</p>
        </footer>

    </div>

    <!-- ç®¡ç†å“¡å¾Œå° Modal -->
    <div id="adminPanel" class="hidden">
        <div class="admin-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ç®¡ç†å“¡å¾Œå° - æå‡æ¬Šé™</h3>
            <p class="text-sm text-gray-600 mb-4">åªæœ‰ç®¡ç†å“¡ (${lsiaobai@gmail.com}) å¯ä»¥çœ‹åˆ°æ­¤é¢æ¿ä¸¦è¨­ç½®å…¶ä»–ç”¨æˆ¶ç‚ºç®¡ç†è€…ã€‚</p>
            
            <div id="userListContainer" class="max-h-80 overflow-y-auto border p-3 rounded-lg bg-gray-50">
                <p class="text-center text-gray-500">è¼‰å…¥ç”¨æˆ¶ä¸­...</p>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="closeAdminPanel()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- éæ¨¡çµ„è…³æœ¬å€å¡Š (ç´”ç²¹çš„ UI è¼”åŠ©åŠŸèƒ½) ---
        
        // Function to calculate the number of days between two dates (inclusive)
        function calculateDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) return 0;

            const diffTime = Math.abs(end.getTime() - start.getTime());
            
            // Convert to days (add 1 for inclusive count)
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return diffDays;
        }

        // Function to handle the budget calculation
        function calculateEstimatedBudget() {
            const form = document.getElementById('checklistForm');
            const budgetType = form.elements['adBudgetType'].value;
            // ä½¿ç”¨åŸ·è¡Œè¨­å®šçš„é‡‘é¡ (targetAmount)
            const dailyBudget = parseFloat(form.elements['targetAmount'].value); 
            // ä½¿ç”¨åŸ·è¡Œè¨­å®šçš„æ—¥æœŸ (targetStartDate/targetEndDate)
            const startDate = form.elements['targetStartDate'].value;
            const endDate = form.elements['targetEndDate'].value;
            const resultEl = document.getElementById('calculatedResult');

            resultEl.className = 'text-lg font-semibold w-full text-center sm:text-left'; // Reset classes
            resultEl.classList.remove('text-red-600', 'text-green-700');

            if (budgetType !== 'æ—¥é ç®— (Daily Budget)') {
                resultEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼šè«‹é¸æ“‡ã€Œæ—¥é ç®—ã€é¡å‹é€²è¡Œè¨ˆç®—ã€‚';
                resultEl.classList.add('text-red-600');
                return;
            }

            if (isNaN(dailyBudget) || dailyBudget <= 0) {
                resultEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼šè«‹è¼¸å…¥æœ‰æ•ˆçš„ã€Œå»£å‘Šæ´»å‹•é ç®—é‡‘é¡ (åŸ·è¡Œè¨­å®š)ã€ã€‚';
                resultEl.classList.add('text-red-600');
                return;
            }

            const days = calculateDays(startDate, endDate);

            if (days <= 0) {
                resultEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼šè«‹é¸æ“‡æœ‰æ•ˆçš„ã€ŒæŠ•æ”¾æœŸé–“ã€åŸ·è¡Œè¨­å®šæ—¥æœŸç¯„åœ (é–‹å§‹æ—¥éœ€æ—©æ–¼æˆ–ç­‰æ–¼çµæŸæ—¥)ã€‚';
                resultEl.classList.add('text-red-600');
                return;
            }

            const estimatedTotal = dailyBudget * days;
            
            const formattedTotal = estimatedTotal.toLocaleString('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });

            resultEl.textContent = `é ä¼°ç¸½èŠ±è²»ï¼ˆå…± ${days} å¤©ï¼‰ï¼š${formattedTotal}`;
            resultEl.classList.add('text-green-700');
        }

        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('calculateBudgetButton').addEventListener('click', calculateEstimatedBudget);
        });

        // ç‚ºäº†è®“ Modal å¯ä»¥å¾ HTML å…§è¯èª¿ç”¨
        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

    </script>
    
    <!-- FIREBASE æ ¸å¿ƒåŠŸèƒ½ (é©—è­‰, å„²å­˜, æ¬Šé™æ§ç®¡) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        serverTimestamp,
        doc,
        setDoc,
        deleteDoc,
        getDocs,
        setLogLevel,
        query,
        orderBy,
        getDoc, 
        updateDoc, 
        Timestamp,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // è¨­å®š Firebase Debug Log
    setLogLevel('Debug');

    // --------------------------------------------------
    // 1. è«‹åœ¨é€™è£¡å¡«å¯«æ‚¨çš„ Firebase è¨­å®šç‰©ä»¶ (é‡è¦!)
    // --------------------------------------------------
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    }; 
    // --------------------------------------------------
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserId = null;
    let currentUserEmail = null;
    let isAdminUser = false;
    let allChecklistData = []; 

    // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ™‚é–“æˆ³
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        const date = timestamp instanceof Timestamp 
                    ? timestamp.toDate() 
                    : new Date(timestamp);
        
        if (isNaN(date)) return 'N/A';
        
        return date.toLocaleDateString('zh-TW', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        }).replace(/\//g, '-');
    }

    // =================================================================
    // 2. è³‡æ–™è¼‰å…¥å‡½æ•¸ (æ™‚åºä¿®å¾©)
    // =================================================================

    function loadHistoryChecklists() {
        const collectionRef = collection(doc(db, "public", "data"), "budget_checklists");
        
        document.getElementById("historyMessage").innerText = "æ­£åœ¨è¼‰å…¥æ­·å²è¨˜éŒ„..."; 

        const q = query(collectionRef, orderBy("executionTimestamp", "desc"));
        getDocs(q)
            .then(querySnapshot => {
                document.getElementById("historyMessage").innerText = ""; 
                displayHistoryChecklists(querySnapshot);
            })
            .catch(error => {
                document.getElementById("historyMessage").innerText = `âŒ è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—: ${error.message}ã€‚è«‹æª¢æŸ¥ Firestore è¦å‰‡æ˜¯å¦å…è¨±è®€å–ã€‚`;
                console.error("è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—:", error);
            });
    }

    function loadUserRoles() {
        const collectionRef = collection(doc(db, "public", "data"), "user_roles");
        
        document.getElementById("userListMessage").innerText = "æ­£åœ¨è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨..."; 
        
        getDocs(collectionRef)
            .then(querySnapshot => {
                document.getElementById("userListMessage").innerText = ""; 
                displayUserList(querySnapshot);
            })
            .catch(error => {
                document.getElementById("userListMessage").innerText = `âŒ è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨å¤±æ•—: ${error.message}`;
                console.error("è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨å¤±æ•—:", error);
            });
    }


    // =================================================================
    // 3. æ­·å²è¨˜éŒ„ç›¸é—œå‡½æ•¸ (V9 ä¿®å¾© + å…¬é–‹)
    // =================================================================

    function displayHistoryChecklists(querySnapshot) {
        const historyListBody = document.getElementById('historyListBody');
        historyListBody.innerHTML = '';
        allChecklistData = []; 

        querySnapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id;
            data.executionTimestampDisplay = formatTimestamp(data.executionTimestamp);
            data.reviewTimestampDisplay = formatTimestamp(data.reviewTimestamp);

            allChecklistData.push(data);
            displayRow(historyListBody, data);
        });

        document.getElementById('downloadCsvButton').style.display = allChecklistData.length > 0 ? 'inline-block' : 'none';
    }

    function displayRow(container, item) {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        
        let resultText = '';
        let resultClass = '';

        if (item.result === 'Pass') {
            resultText = 'é€šé (Pass)';
            resultClass = 'bg-green-100 text-green-800';
        } else if (item.result === 'Fail') {
            resultText = 'ä¸é€šé (Fail)';
            resultClass = 'bg-red-100 text-red-800';
        } else if (item.reviewer && !item.result) {
            resultText = 'æª¢æ ¸ä¸­';
            resultClass = 'bg-yellow-100 text-yellow-800';
        } else {
            resultText = 'å¾…æª¢æ ¸';
            resultClass = 'bg-gray-100 text-gray-800';
        }

        tr.innerHTML = `
            <td class="whitespace-nowrap">${item.project || 'N/A'}</td>
            <td class="whitespace-nowrap">${item.account || 'N/A'}</td>
            <td class="whitespace-nowrap">${item.date || 'N/A'}</td>
            <td class="whitespace-nowrap">${item.creatorEmail || 'N/A'}</td>
            <td class="whitespace-nowrap">${item.reviewerEmail || 'N/A'}</td>
            <td class="whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${resultClass}">${resultText}</span></td>
            <td class="whitespace-nowrap">${item.reviewTimestampDisplay}</td>
            <td class="text-right">
                ${createActionButton(item)}
            </td>
        `;
        container.appendChild(tr);
    }

    function createActionButton(item) {
        if (isAdminUser) {
            // æ³¨æ„ï¼šé€™è£¡å‘¼å«çš„ deleteChecklist æœƒæŒ‡å‘ window.deleteChecklist
            return `<button onclick="deleteChecklist('${item.id}')" class="text-red-600 hover:text-red-900 ml-2">åˆªé™¤</button>`;
        } else if (!item.reviewerEmail && currentUserId === item.createdByUserId) {
            return `<button onclick="editChecklist('${item.id}')" class="text-indigo-600 hover:text-indigo-900">ç·¨è¼¯/é‡æ–°é€å‡º</button>`;
        } else if (!item.result && currentUserEmail === item.reviewerEmail) {
            return `<button onclick="reviewChecklist('${item.id}')" class="text-green-600 hover:text-green-900">é€²è¡Œæª¢æ ¸</button>`;
        } else if (item.result) {
            return `<button onclick="viewChecklist('${item.id}')" class="text-gray-600 hover:text-gray-900">æŸ¥çœ‹</button>`;
        }
        return '';
    }

    // å°‡å‡½æ•¸æ›è¼‰åˆ° windowï¼Œä¾› HTML å…§è¯äº‹ä»¶èª¿ç”¨
    window.reviewChecklist = (id) => {
        const item = allChecklistData.find(d => d.id === id);
        if (!item) return;

        const notes = prompt("è«‹è¼¸å…¥æª¢æ ¸å‚™è¨» (é¸å¡«):");
        if (notes === null) return; 

        const result = confirm("è«‹ç¢ºèªæª¢æ ¸çµæœï¼šé»æ“Šã€ç¢ºå®šã€è¡¨ç¤ºé€šé (Pass)ï¼Œã€å–æ¶ˆã€è¡¨ç¤ºä¸é€šé (Fail)") ? 'Pass' : 'Fail';

        const docRef = doc(db, "public", "data", "budget_checklists", id);
        updateDoc(docRef, {
            result: result,
            notes: notes,
            reviewTimestamp: serverTimestamp(), 
            reviewer: currentUserEmail
        })
        .then(() => {
            alert("æª¢æ ¸çµæœå·²æˆåŠŸé€å‡ºï¼");
            loadHistoryChecklists(); 
        })
        .catch(error => {
            alert("æª¢æ ¸é€å‡ºå¤±æ•—ï¼š" + error.message);
            console.error("æª¢æ ¸é€å‡ºå¤±æ•—:", error);
        });
    }
    
    // å°‡å‡½æ•¸æ›è¼‰åˆ° windowï¼Œä¾› HTML å…§è¯äº‹ä»¶èª¿ç”¨
    window.deleteChecklist = (id) => {
        if (!isAdminUser) {
            alert("æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œåˆªé™¤æ“ä½œã€‚");
            return;
        }
        if (confirm("è­¦å‘Šï¼šæ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤ç­†è¨˜éŒ„å—ï¼Ÿ")) {
            deleteDoc(doc(db, "public", "data", "budget_checklists", id))
                .then(() => {
                    alert("è¨˜éŒ„å·²åˆªé™¤ã€‚");
                    loadHistoryChecklists(); 
                })
                .catch(error => {
                    alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
                    console.error("åˆªé™¤å¤±æ•—:", error);
                });
        }
    }

    // å°‡å‡½æ•¸æ›è¼‰åˆ° windowï¼Œä¾› HTML å…§è¯äº‹ä»¶èª¿ç”¨
    window.downloadCSV = () => {
        const header = [
            'ID', 'å°ˆæ¡ˆåç¨±', 'å»£å‘Šå¸³æˆ¶', 'æ—¥æœŸ', 'é ç®—æª¢æŸ¥', 'åŸ·è¡Œäºº', 'æª¢æ ¸äºº', 
            'æª¢æ ¸çµæœ', 'å‚™è¨»', 'åŸ·è¡Œæ™‚é–“', 'æª¢æ ¸æ™‚é–“', 'å»ºç«‹è€…UID', 'å»ºç«‹è€…Email'
        ];
        let csvRows = [];
        csvRows.push(header.join(','));

        allChecklistData.forEach(item => {
            const row = [
                item.id, `\"${item.project || ''}\"`, `\"${item.account || ''}\"`,
                item.date || '', item.isBudgetChecked ? 'æ˜¯' : 'å¦',
                item.creatorEmail || '', item.reviewerEmail || '',
                item.result || '', 
                `\"${item.notes ? item.notes.replace(/\"/g, '\"\"').replace(/\\n/g, ' ') : ''}\"`,
                item.executionTimestampDisplay || '', item.reviewTimestampDisplay || '', 
                item.createdByUserId || '', item.creatorEmail || ''
            ];
            csvRows.push(row.map(cell => {
                let cellString = String(cell);
                if (cellString.includes(',') || cellString.includes('"') || cellString.includes('\n')) {
                    cellString = `"${cellString.replace(/"/g, '""')}"`;
                }
                return cellString;
            }).join(','));
        });

        const csvString = csvRows.join('\n');
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', 'Budget_Checklist_Export_' + new Date().toISOString().slice(0, 10) + '.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // (æ‚¨çš„ editChecklist å’Œ viewChecklist å‡½æ•¸ä¹Ÿæ‡‰è©²è¢«å…¬é–‹ï¼Œé€™è£¡å‡è¨­å®ƒå€‘æ˜¯ç©ºçš„æˆ–æ‚¨ç¨å¾Œæœƒæ·»åŠ )
    window.editChecklist = (id) => { alert(`ç·¨è¼¯åŠŸèƒ½ ${id} (å°šæœªå¯¦ä½œ)`); }
    window.viewChecklist = (id) => { alert(`æŸ¥çœ‹åŠŸèƒ½ ${id} (å°šæœªå¯¦ä½œ)`); }


    // =================================================================
    // 4. ç®¡ç†è€…å¾Œå°ç›¸é—œå‡½æ•¸ (V9 ä¿®å¾© + å…¬é–‹)
    // =================================================================

    function displayUserList(querySnapshot) {
        const userListBody = document.getElementById('userListBody');
        userListBody.innerHTML = '';

        querySnapshot.forEach(doc => {
            const user = doc.data();
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            // æ³¨æ„ï¼šé€™è£¡å‘¼å«çš„ updateUserRole æœƒæŒ‡å‘ window.updateUserRole
            tr.innerHTML = `
                <td class="whitespace-nowrap">${doc.id}</td>
                <td class="whitespace-nowrap">${user.role || 'user'}</td>
                <td class="text-right">
                    <select onchange="updateUserRole('${doc.id}', this.value)" class="p-1 border rounded">
                        <option value="user" ${user.role !== 'admin' ? 'selected' : ''}>User</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </td>
            `;
            userListBody.appendChild(tr);
        });
    }

    // å°‡å‡½æ•¸æ›è¼‰åˆ° windowï¼Œä¾› HTML å…§è¯äº‹ä»¶èª¿ç”¨
    window.updateUserRole = (userId, newRole) => {
        if (!isAdminUser) {
            alert("æ‚¨æ²’æœ‰æ¬Šé™ä¿®æ”¹ç”¨æˆ¶è§’è‰²ã€‚");
            return;
        }
        
        setDoc(doc(db, "public", "data", "user_roles", userId), {
            role: newRole
        }, { merge: true })
        .then(() => {
            alert(`ç”¨æˆ¶ ${userId} çš„è§’è‰²å·²æ›´æ–°ç‚º ${newRole}`);
            loadUserRoles(); 
        })
        .catch(error => {
            alert("æ›´æ–°è§’è‰²å¤±æ•—ï¼š" + error.message);
            console.error("æ›´æ–°è§’è‰²å¤±æ•—:", error);
        });
    }


    // =================================================================
    // 5. æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹çš„è¼”åŠ©å‡½æ•¸ (V9 ä¿®å¾©æ™‚åº)
    // =================================================================

    function checkUserAdminStatus(uid) {
        getDoc(doc(db, "public", "data", "user_roles", uid))
            .then(docSnap => {
                if (docSnap.exists() && docSnap.data().role === 'admin') {
                    isAdminUser = true;
                    document.getElementById("adminPanel").style.display = "block";
                    loadUserRoles(); 
                } else {
                    isAdminUser = false;
                    document.getElementById("adminPanel").style.display = "none";
                }
            })
            .catch(error => {
                console.error("æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹å¤±æ•—:", error);
                isAdminUser = false;
                document.getElementById("adminPanel").style.display = "none";
            });
    }

    // =================================================================
    // 6. æ ¸å¿ƒç™»å…¥/ç™»å‡ºé‚è¼¯ (V9 ä¿®å¾©æ™‚åº)
    // =================================================================

    // ç™»å…¥æŒ‰éˆ•é»æ“Šè™•ç† (ä½¿ç”¨ addEventListener)
    document.getElementById('signInButton').addEventListener('click', () => {
        const provider = new GoogleAuthProvider(); 
        signInWithPopup(auth, provider) 
            .catch(error => {
                // ç™»å…¥å½ˆçª—è¢«é—œé–‰æˆ–æ¬Šé™è¢«æ‹’çµ•ä¹Ÿæœƒåœ¨é€™è£¡
                console.error("Google ç™»å…¥å¤±æ•—:", error);
                alert(`ç™»å…¥å¤±æ•—: ${error.message}`);
            });
    });

    // ç™»å‡ºæŒ‰éˆ•é»æ“Šè™•ç†
    document.getElementById('signOutButton').addEventListener('click', () => {
        signOut(auth); 
    });

    // *** æ ¸å¿ƒä¿®å¾©ï¼šç›£è½ç™»å…¥ç‹€æ…‹ï¼Œä¸¦åœ¨ç™»å…¥å¾Œæ‰è®€å–è³‡æ–™ ***
    onAuthStateChanged(auth, user => { 
        if (user) {
            // --- ä½¿ç”¨è€…å·²ç™»å…¥ ---
            currentUserId = user.uid;
            currentUserEmail = user.email;
            document.getElementById("userStatus").innerText = `å·²ç™»å…¥: ${currentUserEmail}`;
            document.getElementById("authPanel").style.display = "none";
            document.getElementById("content").style.display = "block";
            
            loadHistoryChecklists(); 
            checkUserAdminStatus(user.uid);

        } else {
            // --- ä½¿ç”¨è€…å·²ç™»å‡º ---
            currentUserId = null;
            currentUserEmail = null;
            isAdminUser = false;
            document.getElementById("userStatus").innerText = "æœªç™»å…¥";
            document.getElementById("authPanel").style.display = "block";
            document.getElementById("content").style.display = "none";
            document.getElementById("adminPanel").style.display = "none";

            // æ¸…ç©ºä¸¦é¡¯ç¤ºæœªç™»å…¥è¨Šæ¯
            document.getElementById("historyListBody").innerHTML = '';
            document.getElementById("userListBody").innerHTML = '';
            document.getElementById("historyMessage").innerText = "âŒ æœªç™»å…¥ï¼Œç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„ã€‚è«‹ç™»å…¥ã€‚";
            document.getElementById("userListMessage").innerText = "âŒ æœªç™»å…¥ï¼Œç„¡æ³•è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨ã€‚è«‹ç™»å…¥ã€‚";
        }
    });


    // =================================================================
    // 7. é€å‡ºæ ¸å°è¡¨å–® (V9 ä¿®å¾©)
    // =================================================================

    document.getElementById('checklistForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!currentUserId) {
            alert("è«‹å…ˆç™»å…¥æ‰èƒ½é€å‡ºè¡¨æ ¼ï¼");
            return;
        }

        const form = e.target;
        const project = form.project.value;
        const account = form.account.value;
        const date = form.date.value;
        const isBudgetChecked = form.isBudgetChecked.checked;
        const reviewerEmail = form.reviewerEmail.value;

        if (!reviewerEmail.includes('@')) {
             alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æª¢æ ¸äºº Email åœ°å€ã€‚");
             return;
        }

        addDoc(collection(doc(db, "public", "data"), "budget_checklists"), {
            project: project,
            account: account,
            date: date,
            isBudgetChecked: isBudgetChecked,
            reviewerEmail: reviewerEmail,
            result: null, 
            notes: null,
            executionTimestamp: serverTimestamp(), 
            createdByUserId: currentUserId,
            creatorEmail: currentUserEmail,
        })
        .then(() => {
            alert("æ ¸å°è¡¨å·²æˆåŠŸé€å‡ºï¼");
            form.reset(); 
            loadHistoryChecklists(); 
        })
        .catch(error => {
            alert("é€å‡ºå¤±æ•—ï¼š" + error.message);
            console.error("é€å‡ºå¤±æ•—:", error);
        });
    });

</script>
</body>

</html>

