<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告預算核對雙簽表格 (共享歷史紀錄)</title>
    <!-- 載入 Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體以模擬現代、專業的設計感 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* 輕微的背景色 */
        }
        /* 定義表格的特定樣式 */
        .checklist-table th, .checklist-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist-table th {
            background-color: #eef2ff; /* 淺藍色背景，模擬 Canva 的配色 */
            color: #312e81; /* 深藍色文字 */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .checklist-table tr:hover {
            background-color: #f7fafc;
        }
        /* 針對日期輸入框做樣式調整 */
        input[type="date"] {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* Highlight required fields with a special class */
        /* 僅針對執行設定（非檢核設定）應用必填星號 */
        .is-required label::after, .is-required span.text-gray-700::after {
            content: " *";
            color: #ef4444; /* red-500 */
        }
        /* 僅針對執行設定（非檢核設定）的必填欄位應用紅色陰影 */
        .input-group input:required:invalid:not([name*="actual"]):not([name="actualSet"]) {
             box-shadow: 0 0 0 1px #ef4444;
        }
        .input-group select:required:invalid:not([name*="actual"]):not([name="actualSet"]):not([name="result"]) {
             box-shadow: 0 0 0 1px #ef4444;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        
        <!-- 標題區塊 -->
        <header class="p-6 sm:p-8 bg-indigo-600 text-white">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-1">廣告預算核對雙簽表</h1>
            <p class="text-indigo-200 text-lg">Campaign Budget Verification Checklist (C-BVC)</p>
            <p class="mt-3 text-sm italic">此表單用於確保所有預算設定經過兩層次核對，防止超支錯誤。**歷史紀錄為所有用戶共享。**</p>
            <div id="userIdDisplay" class="mt-2 text-xs text-indigo-200 font-mono break-all">
                <span id="authStatus"></span>
            </div>
            <!-- Firebase 外部部署提示 -->
            <div id="externalDeployAlert" class="mt-3 p-2 bg-yellow-400 text-gray-900 rounded-lg text-sm font-semibold hidden">
                ⚠️ **警告 (GitHub 部署):** Firebase 配置遺失。請在程式碼中替換 `userFirebaseConfig` 變數為您自己的 Firebase 專案金鑰，否則數據將無法儲存。
            </div>
        </header>

        <!-- 表單內容：使用 form 標籤以便於重設 -->
        <form id="checklistForm">
            <!-- 基本資訊區塊 (Client Name & Date remain mandatory) -->
            <div class="p-6 sm:p-8 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">基本資料</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-600">
                    <div class="flex flex-col">
                        <label class="font-medium text-sm mb-1">客戶名稱 (Client Name) <span class="text-red-500">*</span></label>
                        <input type="text" name="clientName" placeholder="輸入客戶全名" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label class="font-medium text-sm mb-1">建立/修改日期 (Date) <span class="text-red-500">*</span></label>
                        <input type="date" name="date" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
            </div>

            <!-- 預算核對表格 -->
            <div class="p-6 sm:p-8 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4" id="formTitle">廣告活動與預算細節</h2>
                
                <table class="checklist-table w-full border-collapse rounded-xl overflow-hidden">
                    <thead>
                        <tr>
                            <th class="w-1/4">欄位類別 (Category)</th>
                            <th class="w-1/4">設定內容 (Configuration)</th>
                            <th class="w-1/4">執行設定 (Executor Setting)</th> <!-- 標題變更 -->
                            <th class="w-1/4">檢核設定 (Reviewer Setting)</th> <!-- 標題變更 -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 廣告平台 -->
                        <tr>
                            <td class="font-medium text-gray-700">廣告平台</td>
                            <td>
                                <select name="platform" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option>Meta Ads (Facebook/IG)</option>
                                    <option>Google Ads</option>
                                    <option>Line Ads</option>
                                    <option>TikTok Ads</option>
                                    <option>其他</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- 檢核類型 (Control Field) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">檢核類型</td>
                            <td>
                                <select name="verificationType" id="verificationType" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                                    <option value="account_budget">帳戶預算 (Account Budget)</option>
                                    <option value="ad_budget">廣告預算 (Ad Budget)</option>
                                    <option value="all">全部 (All)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- 廣告活動名稱 -->
                        <tr>
                            <td class="font-medium text-gray-700">廣告活動名稱</td>
                            <td>
                                <input type="text" name="campaignName" placeholder="輸入活動ID或名稱" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- 原帳戶預算 -->
                        <tr id="row-targetOriginalAccountBudget">
                            <td class="font-medium text-gray-700">原帳戶預算</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">預算變動前的值</label>
                            </td>
                            <td class="input-group">
                                <input type="number" name="targetOriginalAccountBudget" placeholder="執行金額" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group">
                                <input type="number" name="actualOriginalAccountBudget" placeholder="檢核實際值" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        <!-- 加值後帳戶預算 -->
                        <tr id="row-targetAccountBudgetAfterTopUp">
                            <td class="font-medium text-gray-700">加值後帳戶預算</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">預算變動後的值</label>
                            </td>
                            <td class="input-group">
                                <input type="number" name="targetAccountBudgetAfterTopUp" placeholder="執行金額" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group">
                                <input type="number" name="actualAccountBudgetAfterTopUp" placeholder="檢核實際值" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        <!-- 廣告預算類型 -->
                        <tr id="row-adBudgetType">
                            <td class="font-medium text-gray-700">廣告預算類型</td>
                            <td class="input-group">
                                <select name="adBudgetType" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option value="">-- 請選擇 --</option>
                                    <option>日預算 (Daily Budget)</option>
                                    <option>總預算 (Lifetime Budget)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">（選擇類型後請填寫）</td>
                        </tr>
                        <!-- 預算金額核對 -->
                        <tr id="row-targetAmount" class="bg-yellow-50/50">
                            <td class="font-bold text-indigo-700">廣告活動預算金額 (Budget)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">最終設定的金額</label>
                                <span class="text-gray-400 text-xs">（以當地貨幣計價）</span>
                            </td>
                            <td class="input-group">
                                <input type="number" name="targetAmount" placeholder="執行數值" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-red-600 font-semibold">
                            </td>
                            <td class="input-group">
                                <input type="number" name="actualSet" placeholder="檢核設定值" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-green-600 font-semibold">
                            </td>
                        </tr>
                        <!-- 投放期間 - 開始日期 (Start Date) -->
                        <tr id="row-targetStartDate1">
                            <td class="font-medium text-gray-700" rowspan="2">投放期間 (Duration)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">開始日期 (Start Date)</label>
                            </td>
                            <td class="input-group">
                                <label class="block text-xs text-gray-500 mb-1">執行設定 (Target)</label>
                                <input type="date" name="targetStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group">
                                <label class="block text-xs text-gray-500 mb-1">檢核設定 (Actual)</label>
                                <input type="date" name="actualStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                        <!-- 投放期間 - 結束日期 (End Date) -->
                        <tr id="row-targetEndDate2">
                            <td>
                                <label class="block text-xs font-semibold mb-1">結束日期 (End Date)</label>
                            </td>
                            <td class="input-group">
                                <label class="block text-xs text-gray-500 mb-1">執行設定 (Target)</label>
                                <input type="date" name="targetEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group">
                                <label class="block text-xs text-gray-500 mb-1">檢核設定 (Actual)</label>
                                <input type="date" name="actualEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Budget Calculation Section -->
                <div class="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <button type="button" id="calculateBudgetButton" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            🧮 計算預估預算花費
                        </button>
                        <div id="calculatedResult" class="text-lg font-semibold text-purple-800 w-full text-center sm:text-left">
                            （點擊按鈕進行計算）
                        </div>
                    </div>
                    <p class="text-xs text-purple-500 mt-2">僅適用於「日預算」類型，將計算 [廣告活動執行設定預算金額 * 執行設定投放期間天數] 的總預估花費。</p>
                </div>
            </div>

            <!-- 簽核區塊 -->
            <div class="p-6 sm:p-8 bg-gray-50 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">雙簽與結果</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- 執行人簽名 (Required) -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-indigo-300">
                        <label class="font-bold text-indigo-600 mb-2">執行人 (Executor) 簽核 <span class="text-red-500">*</span></label>
                        <p class="text-sm text-gray-500 mb-2">設定預算的第一責任人。</p>
                        <input type="text" name="executor" id="executorInput" placeholder="請輸入姓名/工號確認" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-indigo-500" required>
                        <div class="mt-3 text-xs text-gray-400">簽核時間: <span id="executorTime"></span></div>
                    </div>
                    
                    <!-- 核對人簽名 (Optional) -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-green-500">
                        <label class="font-bold text-green-600 mb-2">核對人 (Reviewer) 獨立確認</label>
                        <p class="text-sm text-gray-500 mb-2">獨立核對並確認設定值與要求數值相符。</p>
                        <input type="text" name="reviewer" id="reviewerInput" placeholder="選填：請輸入姓名/工號確認" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-green-500">
                        <div class="mt-3 text-xs text-gray-400">簽核時間: <span id="reviewerTime"></span></div>
                    </div>
                </div>
                
                <!-- 結果欄位 (Optional) -->
                <div class="mt-6 p-4 bg-white rounded-lg shadow-md">
                    <label class="font-bold text-gray-800 mb-2 block">最終核對結果</label>
                    <select name="result" id="resultSelect" class="p-3 border border-gray-300 rounded-lg w-full text-lg font-semibold text-center focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- 請選擇 --</option>
                        <option value="pass">✅ 核對通過 (可開始投放)</option>
                        <option value="fail">❌ 核對不通過 (已暫停/需修正)</option>
                    </select>
                </div>
                
                <!-- 備註 -->
                <div class="mt-6">
                    <label for="notes" class="font-bold text-gray-800 mb-2 block">備註/修正說明</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="請填寫任何特殊情況或修正過程。" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- 動作按鈕 (新增 "新增資料" 按鈕) -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button type="submit" id="saveButton" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:bg-gray-400">
                        💾 儲存核對結果
                    </button>
                    <!-- 新增一筆新資料按鈕，現在會呼叫 window.resetForm 來確保作用域正確 -->
                    <button type="button" id="newRecordButton" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg">
                        ➕ 新增一筆新資料
                    </button>
                    <button type="button" id="exportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:bg-gray-400">
                        ⬇️ 匯出 Excel/CSV 表單
                    </button>
                </div>

                <!-- 狀態訊息 -->
                <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center text-sm font-medium hidden"></div>

            </div>
        </form>
        
        <!-- 歷史記錄區塊 -->
        <div id="historySection" class="p-6 sm:p-8 bg-gray-100 border-t border-gray-300 mt-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">歷史核對記錄 (所有用戶共享)</h2>
            <div id="historyTableContainer" class="overflow-x-auto">
                <p class="text-gray-500">正在載入歷史記錄...</p>
            </div>
            <div id="historyStatus" class="mt-4 text-sm font-medium text-center text-gray-600"></div>
        </div>
        <!-- 底部提示 -->
        <footer class="p-6 sm:p-8 bg-gray-800 text-white text-center text-sm">
            <p>💡 提示：在每次設定或調整預算後，都必須執行此雙簽流程。</p>
        </footer>

    </div>

    <script>
        // JavaScript 僅用於自動填寫簽核時間（模擬電子簽核的一部分）
        function updateTimeStamps() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            document.getElementById('executorTime').textContent = timeString;
            document.getElementById('reviewerTime').textContent = timeString;
        }
        
        // Function to calculate the number of days between two dates (inclusive)
        function calculateDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Check if end date is before start date
            if (start > end) return 0;

            // Calculate difference in milliseconds
            const diffTime = Math.abs(end.getTime() - start.getTime());
            
            // Convert to days (add 1 for inclusive count)
            // Use 1000 * 60 * 60 * 24 
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return diffDays;
        }

        // Function to handle the budget calculation
        function calculateEstimatedBudget() {
            const form = document.getElementById('checklistForm');
            const budgetType = form.elements['adBudgetType'].value;
            // 使用執行設定的金額 (targetAmount)
            const dailyBudget = parseFloat(form.elements['targetAmount'].value); 
            // 使用執行設定的日期 (targetStartDate/targetEndDate)
            const startDate = form.elements['targetStartDate'].value;
            const endDate = form.elements['targetEndDate'].value;
            const resultEl = document.getElementById('calculatedResult');

            resultEl.className = 'text-lg font-semibold w-full text-center sm:text-left'; // Reset classes
            resultEl.classList.remove('text-red-600', 'text-green-700');

            if (budgetType !== '日預算 (Daily Budget)') {
                resultEl.textContent = '計算失敗：請選擇「日預算」類型進行計算。';
                resultEl.classList.add('text-red-600');
                return;
            }

            if (isNaN(dailyBudget) || dailyBudget <= 0) {
                resultEl.textContent = '計算失敗：請輸入有效的「廣告活動預算金額 (執行設定)」。';
                resultEl.classList.add('text-red-600');
                return;
            }

            const days = calculateDays(startDate, endDate);

            if (days <= 0) {
                resultEl.textContent = '計算失敗：請選擇有效的「投放期間」執行設定日期範圍 (開始日需早於或等於結束日)。';
                resultEl.classList.add('text-red-600');
                return;
            }

            const estimatedTotal = dailyBudget * days;
            
            // Simple currency formatting 
            const formattedTotal = estimatedTotal.toLocaleString('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });

            resultEl.textContent = `預估總花費（共 ${days} 天）：${formattedTotal}`;
            resultEl.classList.add('text-green-700');
        }

        // 為了模擬，我們在載入時更新一次時間
        updateTimeStamps();

        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('calculateBudgetButton').addEventListener('click', calculateEstimatedBudget);
             // 注意：newRecordButton 的事件監聽器已移至 type="module" 區塊以確保可以調用 resetForm
        });
    </script>
    
    <!-- FIREBASE 儲存與匯出功能 (已調整為公共/共享路徑) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            serverTimestamp,
            doc,
            setDoc,
            deleteDoc,
            setLogLevel,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 設定 Firebase Debug Log
        setLogLevel('Debug');

        // --- CUSTOM FIREBASE CONFIGURATION (FOR EXTERNAL USE) ---
        // 🚨 這是修復外部部署的關鍵區塊 🚨
        // 如果您在 GitHub Pages 上運行此檔案，請將您自己 Firebase 專案的配置貼到下方。
        // 請確保您已在該專案中開啟 Firestore 和 Authentication (匿名登入)。
        const userFirebaseConfig = {
            apiKey: "AIzaSyB7GaY2z3mKeD3bd9r_KVcd_VYMzz42c7c", // <-- 替換成您的 API Key
            authDomain: "budgetcheck-7a2e9.firebaseapp.com", // <-- 替換成您的 Auth Domain
            projectId: "budgetcheck-7a2e9", // <-- 替換成您的 Project ID
            storageBucket: "budgetcheck-7a2e9.firebasestorage.app", // 選填
            messagingSenderId: "1084663157523", // 選填
            appId: "1:1084663157523:web:4e8160c5c3da30f92380e6", // 選填
            measurementId: "G-81VM0XN7VC" // 選填
        };
        // --- END CUSTOM FIREBASE CONFIGURATION ---

        // Global Firebase variables: 優先使用 Canvas 提供的設定，如果沒有則使用自定義設定
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const configToUse = canvasFirebaseConfig || userFirebaseConfig;
        
        // 決定最終 App ID (用於資料庫路徑)
        const finalAppId = canvasAppId || userFirebaseConfig.projectId || 'default-external-app-id';

        let app = null;
        let db = null;
        let auth = null;
        let userId = 'N/A';
        let checklistData = []; 
        let editingId = null; 

        // 核心變更點: 使用公共路徑以實現共享歷史紀錄
        const PUBLIC_COLLECTION_PATH = `/artifacts/${finalAppId}/public/data/budget_checklists`;
        
        
        // Field groups for dynamic requirement setting
        const accountBudgetFields = [
            'targetOriginalAccountBudget', 'actualOriginalAccountBudget', 
            'targetAccountBudgetAfterTopUp', 'actualAccountBudgetAfterTopUp'
        ];
        
        const adBudgetFields = [
            'adBudgetType', 'targetAmount', 'actualSet', 
            'targetStartDate', 'targetEndDate', 'actualStartDate', 'actualEndDate'
        ];

        // Utility function to show status messages
        function showStatus(message, type = 'info', targetId = 'statusMessage') {
            const status = document.getElementById(targetId);
            status.textContent = message;
            status.className = 'mt-4 p-3 rounded-lg text-center text-sm font-medium';
            status.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'text-gray-600');

            if (type === 'error') {
                status.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                status.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'info') {
                 status.classList.add('bg-blue-100', 'text-blue-700');
            } else {
                status.classList.add('text-gray-600');
            }
        }
        
        /**
         * Dynamically sets the 'required' attribute on specified form elements and toggles the is-required class on their containers.
         */
        function setRequiredState(fieldNames, isRequired) {
            const form = document.getElementById('checklistForm');
            fieldNames.forEach(name => {
                const element = form.elements[name];
                
                // 判斷是否為檢核設定欄位 (實際/設定值) 或最終結果欄位，這些欄位不需要必填
                const isReviewerOrResultSetting = name.includes('actual') || name === 'actualSet' || name === 'result'; 
                
                if (element) {
                    if (isRequired && !isReviewerOrResultSetting) { 
                        element.setAttribute('required', 'required');
                    } else {
                        element.removeAttribute('required');
                    }
                    
                    // Toggle parent elements' is-required class for visual feedback
                    let parentRow = element.closest('tr');
                    let parentGroup = element.closest('.input-group');
                    
                    if (parentRow) {
                        const categoryCell = parentRow.querySelector('td:first-child');
                        // 僅對目標欄位 (即非檢核設定欄位) 應用視覺必填標記
                        if (categoryCell && !isReviewerOrResultSetting) {
                             categoryCell.classList.toggle('is-required', isRequired);
                        }
                    }
                    
                    if (parentGroup) {
                         // 僅對目標欄位 (即非檢核設定欄位) 應用視覺必填標記
                         if (!isReviewerOrResultSetting) {
                            parentGroup.classList.toggle('is-required', isRequired);
                         }
                    }
                }
            });
        }
        
        /**
         * Main function to handle conditional required fields based on verificationType.
         */
        function handleRequiredFields() {
            const verificationType = document.getElementById('verificationType').value;

            // 1. Reset all conditional fields to optional first
            setRequiredState(accountBudgetFields, false);
            setRequiredState(adBudgetFields, false);
            
            // 2. Apply new required states for 'target' fields
            if (verificationType === 'account_budget') {
                setRequiredState(accountBudgetFields, true);
            } else if (verificationType === 'ad_budget') {
                setRequiredState(adBudgetFields, true);
            } else if (verificationType === 'all') {
                setRequiredState(accountBudgetFields, true);
                setRequiredState(adBudgetFields, true);
            }
        }

        // Reset the form and editing state (Used by newRecordButton and after save)
        function resetForm() {
            document.getElementById('checklistForm').reset();
            document.getElementById('formTitle').textContent = "廣告活動與預算細節";
            document.getElementById('saveButton').textContent = "💾 儲存核對結果";
            editingId = null;
            
            handleRequiredFields();

            // Clear calculation result
            document.getElementById('calculatedResult').textContent = '（點擊按鈕進行計算）'; 
            document.getElementById('calculatedResult').classList.remove('text-red-600', 'text-green-700');
            showStatus("已清空表單，您可以新增一筆新資料。", 'info');
        }

        // Function to collect form data
        function collectFormData() {
            const form = document.getElementById('checklistForm');
            
            // Native browser validation check before collecting data
            if (!form.checkValidity()) {
                showStatus("錯誤：請檢查並填寫所有標註星號的必填欄位 (僅執行設定、客戶名稱與日期)。", 'error');
                return null;
            }
            
            // 確保所有數據被收集，即使是空值 (檢核設定欄位與最終結果欄位可能為空)
            const data = {
                clientName: form.elements['clientName'].value,
                date: form.elements['date'].value,
                platform: form.elements['platform'].value,
                verificationType: form.elements['verificationType'].value, 
                campaignName: form.elements['campaignName'].value, 
                targetOriginalAccountBudget: form.elements['targetOriginalAccountBudget'].value, 
                actualOriginalAccountBudget: form.elements['actualOriginalAccountBudget'].value, 
                targetAccountBudgetAfterTopUp: form.elements['targetAccountBudgetAfterTopUp'].value, 
                actualAccountBudgetAfterTopUp: form.elements['actualAccountBudgetAfterTopUp'].value, 
                adBudgetType: form.elements['adBudgetType'].value, 
                targetAmount: form.elements['targetAmount'].value,
                actualSet: form.elements['actualSet'].value,
                targetStartDate: form.elements['targetStartDate'].value, 
                targetEndDate: form.elements['targetEndDate'].value,     
                actualStartDate: form.elements['actualStartDate'].value, 
                actualEndDate: form.elements['actualEndDate'].value,     
                executor: form.elements['executor'].value,
                reviewer: form.elements['reviewer'].value, 
                result: form.elements['result'].value, 
                notes: form.elements['notes'].value,
                createdAt: serverTimestamp(),
                // 新增欄位來儲存創建此記錄的使用者 ID，用於共享環境下的追蹤
                createdByUserId: userId 
            };

            // Business logic check: If the user explicitly selects 'fail', we prevent saving.
            if (data.result === 'fail') {
                showStatus("錯誤：核對結果為「不通過」，請先修正後再儲存。", 'error');
                return null;
            }

            return data;
        }

        // Save (Add or Update) to Firestore
        async function saveChecklist(event) {
            event.preventDefault(); // Prevent default form submission
            if (!db) {
                 showStatus("❌ 儲存失敗: Firebase 尚未初始化。請檢查您的 Firebase 配置。", 'error');
                 return;
            }
            
            const data = collectFormData();
            if (!data) return;
            
            // 使用公共路徑以共享資料
            const path = PUBLIC_COLLECTION_PATH;
            const docRef = editingId ? doc(db, path, editingId) : collection(db, path);

            try {
                if (editingId) {
                    // Update existing document
                    await setDoc(docRef, data);
                    showStatus("✅ 核對結果已成功更新。", 'success');
                } else {
                    // Add new document
                    await addDoc(docRef, data);
                    showStatus("✅ 核對結果已成功儲存至雲端共享記錄。", 'success');
                }
                resetForm(); // Reset form after successful save/update
                
            } catch (e) {
                console.error("Error saving document: ", e);
                showStatus(`❌ 儲存失敗: ${e.message}`, 'error');
            }
        }

        // Load data using onSnapshot (and re-render the history table)
        function loadChecklists() {
            if (!db) return;
            // 使用公共路徑以共享資料
            const path = PUBLIC_COLLECTION_PATH;
            const q = collection(db, path); 

            onSnapshot(q, (snapshot) => {
                // 將資料儲存到全域變數
                checklistData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate().toLocaleString('zh-TW') || 'N/A'
                    };
                }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // 依時間倒序排列

                showStatus(`💾 已載入 ${checklistData.length} 筆共享歷史核對記錄。`, 'info', 'historyStatus');
                renderHistoryTable(); // 載入後渲染表格
            }, (error) => {
                console.error("Error listening to collection: ", error);
                showStatus(`❌ 載入歷史記錄失敗: ${error.message}`, 'error', 'historyStatus');
            });
        }

        // Delete a record
        async function deleteChecklist(id) {
            if (!db) return;
            
            const confirmation = window.confirm("確定要刪除這筆記錄嗎？此操作無法復原。"); // 暫時代替 custom modal
            if (!confirmation) {
                return;
            }
            
            // 使用公共路徑
            const path = PUBLIC_COLLECTION_PATH;
            const docRef = doc(db, path, id);
            
            try {
                await deleteDoc(docRef);
                showStatus("🗑️ 記錄已刪除。", 'success', 'historyStatus');
                // If the user was editing the deleted item, reset the form
                if (editingId === id) {
                    resetForm();
                }
            } catch (e) {
                console.error("Error deleting document: ", e);
                showStatus(`❌ 刪除失敗: ${e.message}`, 'error', 'historyStatus');
            }
        }

        // Start editing a record
        function startEdit(id) {
            const item = checklistData.find(d => d.id === id);
            if (!item) {
                showStatus(`找不到 ID 為 ${id} 的記錄。`, 'error');
                return;
            }
            
            const form = document.getElementById('checklistForm');
            // 1. 填充表單
            for (const key in item) {
                if (form.elements[key]) {
                    // 確保空值不會覆蓋 placeholder，並且所有欄位都能被填充
                    form.elements[key].value = item[key] || '';
                }
            }

            // 2. 更新編輯狀態
            editingId = id;
            document.getElementById('formTitle').textContent = `廣告活動與預算細節 (正在編輯: ${item.clientName} - ${item.date})`;
            document.getElementById('saveButton').textContent = "🔄 更新核對結果";
            
            // 3. 重新運行必填欄位邏輯以匹配載入的紀錄
            handleRequiredFields();

            // 4. 滾動到表單頂部
            document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });

            // 5. 重設計算結果
            document.getElementById('calculatedResult').textContent = '（點擊按鈕進行重新計算）'; 
            document.getElementById('calculatedResult').classList.remove('text-red-600', 'text-green-700');
        }

        // Render the history table
        function renderHistoryTable() {
            const container = document.getElementById('historyTableContainer');
            if (checklistData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-4 text-center">目前沒有歷史核對記錄。</p>';
                return;
            }

            let html = `
                <table class="w-full text-sm text-left text-gray-700 bg-white shadow-md rounded-lg overflow-hidden">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">客戶 / 活動名稱</th>
                            <th scope="col" class="px-6 py-3">檢核類型</th> 
                            <th scope="col" class="px-6 py-3">期間 (執行設定)</th>
                            <th scope="col" class="px-6 py-3">執行人</th> 
                            <th scope="col" class="px-6 py-3">建立者 (User ID)</th>
                            <th scope="col" class="px-6 py-3">結果</th>
                            <th scope="col" class="px-6 py-3">簽核時間</th>
                            <th scope="col" class="px-6 py-3">操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            checklistData.forEach(item => {
                const statusClass = item.result === 'pass' ? 'text-green-600 bg-green-50' : (item.result === 'fail' ? 'text-red-600 bg-red-50' : 'text-gray-600 bg-gray-50');
                const statusText = item.result === 'pass' ? '✅ 通過' : (item.result === 'fail' ? '❌ 不通過' : '⚪ 待確認');
                const duration = item.targetStartDate && item.targetEndDate 
                    ? `${item.targetStartDate.slice(5)} ~ ${item.targetEndDate.slice(5)}`
                    : '未填寫';

                let verificationTypeText;
                if (item.verificationType === 'account_budget') {
                    verificationTypeText = `帳戶預算`;
                } else if (item.verificationType === 'ad_budget') {
                    verificationTypeText = `廣告預算`;
                } else if (item.verificationType === 'all') {
                    verificationTypeText = `全部`;
                } else {
                     verificationTypeText = `N/A`;
                }
                
                // 顯示建立者 User ID (截取前 4 位 + 後 4 位)
                const creatorId = item.createdByUserId || 'N/A';
                const displayCreatorId = creatorId.length > 8 
                    ? `${creatorId.substring(0, 4)}...${creatorId.substring(creatorId.length - 4)}` 
                    : creatorId;

                html += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">
                            ${item.clientName}<br>
                            <span class="text-xs text-gray-500">${item.campaignName || 'N/A'}</span>
                        </td>
                        <td class="px-6 py-4">
                            ${verificationTypeText}<br>
                            <span class="font-bold text-xs text-gray-500">${item.adBudgetType.split(' ')[0] || 'N/A'}</span>
                        </td>
                        <td class="px-6 py-4">${duration}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${item.executor || 'N/A'}</td> 
                        <td class="px-6 py-4 text-xs font-mono text-gray-500" title="完整 ID: ${creatorId}">
                            ${displayCreatorId}
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-xs">${item.createdAt}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="window.startEdit('${item.id}')" class="text-indigo-600 hover:text-indigo-900 font-medium mr-3">編輯</button>
                            <button onclick="window.deleteChecklist('${item.id}')" class="text-red-600 hover:text-red-900 font-medium">刪除</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            container.innerHTML = html;
        }

        // Export to CSV function 
        function exportToCSV() {
            if (checklistData.length === 0) {
                showStatus("🚫 沒有可匯出的記錄。", 'error');
                return;
            }

            // 1. 定義 CSV 標頭 
            const headers = [
                "客戶名稱", "建立/修改日期", "廣告平台", "檢核類型", "廣告活動名稱", 
                "原帳戶執行設定預算", "原帳戶檢核設定預算", "加值後執行設定預算", "加值後檢核設定預算", 
                "廣告預算類型", "廣告活動執行設定金額", "廣告活動檢核設定金額", 
                "執行設定開始日期", "執行設定結束日期", "檢核設定開始日期", "檢核設定結束日期", 
                "執行人", "核對人", "核對結果", "備註", "儲存時間", "建立者User ID" // 新增欄位
            ];
            
            // 2. Map data to header order
            const csvRows = [
                headers.join(',')
            ];

            checklistData.forEach(item => {
                const row = [
                    item.clientName, 
                    item.date, 
                    item.platform, 
                    item.verificationType, 
                    item.campaignName, 
                    item.targetOriginalAccountBudget, 
                    item.actualOriginalAccountBudget, 
                    item.targetAccountBudgetAfterTopUp, 
                    item.actualAccountBudgetAfterTopUp, 
                    item.adBudgetType, 
                    item.targetAmount, 
                    item.actualSet, 
                    item.targetStartDate || '', 
                    item.targetEndDate || '',   
                    item.actualStartDate || '', 
                    item.actualEndDate || '',   
                    item.executor, 
                    item.reviewer, 
                    item.result, 
                    // 處理備註欄位：用雙引號包住並替換換行符號
                    `"${item.notes ? item.notes.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                    item.createdAt,
                    item.createdByUserId || 'N/A' // 新增 User ID
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            
            // 3. 建立 Blob 並下載 (加入 BOM 解決中文亂碼問題)
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'Budget_Checklist_Export_' + new Date().toISOString().slice(0, 10) + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus("⬇️ 歷史紀錄已匯出為 CSV 檔案。", 'success');
        }

        // Global function exposure for button clicks and history table interactions
        window.startEdit = startEdit;
        window.deleteChecklist = deleteChecklist;
        window.resetForm = resetForm;


        document.addEventListener('DOMContentLoaded', async () => {
            // 檢查 Firebase 配置是否足夠
            const isConfigSufficient = !!configToUse.apiKey && !!configToUse.projectId;
            
            if (!isConfigSufficient) {
                // 如果配置不足，顯示警告並停止 Firebase 初始化
                document.getElementById('externalDeployAlert').classList.remove('hidden');
                document.getElementById('historyTableContainer').innerHTML = '<p class="text-red-500 p-4 text-center">無法連線至資料庫：請先在程式碼中填入 Firebase 專案配置。</p>';
                document.getElementById('saveButton').disabled = true;
                return;
            }

            // 1. Auth Setup and Get userId
            try {
                // 只有在配置足夠時才初始化
                app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Firebase Initialization or Sign-in Failed:", e);
                document.getElementById('externalDeployAlert').textContent = `❌ 連線錯誤: ${e.message}。請檢查您的 Firebase 配置或安全規則。`;
                document.getElementById('externalDeployAlert').classList.remove('hidden');
                document.getElementById('historyTableContainer').innerHTML = '<p class="text-red-500 p-4 text-center">連線至資料庫失敗。請檢查您的連線設定和網路。</p>';
                document.getElementById('saveButton').disabled = true;
                return;
            }


            // Get the current user ID after authentication
            if (auth.currentUser) {
                userId = auth.currentUser.uid;
                document.getElementById('authStatus').innerHTML = `**當前用戶 ID:** ${userId}`;
                document.getElementById('authStatus').classList.add('font-bold', 'text-yellow-300');
            } else {
                 userId = crypto.randomUUID();
                 document.getElementById('authStatus').innerHTML = `**匿名用戶 ID:** ${userId}`;
            }

            // 2. Initial Setup
            handleRequiredFields(); // Run once on load
            loadChecklists(); // Start listening to the shared collection
            
            // 3. Add Event Listeners
            document.getElementById('checklistForm').addEventListener('submit', saveChecklist);
            document.getElementById('verificationType').addEventListener('change', handleRequiredFields);
            document.getElementById('newRecordButton').addEventListener('click', () => { window.resetForm(); });
            document.getElementById('exportButton').addEventListener('click', exportToCSV);
        });

    </script>
</body>
</html>
