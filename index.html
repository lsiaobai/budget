<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£å‘Šé ç®—æ ¸å°é›™ç°½è¡¨æ ¼ (Google ç™»å…¥ & æ¬Šé™æ§ç®¡)</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥æ¨¡æ“¬ç¾ä»£ã€å°ˆæ¥­çš„è¨­è¨ˆæ„Ÿ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* è¼•å¾®çš„èƒŒæ™¯è‰² */
        }
        /* å®šç¾©è¡¨æ ¼çš„ç‰¹å®šæ¨£å¼ */
        .checklist-table th, .checklist-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist-table th {
            background-color: #eef2ff; /* æ·ºè—è‰²èƒŒæ™¯ï¼Œæ¨¡æ“¬ Canva çš„é…è‰² */
            color: #312e81; /* æ·±è—è‰²æ–‡å­— */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .checklist-table tr:hover {
            background-color: #f7fafc;
        }
        /* é‡å°æ—¥æœŸè¼¸å…¥æ¡†åšæ¨£å¼èª¿æ•´ */
        input[type="date"] {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* Highlight required fields with a special class */
        .is-required label::after, .is-required span.text-gray-700::after, 
        .form-group-required label::after {
            content: " *";
            color: #ef4444; /* red-500 */
        }
        /* Disabled input style */
        input:disabled, select:disabled, textarea:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
            opacity: 0.8;
        }
        /* Admin Panel Modal */
        #adminPanel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .admin-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        
        <!-- æ¨™é¡Œå€å¡Š -->
        <header class="p-6 sm:p-8 bg-indigo-600 text-white">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-1">å»£å‘Šé ç®—æ ¸å°é›™ç°½è¡¨</h1>
            <p class="text-indigo-200 text-lg">Campaign Budget Verification Checklist (C-BVC) - æ¬Šé™æ§ç®¡ç‰ˆ</p>
            <p class="mt-3 text-sm italic">æ­¤è¡¨å–®ç”¨æ–¼ç¢ºä¿æ‰€æœ‰é ç®—è¨­å®šç¶“éå…©å±¤æ¬¡æ ¸å°ï¼Œé˜²æ­¢è¶…æ”¯éŒ¯èª¤ã€‚</p>

            <div class="mt-4 flex items-center justify-between">
                <div id="authStatus" class="text-xs font-mono break-all">
                    <span id="userEmailDisplay">è«‹ç™»å…¥</span>
                </div>
                <div class="flex space-x-2">
                    <button id="adminPanelButton" class="hidden bg-yellow-500 hover:bg-yellow-600 text-gray-900 text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md">
                        ğŸ‘¤ ç®¡ç†å“¡å¾Œå°
                    </button>
                    <button id="authButton" class="bg-indigo-700 hover:bg-indigo-800 text-white text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md">
                        ç™»å…¥ Google
                    </button>
                </div>
            </div>
            
            <!-- è¼‰å…¥æç¤º -->
            <div id="loadingIndicator" class="mt-3 text-sm font-semibold text-yellow-300 hidden">
                æ­£åœ¨è¼‰å…¥ä¸­...
            </div>
        </header>

        <!-- è¡¨å–®å…§å®¹ï¼šä½¿ç”¨ form æ¨™ç±¤ä»¥ä¾¿æ–¼é‡è¨­ -->
        <form id="checklistForm" class="hidden">
            <!-- åŸºæœ¬è³‡è¨Šå€å¡Š -->
            <div class="p-6 sm:p-8 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">åŸºæœ¬è³‡æ–™</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-600">
                    <div class="flex flex-col form-group-required">
                        <label class="font-medium text-sm mb-1">å®¢æˆ¶åç¨± (Client Name)</label>
                        <input type="text" name="clientName" placeholder="è¼¸å…¥å®¢æˆ¶å…¨å" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="flex flex-col form-group-required">
                        <label class="font-medium text-sm mb-1">å»ºç«‹/ä¿®æ”¹æ—¥æœŸ (Date)</label>
                        <input type="date" name="date" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
            </div>

            <!-- é ç®—æ ¸å°è¡¨æ ¼ -->
            <div class="p-6 sm:p-8 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4" id="formTitle">å»£å‘Šæ´»å‹•èˆ‡é ç®—ç´°ç¯€</h2>
                
                <table class="checklist-table w-full border-collapse rounded-xl overflow-hidden">
                    <thead>
                        <tr>
                            <th class="w-1/4">æ¬„ä½é¡åˆ¥ (Category)</th>
                            <th class="w-1/4">è¨­å®šå…§å®¹ (Configuration)</th>
                            <th class="w-1/4">åŸ·è¡Œè¨­å®š (Executor Setting)</th> <!-- Executor only fill -->
                            <th class="w-1/4">æª¢æ ¸è¨­å®š (Reviewer Setting)</th> <!-- Reviewer only fill -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- å»£å‘Šå¹³å° -->
                        <tr>
                            <td class="font-medium text-gray-700">å»£å‘Šå¹³å°</td>
                            <td>
                                <select name="platform" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option>Meta Ads (Facebook/IG)</option>
                                    <option>Google Ads</option>
                                    <option>Line Ads</option>
                                    <option>TikTok Ads</option>
                                    <option>å…¶ä»–</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- å¸³è™Ÿåç¨±/å¸³è™ŸID (New Field Name) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">å¸³è™Ÿåç¨±/å¸³è™ŸID</td>
                            <td>
                                <input type="text" name="accountNameId" placeholder="è¼¸å…¥å¸³è™Ÿåç¨±/ID" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        <!-- æª¢æ ¸é¡å‹ (Control Field) -->
                        <tr>
                            <td class="font-medium text-gray-700 is-required">æª¢æ ¸é¡å‹</td>
                            <td>
                                <select name="verificationType" id="verificationType" class="w-full p-0.5 border-none bg-transparent focus:ring-0" required>
                                    <option value="account_budget">å¸³æˆ¶é ç®— (Account Budget)</option>
                                    <option value="ad_budget">å»£å‘Šé ç®— (Ad Budget)</option>
                                    <option value="all">å…¨éƒ¨ (All)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">N/A</td>
                        </tr>
                        
                        <!-- é ç®—ç›¸é—œæ¬„ä½ (Account Budget) -->
                        <tr id="row-targetOriginalAccountBudget">
                            <td class="font-medium text-gray-700">åŸå¸³æˆ¶é ç®—</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">é ç®—è®Šå‹•å‰çš„å€¼</label>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetOriginalAccountBudget" placeholder="åŸ·è¡Œé‡‘é¡" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualOriginalAccountBudget" placeholder="æª¢æ ¸å¯¦éš›å€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        <tr id="row-targetAccountBudgetAfterTopUp">
                            <td class="font-medium text-gray-700">åŠ å€¼å¾Œå¸³æˆ¶é ç®—</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">é ç®—è®Šå‹•å¾Œçš„å€¼</label>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetAccountBudgetAfterTopUp" placeholder="åŸ·è¡Œé‡‘é¡" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualAccountBudgetAfterTopUp" placeholder="æª¢æ ¸å¯¦éš›å€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                            </td>
                        </tr>
                        
                        <!-- å»£å‘Šæ´»å‹•é ç®—é¡å‹ (Ad Budget) -->
                        <tr id="row-adBudgetType">
                            <td class="font-medium text-gray-700">å»£å‘Šé ç®—é¡å‹</td>
                            <td class="input-group executor-field">
                                <select name="adBudgetType" class="w-full p-0.5 border-none bg-transparent focus:ring-0">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    <option>æ—¥é ç®— (Daily Budget)</option>
                                    <option>ç¸½é ç®— (Lifetime Budget)</option>
                                </select>
                            </td>
                            <td colspan="2" class="text-gray-500 text-sm">ï¼ˆé¸æ“‡é¡å‹å¾Œè«‹å¡«å¯«ï¼‰</td>
                        </tr>
                        
                        <!-- é ç®—é‡‘é¡æ ¸å° (Ad Budget) -->
                        <tr id="row-targetAmount" class="bg-yellow-50/50">
                            <td class="font-bold text-indigo-700">å»£å‘Šæ´»å‹•é ç®—é‡‘é¡ (Budget)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">æœ€çµ‚è¨­å®šçš„é‡‘é¡</label>
                                <span class="text-gray-400 text-xs">ï¼ˆä»¥ç•¶åœ°è²¨å¹£è¨ˆåƒ¹ï¼‰</span>
                            </td>
                            <td class="input-group executor-field">
                                <input type="number" name="targetAmount" placeholder="åŸ·è¡Œæ•¸å€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-red-600 font-semibold">
                            </td>
                            <td class="input-group reviewer-field">
                                <input type="number" name="actualSet" placeholder="æª¢æ ¸è¨­å®šå€¼" class="w-full p-0.5 border-none bg-transparent focus:ring-0 text-green-600 font-semibold">
                            </td>
                        </tr>
                        
                        <!-- æŠ•æ”¾æœŸé–“ - é–‹å§‹æ—¥æœŸ (Ad Budget) -->
                        <tr id="row-targetStartDate1">
                            <td class="font-medium text-gray-700" rowspan="2">æŠ•æ”¾æœŸé–“ (Duration)</td>
                            <td>
                                <label class="block text-xs font-semibold mb-1">é–‹å§‹æ—¥æœŸ (Start Date)</label>
                            </td>
                            <td class="input-group executor-field">
                                <label class="block text-xs text-gray-500 mb-1">åŸ·è¡Œè¨­å®š (Target)</label>
                                <input type="date" name="targetStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group reviewer-field">
                                <label class="block text-xs text-gray-500 mb-1">æª¢æ ¸è¨­å®š (Actual)</label>
                                <input type="date" name="actualStartDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                        <!-- æŠ•æ”¾æœŸé–“ - çµæŸæ—¥æœŸ (Ad Budget) -->
                        <tr id="row-targetEndDate2">
                            <td>
                                <label class="block text-xs font-semibold mb-1">çµæŸæ—¥æœŸ (End Date)</label>
                            </td>
                            <td class="input-group executor-field">
                                <label class="block text-xs text-gray-500 mb-1">åŸ·è¡Œè¨­å®š (Target)</label>
                                <input type="date" name="targetEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                            <td class="input-group reviewer-field">
                                <label class="block text-xs text-gray-500 mb-1">æª¢æ ¸è¨­å®š (Actual)</label>
                                <input type="date" name="actualEndDate" class="w-full p-0.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Budget Calculation Section -->
                <div class="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <button type="button" id="calculateBudgetButton" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            ğŸ§® è¨ˆç®—é ä¼°é ç®—èŠ±è²»
                        </button>
                        <div id="calculatedResult" class="text-lg font-semibold text-purple-800 w-full text-center sm:text-left">
                            ï¼ˆé»æ“ŠæŒ‰éˆ•é€²è¡Œè¨ˆç®—ï¼‰
                        </div>
                    </div>
                    <p class="text-xs text-purple-500 mt-2">åƒ…é©ç”¨æ–¼ã€Œæ—¥é ç®—ã€é¡å‹ï¼Œå°‡è¨ˆç®— [å»£å‘Šæ´»å‹•åŸ·è¡Œè¨­å®šé ç®—é‡‘é¡ * åŸ·è¡Œè¨­å®šæŠ•æ”¾æœŸé–“å¤©æ•¸] çš„ç¸½é ä¼°èŠ±è²»ã€‚</p>
                </div>
            </div>

            <!-- ç°½æ ¸å€å¡Š -->
            <div class="p-6 sm:p-8 bg-gray-50 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">é›™ç°½èˆ‡çµæœ</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- åŸ·è¡Œäººç°½å -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-indigo-300">
                        <label class="font-bold text-indigo-600 mb-2">åŸ·è¡Œäºº (Executor) ç°½æ ¸ <span class="text-red-500">*</span></label>
                        <p class="text-sm text-gray-500 mb-2">è¨­å®šé ç®—çš„ç¬¬ä¸€è²¬ä»»äººã€‚</p>
                        <input type="text" name="executor" id="executorInput" placeholder="è«‹è¼¸å…¥å§“å/å·¥è™Ÿç¢ºèª" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-indigo-500" required>
                        <div class="mt-3 text-xs text-gray-400">
                            åŸ·è¡Œäººæœ€å¾Œæ›´æ–°: <span id="executorTimeDisplay" class="font-medium text-gray-700">N/A</span>
                        </div>
                    </div>
                    
                    <!-- æ ¸å°äººç°½å -->
                    <div class="flex flex-col p-4 bg-white rounded-lg shadow-md border-t-4 border-green-500">
                        <label class="font-bold text-green-600 mb-2">æ ¸å°äºº (Reviewer) ç¨ç«‹ç¢ºèª</label>
                        <p class="text-sm text-gray-500 mb-2">ç¨ç«‹æ ¸å°ä¸¦ç¢ºèªè¨­å®šå€¼èˆ‡è¦æ±‚æ•¸å€¼ç›¸ç¬¦ã€‚</p>
                        <input type="text" name="reviewer" id="reviewerInput" placeholder="é¸å¡«ï¼šè«‹è¼¸å…¥å§“å/å·¥è™Ÿç¢ºèª" class="p-2 border-b border-gray-300 bg-gray-50 focus:border-green-500">
                        <div class="mt-3 text-xs text-gray-400">
                            æ ¸å°äººæœ€å¾Œæ›´æ–°: <span id="reviewerTimeDisplay" class="font-medium text-gray-700">N/A</span>
                        </div>
                    </div>
                </div>
                
                <!-- çµæœæ¬„ä½ -->
                <div class="mt-6 p-4 bg-white rounded-lg shadow-md reviewer-field">
                    <label class="font-bold text-gray-800 mb-2 block">æœ€çµ‚æ ¸å°çµæœ</label>
                    <select name="result" id="resultSelect" class="p-3 border border-gray-300 rounded-lg w-full text-lg font-semibold text-center focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- è«‹é¸æ“‡ --</option>
                        <option value="pass">âœ… æ ¸å°é€šé (å¯é–‹å§‹æŠ•æ”¾)</option>
                        <option value="fail">âŒ æ ¸å°ä¸é€šé (å·²æš«åœ/éœ€ä¿®æ­£)</option>
                    </select>
                </div>
                
                <!-- å‚™è¨» -->
                <div class="mt-6">
                    <label for="notes" class="font-bold text-gray-800 mb-2 block">å‚™è¨»/ä¿®æ­£èªªæ˜</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="è«‹å¡«å¯«ä»»ä½•ç‰¹æ®Šæƒ…æ³æˆ–ä¿®æ­£éç¨‹ã€‚" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- å‹•ä½œæŒ‰éˆ• -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button type="submit" id="saveButton" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg disabled:bg-gray-400" disabled>
                        ğŸ’¾ å„²å­˜ (è«‹å…ˆç™»å…¥)
                    </button>
                    <button type="button" id="newRecordButton" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg" disabled>
                        â• æ–°å¢ä¸€ç­†æ–°è³‡æ–™
                    </button>
                    <button type="button" id="exportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg" disabled>
                        â¬‡ï¸ åŒ¯å‡º Excel/CSV è¡¨å–®
                    </button>
                </div>

                <!-- ç‹€æ…‹è¨Šæ¯ -->
                <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center text-sm font-medium hidden"></div>

            </div>
        </form>
        
        <!-- æ­·å²è¨˜éŒ„å€å¡Š -->
        <div id="historySection" class="p-6 sm:p-8 bg-gray-100 border-t border-gray-300 mt-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">æ­·å²æ ¸å°è¨˜éŒ„</h2>
			<div id="filter-container" class="mb-6 flex flex-wrap gap-4 items-end p-4 border border-gray-200 rounded-xl bg-gray-50">
        <div class="flex flex-col w-full sm:w-auto">
            <label for="filter-executor" class="text-sm font-medium text-gray-700 mb-1">åŸ·è¡Œè€…ç¯©é¸</label>
            <select id="filter-executor" onchange="handleFilterChange(event)" data-filter-key="executor" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-white min-w-[150px]">
                <option value="all">æ‰€æœ‰åŸ·è¡Œè€…</option>
            </select>
        </div>
        
        <div class="flex flex-col w-full sm:w-auto">
            <label for="filter-reviewer" class="text-sm font-medium text-gray-700 mb-1">æª¢æ ¸è€…ç¯©é¸</label>
            <select id="filter-reviewer" onchange="handleFilterChange(event)" data-filter-key="reviewer" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-white min-w-[150px]">
                <option value="all">æ‰€æœ‰æª¢æ ¸è€…</option>
            </select>
        </div>
        
        <div class="flex flex-col w-full sm:w-auto">
            <label for="filter-result" class="text-sm font-medium text-gray-700 mb-1">ç°½æ ¸çµæœç¯©é¸</label>
            <select id="filter-result" onchange="handleFilterChange(event)" data-filter-key="result" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-white min-w-[150px]">
                <option value="all">æ‰€æœ‰çµæœ</option>
                <option value="å¾…åŸ·è¡Œ">å¾…åŸ·è¡Œ</option>
                <option value="pass">é€šé</option>
                <option value="fail">ä¸é€šé</option>
            </select>
        </div>

        <button onclick="clearFilters()" class="w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">
            æ¸…é™¤ç¯©é¸
        </button>
    </div>
            <div id="historyTableContainer" class="overflow-x-auto">
                <p class="text-gray-500 p-4 text-center">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹å…±äº«æ­·å²è¨˜éŒ„...</p>
            </div>
            <div id="historyStatus" class="mt-4 text-sm font-medium text-center text-gray-600"></div>
        </div>
        <!-- åº•éƒ¨æç¤º -->
        <footer class="p-6 sm:p-8 bg-gray-800 text-white text-center text-sm">
            <p>ğŸ’¡ æç¤ºï¼šåœ¨æ¯æ¬¡è¨­å®šæˆ–èª¿æ•´é ç®—å¾Œï¼Œéƒ½å¿…é ˆåŸ·è¡Œæ­¤é›™ç°½æµç¨‹ã€‚</p>
        </footer>

    </div>
	
<div id="detailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        
        <div class="flex justify-between items-center pb-3">
            <div id="modalHeader"></div>
            <button onclick="closeDetailModal()" class="text-black text-xl leading-none hover:text-gray-700 transition duration-150">
                &times;
            </button>
        </div>

        <div id="detailModalContent" class="mt-2 max-h-[70vh] overflow-y-auto p-4 border rounded-lg bg-gray-50">
            </div>

        <div class="mt-4 flex justify-end">
            <button onclick="closeDetailModal()" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                é—œé–‰
            </button>
        </div>
        
    </div>
</div>
    <!-- ç®¡ç†å“¡å¾Œå° Modal -->
    <div id="adminPanel" class="hidden">
        <div class="admin-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ç®¡ç†å“¡å¾Œå° - æå‡æ¬Šé™</h3>
            <p class="text-sm text-gray-600 mb-4">åªæœ‰ç®¡ç†å“¡ (${lsiaobai@gmail.com}) å¯ä»¥çœ‹åˆ°æ­¤é¢æ¿ä¸¦è¨­ç½®å…¶ä»–ç”¨æˆ¶ç‚ºç®¡ç†è€…ã€‚</p>
            
            <div id="userListContainer" class="max-h-80 overflow-y-auto border p-3 rounded-lg bg-gray-50">
                <p class="text-center text-gray-500">è¼‰å…¥ç”¨æˆ¶ä¸­...</p>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="closeAdminPanel()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- éæ¨¡çµ„è…³æœ¬å€å¡Š (ç´”ç²¹çš„ UI è¼”åŠ©åŠŸèƒ½) ---
        
        // Function to calculate the number of days between two dates (inclusive)
        function calculateDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) return 0;

            const diffTime = Math.abs(end.getTime() - start.getTime());
            
            // Convert to days (add 1 for inclusive count)
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return diffDays;
        }

        // Function to handle the budget calculation
        function calculateEstimatedBudget() {
            const form = document.getElementById('checklistForm');
            const budgetType = form.elements['adBudgetType'].value;
            // ä½¿ç”¨åŸ·è¡Œè¨­å®šçš„é‡‘é¡ (targetAmount)
            const dailyBudget = parseFloat(form.elements['targetAmount'].value); 
            // ä½¿ç”¨åŸ·è¡Œè¨­å®šçš„æ—¥æœŸ (targetStartDate/targetEndDate)
            const startDate = form.elements['targetStartDate'].value;
            const endDate = form.elements['targetEndDate'].value;
            const resultEl = document.getElementById('calculatedResult');

            resultEl.className = 'text-lg font-semibold w-full text-center sm:text-left'; // Reset classes
            resultEl.classList.remove('text-red-600', 'text-green-700');

            if (budgetType !== 'æ—¥é ç®— (Daily Budget)') {
                resultEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼šè«‹é¸æ“‡ã€Œæ—¥é ç®—ã€é¡å‹é€²è¡Œè¨ˆç®—ã€‚';
                resultEl.classList.add('text-red-600');
                return;
            }

            if (isNaN(dailyBudget) || dailyBudget <= 0) {
                resultEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼šè«‹è¼¸å…¥æœ‰æ•ˆçš„ã€Œå»£å‘Šæ´»å‹•é ç®—é‡‘é¡ (åŸ·è¡Œè¨­å®š)ã€ã€‚';
                resultEl.classList.add('text-red-600');
                return;
            }

            const days = calculateDays(startDate, endDate);

            if (days <= 0) {
                resultEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼šè«‹é¸æ“‡æœ‰æ•ˆçš„ã€ŒæŠ•æ”¾æœŸé–“ã€åŸ·è¡Œè¨­å®šæ—¥æœŸç¯„åœ (é–‹å§‹æ—¥éœ€æ—©æ–¼æˆ–ç­‰æ–¼çµæŸæ—¥)ã€‚';
                resultEl.classList.add('text-red-600');
                return;
            }

            const estimatedTotal = dailyBudget * days;
            
            const formattedTotal = estimatedTotal.toLocaleString('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });

            resultEl.textContent = `é ä¼°ç¸½èŠ±è²»ï¼ˆå…± ${days} å¤©ï¼‰ï¼š${formattedTotal}`;
            resultEl.classList.add('text-green-700');
        }

        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('calculateBudgetButton').addEventListener('click', calculateEstimatedBudget);
        });

        // ç‚ºäº†è®“ Modal å¯ä»¥å¾ HTML å…§è¯èª¿ç”¨
        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

    </script>
    
    <!-- FIREBASE æ ¸å¿ƒåŠŸèƒ½ (é©—è­‰, å„²å­˜, æ¬Šé™æ§ç®¡) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            serverTimestamp,
            doc,
            setDoc,
            deleteDoc,
            getDocs,
            setLogLevel,
            query,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è¨­å®š Firebase Debug Log
        setLogLevel('Debug');

        // --- FIREBASE CONFIGURATION ---
        // è«‹æ³¨æ„ï¼šé€™è£¡çš„é…ç½®æ‡‰ä¾†è‡ªæ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®š
        const userFirebaseConfig = {
            apiKey: "AIzaSyB7GaY2z3mKeD3bd9r_KVcd_VYMzz42c7c", 
            authDomain: "budgetcheck-7a2e9.firebaseapp.com",
            projectId: "budgetcheck-7a2e9",
            storageBucket: "budgetcheck-7a2e9.firebasestorage.app", 
            messagingSenderId: "1084663157523", 
            appId: "1:1084663157523:web:4e8160c5c3da30f92380e6", 
            measurementId: "G-81VM0XN7VC" 
        };
        // --- END CONFIGURATION ---

        // Global Firebase variables: å„ªå…ˆä½¿ç”¨ Canvas æä¾›çš„è¨­å®šï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨è‡ªå®šç¾©è¨­å®š
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        
        const configToUse = canvasFirebaseConfig || userFirebaseConfig;
        const finalAppId = canvasAppId || userFirebaseConfig.projectId || 'default-external-app-id';
        
        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
        let app, db, auth;
        let currentUser = null; // Firebase User Object
        let userId = null;
        let userEmail = null;
        let isAdmin = false;
		let userRole = 'user';
        let checklistData = []; 
        let editingId = null; 
        let editMode = 'new'; // 'new', 'edit_executor', 'edit_reviewer'
		let currentFilters = {
    executor: 'all',
    reviewer: 'all',
    result: 'all'
};
        // --- Firestore è·¯å¾‘ ---
        const CHECKLIST_COLLECTION_PATH = `/artifacts/${finalAppId}/public/data/budget_checklists`;
        const USER_ROLES_COLLECTION_PATH = `/artifacts/${finalAppId}/public/data/user_roles`;
        
        // --- ç®¡ç†è€…ç¡¬ç·¨ç¢¼éƒµç®± (é è¨­ç®¡ç†è€…) ---
        // ç¢ºä¿ä½¿ç”¨å°å¯«é€²è¡Œç©©å®šçš„æ¯”è¼ƒ
        const DEFAULT_ADMIN_EMAIL = "lsiaobai@gmail.com".toLowerCase(); 

        // --- æ¬„ä½åˆ†é¡ ---
        const executorFields = [
            'clientName', 'date', 'platform', 'verificationType', 'accountNameId',
            'targetOriginalAccountBudget', 'targetAccountBudgetAfterTopUp', 
            'adBudgetType', 'targetAmount', 'targetStartDate', 'targetEndDate',
            'executor', 'notes'
        ];
        const reviewerFields = [
            'actualOriginalAccountBudget', 'actualAccountBudgetAfterTopUp', 
            'actualSet', 'actualStartDate', 'actualEndDate',
            'reviewer', 'result'
        ];

        // Utility function to show status messages
        function showStatus(message, type = 'info', targetId = 'statusMessage') {
            const status = document.getElementById(targetId);
            status.textContent = message;
            status.className = 'mt-4 p-3 rounded-lg text-center text-sm font-medium';
            status.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'text-gray-600');

            if (type === 'error') {
                status.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                status.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'info') {
                 status.classList.add('bg-blue-100', 'text-blue-700');
            } else {
                status.classList.add('text-gray-600');
            }
        }
        
        // --- é©—è­‰èˆ‡æ¬Šé™æ ¸å¿ƒé‚è¼¯ ---
// ã€æœ€çµ‚ä¿®æ­£ 1: æ›¿æ› handleFilterChange å‡½æ•¸å®£å‘Šã€‘
// ç¢ºä¿å®ƒè¢«è¨»å†Šåˆ° windowï¼Œä»¥ä¾¿å…§è¯ HTML å‘¼å«
window.handleFilterChange = function(event) {
    const key = event.target.getAttribute('data-filter-key');
    const value = event.target.value;
    
    // æª¢æŸ¥ currentFilters æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡åˆå§‹åŒ–
    if (!window.currentFilters) {
        window.currentFilters = { executor: 'all', reviewer: 'all', result: 'all' };
    }
	
    currentFilters[key] = value;
    
    // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼Œæ‡‰ç”¨æ–°çš„ç¯©é¸æ¢ä»¶
    displayChecklistHistory(); 
}

// ã€æ–°å¢ï¼šæ¸…é™¤æ‰€æœ‰ç¯©é¸å™¨çš„å‡½æ•¸ã€‘
window.clearFilters = function() {
    currentFilters = {
        executor: 'all',
        reviewer: 'all',
        result: 'all'
    };
    
    // é‡è¨­ HTML é¸æ“‡å™¨çš„å€¼
    // å¿…é ˆç”¨ window.document.getElementById ç¢ºä¿å­˜å–
    const executorEl = document.getElementById('filter-executor');
    const reviewerEl = document.getElementById('filter-reviewer');
    const resultEl = document.getElementById('filter-result');
    
    if (executorEl) executorEl.value = 'all';
    if (reviewerEl) reviewerEl.value = 'all';
    if (resultEl) resultEl.value = 'all';
	
    // é‡æ–°æ¸²æŸ“è¡¨æ ¼ (å®ƒæœƒæ‡‰ç”¨ currentFilters)
    displayChecklistHistory(); 
}

// ã€æ–°å¢ï¼šå¡«å……ç¯©é¸å™¨é¸é …çš„å‡½æ•¸ã€‘
window.populateFilterOptions = function() {
    // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    const executorSelect = document.getElementById('filter-executor');
    const reviewerSelect = document.getElementById('filter-reviewer');
    if (!executorSelect || !reviewerSelect) return; 

    // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„åŸ·è¡Œè€… Email å’Œæª¢æ ¸è€… Name
    // å¿…é ˆä½¿ç”¨ Set ç¢ºä¿å”¯ä¸€æ€§
    const uniqueExecutors = new Set(checklistData.map(item => item.creatorEmail).filter(e => e));
    const uniqueReviewers = new Set(checklistData.map(item => item.reviewer).filter(r => r));

    // æ¸…ç©ºèˆŠé¸é … (ä¿ç•™ 'æ‰€æœ‰...' é¸é …)
    executorSelect.innerHTML = '<option value="all">æ‰€æœ‰åŸ·è¡Œè€…</option>';
    reviewerSelect.innerHTML = '<option value="all">æ‰€æœ‰æª¢æ ¸è€…</option>';

    // å¡«å……åŸ·è¡Œè€…é¸é …
    uniqueExecutors.forEach(email => {
        // ä½¿ç”¨ email ä½œç‚º value å’Œé¡¯ç¤ºæ–‡æœ¬
        executorSelect.innerHTML += `<option value="${email}">${email}</option>`;
    });

    // å¡«å……æª¢æ ¸è€…é¸é …
    uniqueReviewers.forEach(name => {
        // ä½¿ç”¨ reviewer name ä½œç‚º value å’Œé¡¯ç¤ºæ–‡æœ¬
        reviewerSelect.innerHTML += `<option value="${name}">${name}</option>`;
    });
    
    // é‡è¨­ç¯©é¸å™¨ç‚ºç•¶å‰å€¼
    if (window.currentFilters) {
        executorSelect.value = currentFilters.executor;
        reviewerSelect.value = currentFilters.reviewer;
        document.getElementById('filter-result').value = currentFilters.result;
    }
}
        async function googleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged æœƒè™•ç†å¾ŒçºŒçš„ UI æ›´æ–°å’Œè³‡æ–™è¼‰å…¥
            } catch (error) {
                console.error("Google Sign-In Failed:", error);
                let errorMessage = `âŒ Google ç™»å…¥å¤±æ•—: ${error.message}`;
                if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = `âŒ Google ç™»å…¥å¤±æ•—: Firebase: Error (${error.code})ã€‚è«‹è‡³æ‚¨çš„ Firebase Console -> Authentication -> Settings -> Authorized domainsï¼Œå°‡æ­¤æ‡‰ç”¨ç¨‹å¼çš„é‹è¡Œç¶²åŸŸåŠ å…¥ç™½åå–®ã€‚`;
                }
                showStatus(errorMessage, 'error', 'authStatus');
            }
        }

        async function googleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out Failed:", error);
            }
        }

        /**
         * æª¢æŸ¥ç”¨æˆ¶è§’è‰²ä¸¦å„²å­˜/æ›´æ–°åˆ° Firestore
         */
        async function checkUserRole(user) {
            if (!db || !user) {
                isAdmin = false;
                return;
            }
            
            const roleDocRef = doc(db, USER_ROLES_COLLECTION_PATH, user.uid);
            
            // ç¢ºä¿ email å­˜åœ¨ä¸¦è½‰æ›ç‚ºå°å¯«ï¼Œä»¥é€²è¡Œç©©å®šçš„æ¯”è¼ƒ
            const lowerCaseEmail = user.email ? user.email.toLowerCase() : '';
            
            try {
// å˜—è©¦å¾ Firestore ç²å–è§’è‰²è³‡è¨Š
			const roleSnapshot = await getDocs(query(collection(db, USER_ROLES_COLLECTION_PATH)));
			let foundRoleData = roleSnapshot.docs.find(d => d.id === user.uid)?.data(); // è®Šæ•¸åç¨±ä¿®æ­£

			if (lowerCaseEmail === DEFAULT_ADMIN_EMAIL) {
   			 // 1. æª¢æŸ¥æ˜¯å¦ç‚ºé è¨­ç®¡ç†è€… (ç¡¬ç·¨ç¢¼)
    			isAdmin = true;
   				 userRole = 'admin'; // ğŸš¨ ä¿®æ­£ï¼šè¨­å®š userRole
  			 // ... (å…¶ä»– setDoc é‚è¼¯ä¿æŒä¸è®Š)

				} else if (foundRoleData) {
  				  // 2. æª¢æŸ¥æ˜¯å¦æœ‰å·²è¨­å®šçš„è§’è‰²
   				 isAdmin = foundRoleData.role === 'admin';
				userRole = foundRoleData.role; // ğŸš¨ ä¿®æ­£ï¼šå¾ Firestore è§’è‰²è³‡è¨Šè¨­å®š userRole
  				  // ... (å…¶ä»– setDoc é‚è¼¯ä¿æŒä¸è®Š)

} else {
    // 3. é è¨­ç‚ºä¸€èˆ¬ä½¿ç”¨è€… (ä¸¦è¨˜éŒ„)
    isAdmin = false;
    userRole = 'user'; // ğŸš¨ ä¿®æ­£ï¼šè¨­å®š userRole
    // ... (å…¶ä»– setDoc é‚è¼¯ä¿æŒä¸è®Š)
}

	console.log(`User ${user.email} role: ${userRole} (Admin: ${isAdmin})`); // ä¿®æ­£ console è¼¸å‡º
            } catch (e) {
                console.error("Error checking user role:", e);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œè‡³å°‘æª¢æŸ¥æ˜¯å¦ç‚ºç¡¬ç·¨ç¢¼ç®¡ç†è€…
                isAdmin = (lowerCaseEmail === DEFAULT_ADMIN_EMAIL); 
            }
        }

        /**
         * è™•ç†èº«ä»½é©—è­‰ç‹€æ…‹æ”¹è®Š
         */
        function handleAuthStateChange(user) {
            const authButton = document.getElementById('authButton');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const adminPanelButton = document.getElementById('adminPanelButton');
            
            currentUser = user;
            
            if (user) {
                userId = user.uid;
                // ä¿®æ­£ user.email å¯èƒ½ç‚º null çš„å•é¡Œï¼Œä¸¦ç¢ºä¿ç”¨æ–¼é¡¯ç¤º
                userEmail = user.email || 'æœªæä¾› Email'; 
                
                // æ¸…é™¤ç™»å…¥éŒ¯èª¤æç¤º
                showStatus('', 'info', 'authStatus');

                document.getElementById('loadingIndicator').classList.remove('hidden');

                // æª¢æŸ¥è§’è‰²
                checkUserRole(user).then(() => {
                    // æ›´æ–° UI ç‹€æ…‹
                    authButton.textContent = 'ç™»å‡º';
                    authButton.onclick = googleSignOut;
                    
                    // ä¿®æ­£ userEmail é¡¯ç¤º null çš„å•é¡Œ
                    userEmailDisplay.innerHTML = `**${userEmail}** (${isAdmin ? 'ç®¡ç†è€…' : 'ä¸€èˆ¬ç”¨æˆ¶'})`;
                    document.getElementById('checklistForm').classList.remove('hidden');
                    
                    
                    document.querySelectorAll('#saveButton, #newRecordButton, #exportButton').forEach(btn => btn.disabled = false);

                    if (isAdmin) {
                        adminPanelButton.classList.remove('hidden');
                        adminPanelButton.onclick = openAdminPanel;
                    } else {
                         adminPanelButton.classList.add('hidden');
                    }
                    
                    loadChecklists(); // ç™»å…¥å¾Œè¼‰å…¥è³‡æ–™
                    document.getElementById('loadingIndicator').classList.add('hidden');

                }).catch(e => {
                    console.error("Role check failed:", e);
                    showStatus(`è§’è‰²æª¢æŸ¥å¤±æ•—: ${e.message}ã€‚è«‹æª¢æŸ¥ Firestore è¦å‰‡ã€‚`, 'error');
                    document.getElementById('loadingIndicator').classList.add('hidden');
                });

            } else {
                // æœªç™»å…¥ç‹€æ…‹
                userId = null;
                userEmail = null;
                isAdmin = false;
                authButton.textContent = 'ç™»å…¥ Google';
                authButton.onclick = googleSignIn;
                userEmailDisplay.innerHTML = 'è«‹ç™»å…¥ Google';
                document.getElementById('checklistForm').classList.add('hidden');
                document.getElementById('historyTableContainer').innerHTML = '<p class="text-gray-500 p-4 text-center">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹å…±äº«æ­·å²è¨˜éŒ„...</p>';
                document.querySelectorAll('#saveButton, #newRecordButton, #exportButton').forEach(btn => btn.disabled = true);
                adminPanelButton.classList.add('hidden');
                document.getElementById('loadingIndicator').classList.add('hidden');
                showStatus("æ‚¨å·²ç™»å‡ºã€‚", 'info');
            }
        }
        
        // --- è¡¨å–®æµç¨‹æ§åˆ¶ ---

        /**
         * æ ¹æ“šç•¶å‰æ¨¡å¼ (æ–°å¢/ä¿®æ”¹åŸ·è¡Œ/æª¢æ ¸) é–å®šæˆ–è§£é–æ¬„ä½
         */
        function setFormMode(mode, currentCreatorId = null) {
            editMode = mode;
            const form = document.getElementById('checklistForm');
            const saveButton = document.getElementById('saveButton');
            const isCreator = currentCreatorId === userId;
            
            // 1. åŸ·è¡Œäºº (executor) æ¬„ä½æ§åˆ¶
            form.querySelectorAll('.executor-field input, .executor-field select').forEach(el => {
                const isExecutorModifiable = (mode === 'new' || (mode === 'edit_executor' && isCreator));
                el.disabled = !isExecutorModifiable;
                // æ–°å¢è³‡æ–™æˆ–ä¿®æ”¹åŸ·è¡Œè³‡æ–™æ™‚ï¼Œå¿…å¡«æ¬„ä½æ‰éœ€è¦ required å±¬æ€§
                if (executorFields.includes(el.name) && ['clientName', 'date', 'accountNameId', 'executor'].includes(el.name)) {
                    el.required = (mode === 'new' || mode === 'edit_executor');
                }
            });

            // 2. æª¢æ ¸äºº (reviewer) æ¬„ä½æ§åˆ¶
            form.querySelectorAll('.reviewer-field input, .reviewer-field select').forEach(el => {
                const isReviewerModifiable = (mode === 'edit_reviewer' && !isCreator);
                el.disabled = !isReviewerModifiable;
                // æª¢æ ¸è³‡æ–™æ™‚ï¼Œæª¢æ ¸äººå§“åå’Œçµæœæ˜¯å¿…å¡«
                if (el.name === 'reviewer' || el.name === 'result') {
                    el.required = mode === 'edit_reviewer';
                }
            });
            
            // 3. åŸºæœ¬è³‡æ–™æ¬„ä½ (Creator only)
            // é€™äº›æ¬„ä½å¿…é ˆæ”¾åœ¨ executorFields å…§é€²è¡Œçµ±ä¸€æ§åˆ¶
            form.elements['clientName'].disabled = (mode !== 'new' && !isCreator);
            form.elements['date'].disabled = (mode !== 'new' && !isCreator);
            form.elements['platform'].disabled = (mode !== 'new' && !isCreator);
            form.elements['verificationType'].disabled = (mode !== 'new' && !isCreator);
            form.elements['accountNameId'].disabled = (mode !== 'new' && !isCreator);

            // 4. å‚™è¨»æ¬„ä½ (Notes) - å…©é‚Šéƒ½å¯ä»¥å¯«ï¼Œæ‰€ä»¥çµ±ä¸€è§£é–
            form.elements['notes'].disabled = false;
            
            // 5. æ›´æ–°æŒ‰éˆ•æ–‡å­—
            if (mode === 'new') {
                document.getElementById('formTitle').textContent = "å»£å‘Šæ´»å‹•èˆ‡é ç®—ç´°ç¯€ (æ–°å¢åŸ·è¡Œè¨­å®š)";
                saveButton.textContent = "ğŸ’¾ å„²å­˜åŸ·è¡Œè¨­å®š (å»ºç«‹æ–°ç´€éŒ„)";
                saveButton.disabled = false;
            } else if (mode === 'edit_executor') {
                document.getElementById('formTitle').textContent = `å»£å‘Šæ´»å‹•èˆ‡é ç®—ç´°ç¯€ (ä¿®æ”¹åŸ·è¡Œè¨­å®š)`;
                saveButton.textContent = "ğŸ”„ æ›´æ–°åŸ·è¡Œè¨­å®š";
                saveButton.disabled = false;
            } else if (mode === 'edit_reviewer') {
                document.getElementById('formTitle').textContent = `å»£å‘Šæ´»å‹•èˆ‡é ç®—ç´°ç¯€ (é€²è¡Œæª¢æ ¸)`;
                saveButton.textContent = "âœ… å„²å­˜æª¢æ ¸çµæœ";
                saveButton.disabled = false;
            }
        }

        // Reset the form and editing state
        function resetForm() {
            document.getElementById('checklistForm').reset();
            editingId = null;
            
            // æ¸…ç©ºæ™‚é–“æˆ³è¨˜é¡¯ç¤º
            document.getElementById('executorTimeDisplay').textContent = 'N/A';
            document.getElementById('reviewerTimeDisplay').textContent = 'N/A';
            
            setFormMode('new'); // åˆ‡æ›å›æ–°å¢æ¨¡å¼
            
            // Clear calculation result
            document.getElementById('calculatedResult').textContent = 'ï¼ˆé»æ“ŠæŒ‰éˆ•é€²è¡Œè¨ˆç®—ï¼‰'; 
            document.getElementById('calculatedResult').classList.remove('text-red-600', 'text-green-700');
            showStatus("å·²æ¸…ç©ºè¡¨å–®ï¼Œæ‚¨å¯ä»¥æ–°å¢ä¸€ç­†æ–°è³‡æ–™ã€‚", 'info');
        }

        // Function to collect form data
        function collectFormData() {
            const form = document.getElementById('checklistForm');
            
            if (!form.checkValidity()) {
                showStatus("éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ä¸¦å¡«å¯«æ‰€æœ‰æ¨™è¨»æ˜Ÿè™Ÿçš„å¿…å¡«æ¬„ä½ã€‚", 'error');
                return null;
            }
            
            let dataToSave = {};

            if (editMode === 'new') {
                // æ–°å¢æ¨¡å¼ï¼šåªæ”¶é›† Executor æ¬„ä½ + å‰µå»ºè³‡è¨Š
                dataToSave = {
                    ...executorFields.reduce((obj, key) => ({ ...obj, [key]: form.elements[key].value || '' }), {}),
                    createdByUserId: userId,
                    creatorEmail: userEmail,
                    executionTimestamp: serverTimestamp(), // å»ºç«‹æ™‚å³ç‚ºåŸ·è¡Œæ™‚é–“
                    reviewTimestamp: null, // æª¢æ ¸æ™‚é–“ç‚ºç©º
                };
            } else if (editMode === 'edit_executor') {
                // ä¿®æ”¹åŸ·è¡Œæ¨¡å¼ï¼šåªå…è¨±ä¿®æ”¹ Executor æ¬„ä½ + æ›´æ–°æ™‚é–“
                dataToSave = {
                    ...executorFields.reduce((obj, key) => ({ ...obj, [key]: form.elements[key].value || '' }), {}),
                    // notes å·²åŒ…å«åœ¨ executorFields å…§
                    executionTimestamp: serverTimestamp(), // æ›´æ–°åŸ·è¡Œæ™‚é–“
                };
            } else if (editMode === 'edit_reviewer') {
                 // ä¿®æ”¹æª¢æ ¸æ¨¡å¼ï¼šåªå…è¨±ä¿®æ”¹ Reviewer æ¬„ä½ + æ›´æ–°æ™‚é–“
                dataToSave = {
                    // å¿…é ˆåŒ…å«æ‰€æœ‰ Reviewer æ¬„ä½
                    ...reviewerFields.reduce((obj, key) => ({ ...obj, [key]: form.elements[key].value || '' }), {}),
                    notes: form.elements['notes'].value, // å‚™è¨»å¯ä¿®æ”¹
                    reviewer: form.elements['reviewer'].value, // æª¢æ ¸äººå¿…å¡«
                    result: form.elements['result'].value, // çµæœå¿…å¡«
                    reviewTimestamp: serverTimestamp(), // æ›´æ–°æª¢æ ¸æ™‚é–“
                };


	    	// ä¿®æ­£å¾Œçš„ç¨‹å¼ç¢¼ï¼šå·²ç§»é™¤å°ã€Œä¸é€šéã€çš„å„²å­˜é™åˆ¶
		        /*
                // æª¢æ ¸çµæœç‚ºã€Œä¸é€šéã€æ™‚é˜»æ­¢å„²å­˜ (å‰ç«¯æç¤º)
                if (dataToSave.result === 'fail') {
                    showStatus("éŒ¯èª¤ï¼šæ ¸å°çµæœç‚ºã€Œä¸é€šéã€ï¼Œè«‹å…ˆä¿®æ­£ä¸¦å°‡çµæœæ”¹ç‚ºã€Œé€šéã€æˆ–åœ¨å‚™è¨»èªªæ˜å¾Œå†å„²å­˜ã€‚", 'error');
                    return null;
                }
		*/
            }
            
            return dataToSave;
        }

// Save (Add or Update) to Firestore
async function saveChecklist(event) {
    event.preventDefault(); 
    if (!db || !userId) {
        showStatus("âŒ å„²å­˜å¤±æ•—: è«‹å…ˆç™»å…¥ã€‚", 'error');
        return;
    }
    
    // 1. å¾è¡¨å–®æ”¶é›†æ‰€æœ‰å¯èƒ½çš„è³‡æ–™
    const formData = collectFormData(); 
    if (!formData) return;
    
    let updateData = {}; // å®£å‘Šä¹¾æ·¨çš„æäº¤ç‰©ä»¶
    
// 2. æ ¹æ“šæ¨¡å¼ç¯©é¸ä¸¦æ§‹é€ æäº¤ç‰©ä»¶ (æœ€çµ‚éš”é›¢é‚è¼¯)
if (editMode === 'edit_reviewer') {
    // ğŸš¨ æª¢æ ¸è€…æ¨¡å¼ï¼šåªæ§‹é€ è¦å‰‡ä¸­å…è¨±çš„æ¬„ä½
    updateData = {
        // æ ¸å¿ƒç°½æ ¸æ¬„ä½ (å¿…é ˆæäº¤)
        reviewer: currentUser.displayName,
        reviewerId: userId,
        result: formData.result, // ä½¿ç”¨ formData
        reviewTimestamp: serverTimestamp(), 
    };

    // åªæœ‰åœ¨æ¬„ä½æœ‰å€¼æ™‚ï¼Œæ‰å°‡å…¶åŠ å…¥ updateData
    // ä¿®æ­£ï¼šå°‡ rawFormData çµ±ä¸€æ›¿æ›ç‚º formData
    if (formData.reviewNotes !== undefined && formData.reviewNotes !== null) { 
        // ç§»é™¤å‰å¾Œç©ºç™½ï¼Œå¦‚æœå…§å®¹éç©ºï¼Œå‰‡è³¦å€¼
        const trimmedNotes = String(formData.reviewNotes).trim();
        if (trimmedNotes.length > 0) {
            updateData.reviewNotes = trimmedNotes;
        }
    }
    
    // é€™è£¡å·²ç¶“æ˜¯æ­£ç¢ºçš„ formData
    if (formData.actualOriginalAccountBudget) { updateData.actualOriginalAccountBudget = Number(formData.actualOriginalAccountBudget); }
    if (formData.actualAccountBudgetAfterTopUp) { updateData.actualAccountBudgetAfterTopUp = Number(formData.actualAccountBudgetAfterTopUp); }
    if (formData.actualSet) { updateData.actualSet = Number(formData.actualSet); }
    if (formData.actualStartDate) { updateData.actualStartDate = formData.actualStartDate; }
    if (formData.actualEndDate) { updateData.actualEndDate = formData.actualEndDate; }

    // ... (å¾ŒçºŒçš„æ¸…ç†ç©ºå­—ä¸²é‚è¼¯)
    // é€™è£¡çš„ Object.keys(updateData).forEach é‚è¼¯å¯ä»¥ä¿ç•™ï¼Œä½†ç”±æ–¼ä¸Šé¢å·²ç¶“æª¢æŸ¥äº† trimmedNotes.length > 0ï¼Œæ‰€ä»¥å®ƒä¸æœƒåˆªé™¤ reviewNotesã€‚
    
    Object.keys(updateData).forEach(key => {
        if (updateData[key] === '') { 
            delete updateData[key];
        }
    });
}

    } else if (editMode === 'edit_executor') {
        // åŸ·è¡Œè€…æ¨¡å¼ï¼šæ‚¨å¿…é ˆåœ¨é€™è£¡æ–°å¢ä¸€å€‹åŸ·è¡Œè€…æ¬„ä½çš„ hasOnly ç¯©é¸é‚è¼¯
        // ç‚ºäº†ä¸å½±éŸ¿æª¢æ ¸åŠŸèƒ½ï¼Œé€™è£¡æš«æ™‚ä½¿ç”¨æ‰€æœ‰è³‡æ–™
        updateData = formData; 
    } else {
        // æ–°å¢æ¨¡å¼
        updateData = formData;
    }
    
    // ğŸš¨ é€™è£¡å¿…é ˆæ”¾ç½®æ‚¨çš„ delete updateData[key] é‚è¼¯ï¼Œä»¥é˜² 'editingId' è¢«åŠ å…¥
    // ç”±æ–¼æˆ‘å€‘åœ¨ä¸Šé¢å·²æ‰‹å‹•æ§‹é€  updateDataï¼Œç†è«–ä¸Šå·²éš”é›¢ï¼Œä½†ç‚ºä¿éšªèµ·è¦‹ï¼Œå†æ¬¡æ¸…ç†
    delete updateData.editingId; 
    delete updateData.id;

    const path = CHECKLIST_COLLECTION_PATH;
    
    try {
        if (editingId) {
            // æ›´æ–°
            await setDoc(doc(db, path, editingId), updateData, { merge: true }); 
            showStatus(`âœ… æ ¸å°çµæœå·²æˆåŠŸæ›´æ–° (${editMode})ã€‚`, 'success');
        } else {
            // æ–°å¢
            await addDoc(collection(db, path), updateData); 
            showStatus("âœ… åŸ·è¡Œè¨­å®šå·²æˆåŠŸå„²å­˜ä¸¦å»ºç«‹æ–°ç´€éŒ„ã€‚", 'success');
        }
        resetForm(); 
        
    } catch (e) {
        console.error("Error saving document: ", e);
        showStatus(`âŒ å„²å­˜å¤±æ•—: ${e.message}ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firestore å®‰å…¨è¦å‰‡ï¼`, 'error');
    }
}

        // Load data using onSnapshot (and re-render the history table)
        function loadChecklists() {
            if (!db || !userId) return;
            const path = CHECKLIST_COLLECTION_PATH;
            const q = collection(db, path); 

            onSnapshot(q, (snapshot) => {
                checklistData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const formatTimestamp = (ts) => ts?.toDate()?.toLocaleString('zh-TW') || 'N/A';
                    return {
                        id: doc.id,
                        ...data,
			createdByUserId: data.createdByUserId, 
            executionTimestampDisplay: formatTimestamp(data.executionTimestamp),
            reviewTimestampDisplay: formatTimestamp(data.reviewTimestamp),
                    };
                }).sort((a, b) => {
                    // å„ªå…ˆæŒ‰åŸ·è¡Œæ™‚é–“å€’åºæ’åˆ—
                    const tsA = b.executionTimestampDisplay !== 'N/A' ? new Date(b.executionTimestampDisplay) : new Date(0);
                    const tsB = a.executionTimestampDisplay !== 'N/A' ? new Date(a.executionTimestampDisplay) : new Date(0);
                    return tsA - tsB;
                }); 

                showStatus(`ğŸ’¾ å·²è¼‰å…¥ ${checklistData.length} ç­†æ­·å²æ ¸å°è¨˜éŒ„ã€‚`, 'info', 'historyStatus');
            	populateFilterOptions(); // <--- æ–°å¢æ­¤è¡Œ
Â  Â  Â  Â  Â  Â  Â  Â  displayChecklistHistory(); // <--- è«‹å°‡æ‚¨çš„ renderHistoryTable() æ›¿æ›ç‚º displayChecklistHistory()
            }, (error) => {
                console.error("Error listening to collection: ", error);
                showStatus(`âŒ è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—: ${error.message}ã€‚è«‹æª¢æŸ¥ Firestore è¦å‰‡æ˜¯å¦å…è¨±è®€å–ã€‚`, 'error', 'historyStatus');
            });
        }

        // Delete a record
        async function deleteChecklist(id) {
            if (!db || !isAdmin) {
                showStatus("âŒ åˆªé™¤å¤±æ•—: åªæœ‰ç®¡ç†è€…å¯ä»¥åˆªé™¤è³‡æ–™ã€‚", 'error', 'historyStatus');
                return;
            }
            
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) return;
            
            const path = CHECKLIST_COLLECTION_PATH;
            const docRef = doc(db, path, id);
            
            try {
                // åŸ·è¡Œåˆªé™¤æ“ä½œ
                await deleteDoc(docRef);
                showStatus("ğŸ—‘ï¸ è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ã€‚", 'success', 'historyStatus');
                // onSnapshot æœƒè‡ªå‹•æ›´æ–°åˆ—è¡¨ï¼Œç„¡éœ€æ‰‹å‹•ä¿®æ”¹ checklistData
                if (editingId === id) {
                    resetForm();
                }
            } catch (e) {
                console.error("Error deleting document: ", e);
                // æ•ç²åˆªé™¤å¤±æ•—çš„éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯æ¬Šé™ä¸è¶³ (Missing or insufficient permissions)
                showStatus(`âŒ åˆªé™¤å¤±æ•—: ${e.message}ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firestore è¦å‰‡ï¼Œç¢ºä¿ç®¡ç†è€…æœ‰ delete æ¬Šé™ã€‚`, 'error', 'historyStatus');
            }
        }

        // Start editing/reviewing a record
        function startEditOrReview(id, mode) {
            const item = checklistData.find(d => d.id === id);
            if (!item) {
                showStatus(`æ‰¾ä¸åˆ° ID ç‚º ${id} çš„è¨˜éŒ„ã€‚`, 'error');
                return;
            }
            
            const form = document.getElementById('checklistForm');
            // 1. å¡«å……è¡¨å–®
            for (const key in item) {
                if (form.elements[key]) {
                    form.elements[key].value = item[key] || '';
                }
            }
            
            // å¡«å……ç°½æ ¸æ™‚é–“
            document.getElementById('executorTimeDisplay').textContent = item.executionTimestampDisplay;
            document.getElementById('reviewerTimeDisplay').textContent = item.reviewTimestampDisplay;

            // 2. æ›´æ–°ç·¨è¼¯ç‹€æ…‹
            editingId = id;
            setFormMode(mode, item.createdByUserId);

            // 3. æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨
            document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });

            // 4. é‡è¨­è¨ˆç®—çµæœ
            document.getElementById('calculatedResult').textContent = 'ï¼ˆé»æ“ŠæŒ‰éˆ•é€²è¡Œé‡æ–°è¨ˆç®—ï¼‰'; 
            document.getElementById('calculatedResult').classList.remove('text-red-600', 'text-green-700');
        }
		
// ã€è«‹ä½¿ç”¨æ­¤å®Œæ•´çš„å‡½æ•¸ï¼Œæ›¿æ›æ‚¨æª”æ¡ˆä¸­ç¾æœ‰çš„ window.showDetailModal å‡½æ•¸ã€‘
window.showDetailModal = function(id) {
    const item = checklistData.find(d => d.id === id);
    if (!item) {
        showStatus(`âŒ æ‰¾ä¸åˆ° ID ç‚º ${id} çš„è¨˜éŒ„ç´°ç¯€ã€‚`, 'error');
        return;
    }

    const modalContent = document.getElementById('detailModalContent');
    const statusClass = item.result === 'pass' ? 'bg-green-500' : 
                        item.result === 'fail' ? 'bg-red-500' : 
                        'bg-blue-500';
    const resultText = item.result === 'pass' ? 'âœ… é€šé' : 
                       item.result === 'fail' ? 'âŒ ä¸é€šé' : 
                       'ğŸ“ å¾…åŸ·è¡Œ';
    
    // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ•¸å€¼ï¼Œå¦‚æœæ˜¯æ•¸å­—å‰‡åŠ ä¸Šåƒåˆ†ä½ç¬¦è™Ÿï¼Œå¦å‰‡é¡¯ç¤º N/A
    const formatNumber = (value) => {
        if (value === null || value === undefined || value === '') return 'N/A';
        const num = Number(value);
        return isNaN(num) ? String(value) : num.toLocaleString('en-US');
    };
    
    // å»ºç«‹è©³ç´°å…§å®¹ HTML
    modalContent.innerHTML = `
        <h3 class="text-2xl font-bold mb-4 border-b pb-2">è¨˜éŒ„ç´°ç¯€ (${item.id.substring(0, 8)})</h3>
        
        <div class="space-y-4">
            <div class="flex justify-between items-center pb-2 border-b">
                <span class="font-semibold text-gray-700">ç°½æ ¸çµæœ:</span>
                <span class="px-3 py-1 text-sm font-bold text-white rounded-full ${statusClass}">${resultText}</span>
            </div>

            <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <div><span class="font-semibold">å®¢æˆ¶åç¨±:</span> ${item.clientName || 'N/A'}</div>
                <div><span class="font-semibold">æ´»å‹•æ—¥æœŸ:</span> ${item.date || 'N/A'}</div>
                <div><span class="font-semibold">å¹³å°:</span> ${item.platform || 'N/A'}</div>
                <div><span class="font-semibold">é©—è­‰é¡å‹:</span> ${item.verificationType || 'N/A'}</div>
                <div><span class="font-semibold">å¸³æˆ¶/ID:</span> ${item.accountNameId || 'N/A'}</div>
            </div>

            <h4 class="text-lg font-bold mt-6 mb-2 pt-2 border-t">äººå“¡èˆ‡æ™‚é–“</h4>
            <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <div><span class="font-semibold">åŸ·è¡Œäºº:</span> ${item.executor} (${item.creatorEmail || 'N/A'})</div>
                <div><span class="font-semibold">åŸ·è¡Œæ™‚é–“:</span> ${item.executionTimestampDisplay || 'N/A'}</div>
                <div><span class="font-semibold">æª¢æ ¸äºº:</span> ${item.reviewer || 'N/A'}</div>
                <div><span class="font-semibold">æª¢æ ¸æ™‚é–“:</span> ${item.reviewTimestampDisplay || 'N/A'}</div>
            </div>

            <h4 class="text-lg font-bold mt-6 mb-2 pt-2 border-t text-indigo-800">å»£å‘Šæ´»å‹•èˆ‡é ç®—ç´°ç¯€</h4>
            <div class="border border-gray-200 rounded-lg p-3 bg-white space-y-3">

                <div class="border-b pb-2">
                    <span class="font-semibold text-gray-700 block mb-1">å»£å‘Šé ç®—é¡å‹:</span>
                    <span class="px-2 py-1 bg-gray-100 rounded text-sm">${item.adBudgetType || 'N/A'}</span>
                </div>

                <div class="grid grid-cols-2 gap-3 p-2 bg-indigo-50 rounded-lg">
                    <span class="font-semibold text-indigo-700">åŸå¸³æˆ¶é ç®—:</span>
                    <div>
                        <div class="text-sm"><span class="font-semibold text-red-600">åŸ·è¡Œè¨­å®šå€¼:</span> ${formatNumber(item.targetOriginalAccountBudget)}</div>
                        <div class="text-sm"><span class="font-semibold text-green-600">æª¢æ ¸å¯¦éš›å€¼:</span> ${formatNumber(item.actualOriginalAccountBudget)}</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 p-2 bg-indigo-50 rounded-lg">
                    <span class="font-semibold text-indigo-700">åŠ å€¼å¾Œå¸³æˆ¶é ç®—:</span>
                    <div>
                        <div class="text-sm"><span class="font-semibold text-red-600">åŸ·è¡Œè¨­å®šå€¼:</span> ${formatNumber(item.targetAccountBudgetAfterTopUp)}</div>
                        <div class="text-sm"><span class="font-semibold text-green-600">æª¢æ ¸å¯¦éš›å€¼:</span> ${formatNumber(item.actualAccountBudgetAfterTopUp)}</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 p-2 bg-yellow-100 rounded-lg">
                    <span class="font-bold text-gray-700">å»£å‘Šæ´»å‹•é ç®—é‡‘é¡:</span>
                    <div>
                        <div class="text-sm"><span class="font-semibold text-red-600">åŸ·è¡Œæ•¸å€¼:</span> ${formatNumber(item.targetAmount)}</div>
                        <div class="text-sm"><span class="font-semibold text-green-600">æª¢æ ¸è¨­å®šå€¼:</span> ${formatNumber(item.actualSet)}</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-2 border-t">
                    <span class="font-semibold text-gray-700">æŠ•æ”¾æœŸé–“ (é–‹å§‹æ—¥æœŸ):</span>
                    <div>
                        <div class="text-sm"><span class="font-semibold text-red-600">åŸ·è¡Œè¨­å®šå€¼:</span> ${item.targetStartDate || 'N/A'}</div>
                        <div class="text-sm"><span class="font-semibold text-green-600">æª¢æ ¸è¨­å®šå€¼:</span> ${item.actualStartDate || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 pb-2">
                    <span class="font-semibold text-gray-700">æŠ•æ”¾æœŸé–“ (çµæŸæ—¥æœŸ):</span>
                    <div>
                        <div class="text-sm"><span class="font-semibold text-red-600">åŸ·è¡Œè¨­å®šå€¼:</span> ${item.targetEndDate || 'N/A'}</div>
                        <div class="text-sm"><span class="font-semibold text-green-600">æª¢æ ¸è¨­å®šå€¼:</span> ${item.actualEndDate || 'N/A'}</div>
                    </div>
                </div>

            </div>
            
            <div class="col-span-2 mt-4 p-3 bg-red-50 rounded-lg">
                <span class="font-semibold text-red-700">æª¢æ ¸æ„è¦‹/ä¿®æ­£å‚™è¨»:</span> ${item.reviewNotes || 'ç„¡'}
            </div>
            
            <h4 class="text-lg font-bold mt-6 mb-2 pt-2 border-t">ç¸½å‚™è¨» (åŸ·è¡Œäººå‚™è¨»)</h4>
            <p class="text-sm p-3 bg-yellow-50 rounded-lg whitespace-pre-wrap">${item.notes || 'ç„¡é¡å¤–å‚™è¨»ã€‚'}</p>
        </div>
    `;

    // é¡¯ç¤ºå½ˆå‡ºè¦–çª—
    document.getElementById('detailModal').classList.remove('hidden');
}

// é—œé–‰å‡½æ•¸ç„¡éœ€ä¿®æ”¹
window.closeDetailModal = function() {
    document.getElementById('detailModal').classList.add('hidden');
}
        // ã€å®Œæ•´æ›¿æ›ï¼šåŒ…å«ç¯©é¸é‚è¼¯å’Œè¡¨æ ¼æ¸²æŸ“ã€‘
function displayChecklistHistory() {
    const tableContainer = document.getElementById('historyTableContainer');
    // å¦‚æœè¡¨æ ¼å®¹å™¨ä¸å­˜åœ¨ï¼Œå‰‡çµæŸ
    if (!tableContainer) return;
    
// 1. åŸ·è¡Œç¯©é¸
// ğŸš¨ ä¿®æ­£ï¼šç§»é™¤æ‰€æœ‰éš±æ€§ç¯©é¸ï¼Œåªä¿ç•™ä½¿ç”¨è€…åœ¨ UI ä¸Šè¨­å®šçš„ç¯©é¸å™¨
const filteredData = checklistData.filter(item => {
    // æª¢æŸ¥è‡ªå®šç¾©ç¯©é¸å™¨
    const executorMatch = currentFilters.executor === 'all' || item.creatorEmail === currentFilters.executor;
    const reviewerMatch = currentFilters.reviewer === 'all' || item.reviewer === currentFilters.reviewer;
    const resultMatch = currentFilters.result === 'all' || item.result === currentFilters.result;

    // åªè¦é€šéä½¿ç”¨è€…è¨­ç½®çš„ç¯©é¸å™¨å³å¯é¡¯ç¤º (å°æ‰€æœ‰è§’è‰²ä¸€è¦–åŒä»)
    return executorMatch && reviewerMatch && resultMatch;
});
    
    // å¦‚æœç¯©é¸çµæœç‚ºç©º
    if (filteredData.length === 0) {
        tableContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è¨˜éŒ„ã€‚</p>';
        return;
    }
    
    // 2. æº–å‚™è¡¨æ ¼ HTML
    let tableHtml = `
        <table class="checklist-table w-full border-collapse rounded-xl overflow-hidden shadow-lg">
            <thead>
                <tr>
                    <th class="w-[5%]">ID</th>
                    <th class="w-[10%]">å»ºç«‹æ—¥æœŸ</th>
                    <th class="w-[15%]">å®¢æˆ¶åç¨±</th>
                    <th class="w-[15%]">åŸ·è¡Œäºº (Creator)</th>
                    <th class="w-[15%]">æ ¸å°äºº (Reviewer)</th>
                    <th class="w-[10%]">çµæœ</th>
                    <th class="w-[20%]">å‹•ä½œ</th>
                    <th class="w-[10%]">ç´°ç¯€</th>
                </tr>
            </thead>
            <tbody id="checklist-table-body">
    `;

// ã€index.txt (JavaScriptéƒ¨åˆ†) - æ‰¾åˆ° displayChecklistHistory å‡½æ•¸ä¸¦æ›¿æ›æ­¤å€å¡Šã€‘

// 3. è¿´åœˆæ¸²æŸ“ç¯©é¸å¾Œçš„æ•¸æ“š
filteredData.forEach(item => {
// åˆ¤æ–·æ˜¯å¦ç‚ºè¨˜éŒ„çš„å»ºç«‹è€…
    const isCreator = item.createdByUserId === userId;
    
    // å®šç¾©ç‹€æ…‹ class å’Œæ–‡å­—
    const statusClass = item.result === 'pass' ? 'bg-green-100 text-green-700' : 
                        item.result === 'fail' ? 'bg-red-100 text-red-700' : 
                        'bg-blue-100 text-blue-700';
    const resultText = item.result === 'pass' ? 'âœ… é€šé' : 
                       item.result === 'fail' ? 'âŒ ä¸é€šé' : 
                       'ğŸ“ å¾…åŸ·è¡Œ';
    
    let actionButton = ''; // åˆå§‹åŒ–ç‚ºç©º
    
    // --- å‹•ä½œæŒ‰éˆ•é‚è¼¯ ---
    // ç®¡ç†è€…å°ˆå±¬çš„åˆªé™¤æŒ‰éˆ•
    const deleteBtn = isAdmin ? `
        <button onclick="deleteChecklist('${item.id}')" 
            class="bg-red-500 hover:bg-red-600 text-white text-xs font-medium py-1 px-3 rounded-full transition duration-150 ml-2">åˆªé™¤</button>
    ` : '';

    if (item.result === 'å¾…åŸ·è¡Œ' || !item.result) { 
        // ç‹€æ…‹ç‚º 'å¾…åŸ·è¡Œ' æˆ–å°šæœªæœ‰çµæœ
        if (isCreator) { 
            // è¦å‰‡ 1: åŸ·è¡Œäºº (Creator) ç·¨è¼¯è‡ªå·±çš„å¾…åŸ·è¡Œè¨˜éŒ„
            actionButton = `
                <button onclick="startEditOrReview('${item.id}', 'edit_executor')" 
                    class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-medium py-1 px-3 rounded-full transition duration-150 mr-2">ç·¨è¼¯</button>
                ${deleteBtn}
            `;
        } else if (!isCreator) { 
            // è¦å‰‡ 2: éåŸ·è¡Œäºº (Non-Creator) å¯ä»¥é€²è¡Œæª¢æ ¸
            actionButton = `
                <button onclick="startEditOrReview('${item.id}', 'edit_reviewer')" 
                    class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium py-1 px-3 rounded-full transition duration-150">
                    âœï¸ é€²è¡Œæª¢æ ¸
                </button>
                ${deleteBtn}
            `;
        } else { 
            // Fallback (æ‡‰è©²ä¸æœƒè§¸ç™¼)
            actionButton = `<span class="text-xs text-gray-500">å¾…ç°½æ ¸</span> ${deleteBtn}`; 
        } 
    } else { 
        // ç‹€æ…‹ç‚º 'pass' æˆ– 'fail' (å·²å®Œæˆ)
        if (!isCreator) {
            // è¦å‰‡ 2: éåŸ·è¡Œäºº (Non-Creator) å¯ä»¥ä¿®æ­£å·²å®Œæˆçš„æª¢æ ¸çµæœ
             actionButton = `
                <button onclick="startEditOrReview('${item.id}', 'edit_reviewer')" 
                    class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-medium py-1 px-3 rounded-full transition duration-150">
                    ğŸ”„ ä¿®æ­£æª¢æ ¸
                </button>
                ${deleteBtn}
            `;
        } else {
            // è¦å‰‡ 1: åŸ·è¡Œäºº (Creator) åªèƒ½çœ‹å·²ç°½æ ¸
             actionButton = `<span class="text-xs text-gray-500">å·²ç°½æ ¸</span> ${deleteBtn}`; 
        }
    }

    // ğŸš¨ é€™æ˜¯é¿å…è¡¨æ ¼å›  actionButton ç¨‹å¼ç¢¼éŒ¯èª¤è€Œç©ºç™½çš„æœ€å¾Œé˜²ç·šï¼Œè«‹ä¿ç•™
    if (actionButton.trim() === '') {
        actionButton = `<span class="text-xs text-gray-500">ç„¡å¯ç”¨å‹•ä½œ</span> ${deleteBtn || ''}`;
    }

// ... æ¥ä¸‹ä¾†æ˜¯ tableHtml += `...` çš„è¡¨æ ¼è¡Œçµ„è£
    
    // ... (è¡¨æ ¼è¡Œ HTML ç¨‹å¼ç¢¼ï¼šå°‡ actionButton æ”¾å…¥è¡¨æ ¼å–®å…ƒæ ¼)
    tableHtml += `
        <tr id="row-${item.id}">
            <td class="text-gray-500 text-xs">${item.id.substring(0, 4)}...</td>
			<td class="text-sm">${item.executionTimestampDisplay}</td>
			<td class="font-medium text-gray-700">${item.clientName}</td>
			<td>${item.executor} (${item.creatorEmail || 'N/A'})</td>
			<td>${item.reviewer || 'N/A'}</td>
			<td><span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">${resultText}</span></td>
			<td>${actionButton}</td>
			<td><button onclick="showDetailModal('${item.id}')" class="text-indigo-600 hover:text-indigo-800 text-xs font-medium">æŸ¥çœ‹</button></td>
		</tr>
    `;
});
// 4. çµæŸè¡¨æ ¼
tableHtml += `
            </tbody>
        </table>
    `;

// 5. å°‡ HTML å…§å®¹è¨­ç½®åˆ°å®¹å™¨
tableContainer.innerHTML = tableHtml;
} // <-- é€™æ˜¯ displayChecklistHistory å‡½æ•¸çš„çµæŸ

// --- ç®¡ç†å“¡å¾Œå°åŠŸèƒ½ --- (è¨»é‡‹å’Œä¸‹ä¸€å€‹å‡½æ•¸ä¹‹é–“ä¸æ‡‰æœ‰é¡å¤–ç¬¦è™Ÿæˆ–ä¸è¦å‰‡ç¸®æ’)

async function openAdminPanel() {
    // ... openAdminPanel çš„å…§å®¹
            if (!isAdmin) return;
            document.getElementById('adminPanel').style.display = 'flex';
            
            const userListContainer = document.getElementById('userListContainer');
            userListContainer.innerHTML = '<p class="text-center text-gray-500">è¼‰å…¥ç”¨æˆ¶ä¸­...</p>';

            try {
                // ç¢ºä¿å¾æœ€æ–°çš„æ•¸æ“šåº«ç‹€æ…‹ç²å–è§’è‰²
                const q = collection(db, USER_ROLES_COLLECTION_PATH);
                const querySnapshot = await getDocs(q);
                
                let userListHtml = '';
                querySnapshot.forEach(docSnapshot => {
                    const docId = docSnapshot.id;
                    const userData = docSnapshot.data();
                    const currentIsAdminRole = userData.role === 'admin';
                    const isCurrentUser = docId === userId;
                    const userEmail = userData.email;
                    const isDefaultAdmin = userEmail && userEmail.toLowerCase() === DEFAULT_ADMIN_EMAIL.toLowerCase();

                    // æ¬Šé™è®Šæ›´æŒ‰éˆ•
                    const toggleButtonText = currentIsAdminRole ? 'é™ç´šç‚ºä¸€èˆ¬ç”¨æˆ¶' : 'å‡ç´šç‚ºç®¡ç†è€…';
                    const toggleButtonColor = currentIsAdminRole ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
                    let toggleButtonDisabled = isCurrentUser ? 'disabled' : ''; // ç„¡æ³•ä¿®æ”¹è‡ªå·±çš„æ¬Šé™
                    if (isDefaultAdmin && currentIsAdminRole) {
                        // é è¨­ç®¡ç†è€…ç„¡æ³•è¢«é™ç´š
                        toggleButtonDisabled = 'disabled';
                    }

                    const toggleButtonClass = toggleButtonDisabled ? 'opacity-50 cursor-not-allowed' : '';
                    const userRoleText = currentIsAdminRole ? 'ç®¡ç†è€…' : 'ä¸€èˆ¬ç”¨æˆ¶';

                    // ç§»é™¤è§’è‰²è¨˜éŒ„æŒ‰éˆ• (ç§»é™¤ Firestore ä¸­çš„ user_roles è¨˜éŒ„)
                    const removeButton = !isCurrentUser && !isDefaultAdmin ? 
                        `<button onclick="window.removeUserRoleRecord('${docId}')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 text-xs font-bold py-1 px-2 rounded-lg transition duration-150 ml-2">ç§»é™¤è¨˜éŒ„</button>` 
                        : '';

                    userListHtml += `
                        <div class="flex items-center justify-between p-3 border-b">
                            <div>
                                <p class="font-medium text-gray-900 break-all">${userData.email} 
                                    ${isDefaultAdmin ? '<span class="text-xs text-yellow-600">(é è¨­ç®¡ç†å“¡)</span>' : ''}
                                </p>
                                <p class="text-sm text-gray-500">ID: ${docId.substring(0, 8)}... (${userRoleText})</p>
                            </div>
                            <div class="flex items-center">
                                <button 
                                    id="roleBtn-${docId}"
                                    onclick="window.toggleUserRole('${docId}', '${currentIsAdminRole}')"
                                    class="${toggleButtonColor} text-white text-xs font-bold py-1 px-2 rounded-lg transition duration-150 ${toggleButtonClass}"
                                    ${toggleButtonDisabled}>
                                    ${isCurrentUser ? 'è‡ªå·±çš„æ¬Šé™' : toggleButtonText}
                                </button>
                                ${removeButton}
                            </div>
                        </div>
                    `;
                });

                userListContainer.innerHTML = userListHtml || '<p class="text-center text-gray-500">ç›®å‰æ²’æœ‰å…¶ä»–ç”¨æˆ¶è¨˜éŒ„ã€‚</p>';

            } catch (e) {
                userListContainer.innerHTML = `<p class="text-red-500">è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨å¤±æ•—: ${e.message}</p>`;
                console.error("Error loading user roles:", e);
            }
        }
        
        async function toggleUserRole(targetUserId, currentIsAdminString) {
            if (!isAdmin) return;
            
            const currentIsAdmin = currentIsAdminString === 'true';
            const newRole = currentIsAdmin ? 'user' : 'admin';
            const roleDocRef = doc(db, USER_ROLES_COLLECTION_PATH, targetUserId);

            try {
                // ç¢ºä¿ç„¡æ³•é™ç´šé è¨­ç®¡ç†è€…
                const targetUserData = (await getDocs(query(collection(db, USER_ROLES_COLLECTION_PATH)))).docs.find(d => d.id === targetUserId)?.data();
                const targetUserEmail = targetUserData?.email;
                if (targetUserData && targetUserEmail && targetUserEmail.toLowerCase() === DEFAULT_ADMIN_EMAIL.toLowerCase() && newRole === 'user') {
                     showStatus(`âŒ æ¬Šé™è®Šæ›´å¤±æ•—: ç„¡æ³•å°‡é è¨­ç®¡ç†å“¡é™ç´šã€‚`, 'error', 'historyStatus');
                     return;
                }

                await setDoc(roleDocRef, { role: newRole }, { merge: true });
                showStatus(`âœ… ç”¨æˆ¶ ${targetUserId.substring(0, 8)}... å·²æˆåŠŸè¨­ç½®ç‚º ${newRole === 'admin' ? 'ç®¡ç†è€…' : 'ä¸€èˆ¬ç”¨æˆ¶'}ã€‚`, 'success', 'historyStatus');
                openAdminPanel(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
            } catch (e) {
                showStatus(`âŒ æ¬Šé™è®Šæ›´å¤±æ•—: ${e.message}`, 'error', 'historyStatus');
            }
        }

    async function removeUserRoleRecord(targetUserId) {
    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
            if (!isAdmin) return;

    // 1. å–å¾—ç›®æ¨™ä½¿ç”¨è€…è³‡æ–™
            const targetUserData = (await getDocs(query(collection(db, USER_ROLES_COLLECTION_PATH)))).docs.find(d => d.id === targetUserId)?.data();
    
    // 2. å®‰å…¨åœ°å–å‡º email
            const targetUserEmail = targetUserData?.email; 

    // ç¢ºä¿ç„¡æ³•ç§»é™¤è‡ªå·±çš„è§’è‰²è¨˜éŒ„
            if (targetUserId === userId) {
                showStatus(`âŒ ç§»é™¤è¨˜éŒ„å¤±æ•—: ç„¡æ³•ç§»é™¤è‡ªå·±çš„è§’è‰²è¨˜éŒ„ã€‚`, 'error', 'historyStatus');
                return;
    }
    
    // 3. ç¢ºä¿ç„¡æ³•ç§»é™¤é è¨­ç®¡ç†è€…çš„è¨˜éŒ„ (å·²ä¿®æ­£ç‚ºå®‰å…¨æª¢æŸ¥)
            if (targetUserEmail && targetUserEmail.toLowerCase() === DEFAULT_ADMIN_EMAIL.toLowerCase()) {
                showStatus(`âŒ ç§»é™¤è¨˜éŒ„å¤±æ•—: ç„¡æ³•ç§»é™¤é è¨­ç®¡ç†å“¡çš„è§’è‰²è¨˜éŒ„ã€‚`, 'error', 'historyStatus');
                return;
    }

            if (!confirm(`ç¢ºå®šè¦ç§»é™¤ç”¨æˆ¶ ${targetUserId.substring(0, 8)}... åœ¨ Firestore ä¸­çš„è§’è‰²è¨˜éŒ„å—ï¼Ÿé€™å°‡ä½¿ä»–è®Šå›ä¸€èˆ¬ç”¨æˆ¶ã€‚`)) return;

            const roleDocRef = doc(db, USER_ROLES_COLLECTION_PATH, targetUserId);

            try {
                await deleteDoc(roleDocRef);
                showStatus(`ğŸ—‘ï¸ ç”¨æˆ¶ ${targetUserId.substring(0, 8)}... çš„è§’è‰²è¨˜éŒ„å·²ç§»é™¤ã€‚`, 'success', 'historyStatus');
                openAdminPanel(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
    }         catch (e) {
                showStatus(`âŒ ç§»é™¤è§’è‰²è¨˜éŒ„å¤±æ•—: ${e.message}`, 'error', 'historyStatus');
    }
}


        // --- å…¨åŸŸå‡½æ•¸æš´éœ² (ä¾› HTML å…§è¯èª¿ç”¨) ---
        window.startEditOrReview = startEditOrReview;
        window.deleteChecklist = deleteChecklist;
        window.resetForm = resetForm;
        window.toggleUserRole = toggleUserRole;
        window.removeUserRoleRecord = removeUserRoleRecord; // æ–°å¢ç§»é™¤åŠŸèƒ½
        window.closeAdminPanel = closeAdminPanel;
        
        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('loadingIndicator').classList.remove('hidden');

            try {
                app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                showStatus(`âŒ é€£ç·šéŒ¯èª¤: ${e.message}ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firebase é…ç½®ã€‚`, 'error', 'loadingIndicator');
                return;
            }
            
            // è¨­å®šç™»å…¥/ç™»å‡ºç›£è½å™¨
			// ã€æ–°å¢ï¼šåœ¨æ­¤è™•å‘¼å«åˆå§‹åŒ–å‡½æ•¸ï¼Œç¢ºä¿ç¯©é¸å™¨ç›£è½å™¨åœ¨é é¢è¼‰å…¥æ™‚ç¶å®šã€‘
		///	initFilterListeners(); <--- è«‹æ–°å¢æ­¤è¡Œ
            onAuthStateChanged(auth, handleAuthStateChange);
            
            // è¡¨å–®äº‹ä»¶
            document.getElementById('checklistForm').addEventListener('submit', saveChecklist);
            document.getElementById('newRecordButton').addEventListener('click', () => { window.resetForm(); });
            document.getElementById('exportButton').addEventListener('click', exportToCSV);
            
            // é¦–æ¬¡è¼‰å…¥æ™‚ï¼Œå°‡è¡¨å–®è¨­ç½®ç‚ºæ–°å¢æ¨¡å¼çš„é è¨­ç‹€æ…‹
            setFormMode('new'); 
        });
        
        // Export to CSV function (must be defined in module scope to access checklistData)
        function exportToCSV() {
            if (checklistData.length === 0) {
                showStatus("ğŸš« æ²’æœ‰å¯åŒ¯å‡ºçš„è¨˜éŒ„ã€‚", 'error');
                return;
            }

            // 1. å®šç¾© CSV æ¨™é ­ 
            const headers = [
                "å®¢æˆ¶åç¨±", "å»ºç«‹/ä¿®æ”¹æ—¥æœŸ", "å»£å‘Šå¹³å°", "æª¢æ ¸é¡å‹", "å¸³è™Ÿåç¨±/å¸³è™ŸID", // æ–°æ¬„ä½
                "åŸå¸³æˆ¶åŸ·è¡Œè¨­å®šé ç®—", "åŸå¸³æˆ¶æª¢æ ¸è¨­å®šé ç®—", "åŠ å€¼å¾ŒåŸ·è¡Œè¨­å®šé ç®—", "åŠ å€¼å¾Œæª¢æ ¸è¨­å®šé ç®—", 
                "å»£å‘Šé ç®—é¡å‹", "å»£å‘Šæ´»å‹•åŸ·è¡Œè¨­å®šé‡‘é¡", "å»£å‘Šæ´»å‹•æª¢æ ¸è¨­å®šé‡‘é¡", 
                "åŸ·è¡Œè¨­å®šé–‹å§‹æ—¥æœŸ", "åŸ·è¡Œè¨­å®šçµæŸæ—¥æœŸ", "æª¢æ ¸è¨­å®šé–‹å§‹æ—¥æœŸ", "æª¢æ ¸è¨­å®šçµæŸæ—¥æœŸ", 
                "åŸ·è¡Œäºº", "æ ¸å°äºº", "æ ¸å°çµæœ", "å‚™è¨»", 
                "æœ€å¾ŒåŸ·è¡Œæ™‚é–“", "æœ€å¾Œæª¢æ ¸æ™‚é–“", // æ–°å¢æ™‚é–“æˆ³è¨˜
                "å»ºç«‹è€…User ID", "å»ºç«‹è€…Email" // æ–°å¢å‰µå»ºè€…è³‡è¨Š
            ];
            
            // 2. Map data to header order
            const csvRows = [
                headers.join(',')
            ];

            checklistData.forEach(item => {
                const row = [
                    item.clientName, 
                    item.date, 
                    item.platform, 
                    item.verificationType, 
                    item.accountNameId, // æ–°æ¬„ä½
                    item.targetOriginalAccountBudget, 
                    item.actualOriginalAccountBudget, 
                    item.targetAccountBudgetAfterTopUp, 
                    item.actualAccountBudgetAfterTopUp, 
                    item.adBudgetType, 
                    item.targetAmount, 
                    item.actualSet, 
                    item.targetStartDate || '', 
                    item.targetEndDate || '',   
                    item.actualStartDate || '', 
                    item.actualEndDate || '',   
                    item.executor, 
                    item.reviewer, 
                    item.result, 
                    `"${item.notes ? item.notes.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                    item.executionTimestampDisplay, // åŸ·è¡Œæ™‚é–“
                    item.reviewTimestampDisplay, // æª¢æ ¸æ™‚é–“
                    item.createdByUserId || 'N/A', 
                    item.creatorEmail || 'N/A'
                ];
                csvRows.push(row.map(cell => {
                    // ç¢ºä¿é€—è™Ÿè¢«è™•ç†
                    let cellString = String(cell);
                    if (cellString.includes(',')) {
                        cellString = `"${cellString.replace(/"/g, '""')}"`;
                    }
                    return cellString;
                }).join(','));
            });

            const csvString = csvRows.join('\n');
            
            // 3. å»ºç«‹ Blob ä¸¦ä¸‹è¼‰ (åŠ å…¥ BOM è§£æ±ºä¸­æ–‡äº‚ç¢¼å•é¡Œ)
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'Budget_Checklist_Export_' + new Date().toISOString().slice(0, 10) + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus("â¬‡ï¸ æ­·å²ç´€éŒ„å·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆã€‚", 'success');
        }

    </script>
</body>
</html>



























